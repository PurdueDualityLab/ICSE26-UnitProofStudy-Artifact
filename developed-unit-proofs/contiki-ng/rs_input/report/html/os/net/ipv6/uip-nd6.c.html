
<html>
<head>
<title>os/net/ipv6/uip-nd6.c</title>
<link rel="stylesheet" type="text/css" href="../../../viewer.css">
</head>

<body>
<div class="code">
<div id="1" class="line none">    1 /*</div><div id="2" class="line none">    2  * Copyright (C) 1995, 1996, 1997, and 1998 WIDE Project.</div><div id="3" class="line none">    3  * All rights reserved.</div><div id="4" class="line none">    4  *</div><div id="5" class="line none">    5  * Redistribution and use in source and binary forms, with or without</div><div id="6" class="line none">    6  * modification, are permitted provided that the following conditions</div><div id="7" class="line none">    7  * are met:</div><div id="8" class="line none">    8  * 1. Redistributions of source code must retain the above copyright</div><div id="9" class="line none">    9  *    notice, this list of conditions and the following disclaimer.</div><div id="10" class="line none">   10  * 2. Redistributions in binary form must reproduce the above copyright</div><div id="11" class="line none">   11  *    notice, this list of conditions and the following disclaimer in the</div><div id="12" class="line none">   12  *    documentation and/or other materials provided with the distribution.</div><div id="13" class="line none">   13  * 3. Neither the name of the project nor the names of its contributors</div><div id="14" class="line none">   14  *    may be used to endorse or promote products derived from this software</div><div id="15" class="line none">   15  *    without specific prior written permission.</div><div id="16" class="line none">   16  *</div><div id="17" class="line none">   17  * THIS SOFTWARE IS PROVIDED BY THE PROJECT AND CONTRIBUTORS ``AS IS'' AND</div><div id="18" class="line none">   18  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</div><div id="19" class="line none">   19  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</div><div id="20" class="line none">   20  * ARE DISCLAIMED.  IN NO EVENT SHALL THE PROJECT OR CONTRIBUTORS BE LIABLE</div><div id="21" class="line none">   21  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</div><div id="22" class="line none">   22  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS</div><div id="23" class="line none">   23  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</div><div id="24" class="line none">   24  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</div><div id="25" class="line none">   25  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</div><div id="26" class="line none">   26  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</div><div id="27" class="line none">   27  * SUCH DAMAGE.</div><div id="28" class="line none">   28  */</div><div id="29" class="line none">   29 /*</div><div id="30" class="line none">   30  * Copyright (c) 2006, Swedish Institute of Computer Science.</div><div id="31" class="line none">   31  * All rights reserved.</div><div id="32" class="line none">   32  *</div><div id="33" class="line none">   33  * Redistribution and use in source and binary forms, with or without</div><div id="34" class="line none">   34  * modification, are permitted provided that the following conditions</div><div id="35" class="line none">   35  * are met:</div><div id="36" class="line none">   36  * 1. Redistributions of source code must retain the above copyright</div><div id="37" class="line none">   37  *   notice, this list of conditions and the following disclaimer.</div><div id="38" class="line none">   38  * 2. Redistributions in binary form must reproduce the above copyright</div><div id="39" class="line none">   39  *   notice, this list of conditions and the following disclaimer in the</div><div id="40" class="line none">   40  *   documentation and/or other materials provided with the distribution.</div><div id="41" class="line none">   41  * 3. Neither the name of the Institute nor the names of its contributors</div><div id="42" class="line none">   42  *   may be used to endorse or promote products derived from this software</div><div id="43" class="line none">   43  *   without specific prior written permission.</div><div id="44" class="line none">   44  *</div><div id="45" class="line none">   45  * THIS SOFTWARE IS PROVIDED BY THE INSTITUTE AND CONTRIBUTORS ``AS IS'' AND</div><div id="46" class="line none">   46  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</div><div id="47" class="line none">   47  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</div><div id="48" class="line none">   48  * ARE DISCLAIMED.  IN NO EVENT SHALL THE INSTITUTE OR CONTRIBUTORS BE LIABLE</div><div id="49" class="line none">   49  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</div><div id="50" class="line none">   50  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS</div><div id="51" class="line none">   51  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</div><div id="52" class="line none">   52  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</div><div id="53" class="line none">   53  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</div><div id="54" class="line none">   54  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</div><div id="55" class="line none">   55  * SUCH DAMAGE.</div><div id="56" class="line none">   56  *</div><div id="57" class="line none">   57  */</div><div id="58" class="line none">   58 </div><div id="59" class="line none">   59 /**</div><div id="60" class="line none">   60  * \addtogroup uip</div><div id="61" class="line none">   61  * @{</div><div id="62" class="line none">   62  */</div><div id="63" class="line none">   63 </div><div id="64" class="line none">   64 /**</div><div id="65" class="line none">   65  * \file</div><div id="66" class="line none">   66  *    Neighbor discovery (RFC 4861)</div><div id="67" class="line none">   67  * \author Mathilde Durvy &lt;mdurvy@cisco.com&gt;</div><div id="68" class="line none">   68  * \author Julien Abeille &lt;jabeille@cisco.com&gt;</div><div id="69" class="line none">   69  */</div><div id="70" class="line none">   70 </div><div id="71" class="line none">   71 #include &lt;string.h&gt;</div><div id="72" class="line none">   72 #include &lt;inttypes.h&gt;</div><div id="73" class="line none">   73 #include "net/ipv6/uip-icmp6.h"</div><div id="74" class="line none">   74 #include "net/ipv6/uip-nd6.h"</div><div id="75" class="line none">   75 #include "net/ipv6/uip-ds6.h"</div><div id="76" class="line none">   76 #include "net/ipv6/uip-nameserver.h"</div><div id="77" class="line none">   77 #include "lib/random.h"</div><div id="78" class="line none">   78 </div><div id="79" class="line none">   79 /* Log configuration */</div><div id="80" class="line none">   80 #include "sys/log.h"</div><div id="81" class="line none">   81 #define <a href="uip-nd6.c.html#81">LOG_MODULE</a> "IPv6 NDP"</div><div id="82" class="line none">   82 #define <a href="uip-nd6.c.html#82">LOG_LEVEL</a> <a href="../../sys/log.h.html#127">LOG_LEVEL_IPV6</a></div><div id="83" class="line none">   83 </div><div id="84" class="line none">   84 /*------------------------------------------------------------------*/</div><div id="85" class="line none">   85 /** @{ */</div><div id="86" class="line none">   86 /** \name Pointers to the header structures.</div><div id="87" class="line none">   87  */</div><div id="88" class="line none">   88 </div><div id="89" class="line none">   89 /**@{  Pointers to messages just after icmp header */</div><div id="90" class="line none">   90 #define <a href="uip-nd6.c.html#90">UIP_ND6_RS_BUF</a>            ((<a href="uip-nd6.h.html#289">uip_nd6_rs</a> *)<a href="uip.h.html#78">UIP_ICMP_PAYLOAD</a>)</div><div id="91" class="line none">   91 #define <a href="uip-nd6.c.html#91">UIP_ND6_RA_BUF</a>            ((<a href="uip-nd6.h.html#298">uip_nd6_ra</a> *)<a href="uip.h.html#78">UIP_ICMP_PAYLOAD</a>)</div><div id="92" class="line none">   92 #define <a href="uip-nd6.c.html#92">UIP_ND6_NS_BUF</a>            ((<a href="uip-nd6.h.html#268">uip_nd6_ns</a> *)<a href="uip.h.html#78">UIP_ICMP_PAYLOAD</a>)</div><div id="93" class="line none">   93 #define <a href="uip-nd6.c.html#93">UIP_ND6_NA_BUF</a>            ((<a href="uip-nd6.h.html#278">uip_nd6_na</a> *)<a href="uip.h.html#78">UIP_ICMP_PAYLOAD</a>)</div><div id="94" class="line none">   94 /** @} */</div><div id="95" class="line none">   95 /** Pointer to ND option */</div><div id="96" class="line none">   96 #define <a href="uip-nd6.c.html#96">ND6_OPT</a>(opt)                         ((unsigned char *)(<a href="uip.h.html#78">UIP_ICMP_PAYLOAD</a> + (opt)))</div><div id="97" class="line none">   97 #define <a href="uip-nd6.c.html#97">ND6_OPT_HDR_BUF</a>(opt)               ((<a href="uip-nd6.h.html#324">uip_nd6_opt_hdr</a> *)<a href="uip-nd6.c.html#96">ND6_OPT</a>(opt))</div><div id="98" class="line none">   98 #define <a href="uip-nd6.c.html#98">ND6_OPT_PREFIX_BUF</a>(opt)    ((<a href="uip-nd6.h.html#330">uip_nd6_opt_prefix_info</a> *)<a href="uip-nd6.c.html#96">ND6_OPT</a>(opt))</div><div id="99" class="line none">   99 #define <a href="uip-nd6.c.html#99">ND6_OPT_MTU_BUF</a>(opt)               ((<a href="uip-nd6.h.html#342">uip_nd6_opt_mtu</a> *)<a href="uip-nd6.c.html#96">ND6_OPT</a>(opt))</div><div id="100" class="line none">  100 #define <a href="uip-nd6.c.html#100">ND6_OPT_RDNSS_BUF</a>(opt)             ((<a href="uip-nd6.h.html#350">uip_nd6_opt_dns</a> *)<a href="uip-nd6.c.html#96">ND6_OPT</a>(opt))</div><div id="101" class="line none">  101 /** @} */</div><div id="102" class="line none">  102 </div><div id="103" class="line none">  103 #if <a href="uip-nd6.h.html#90">UIP_ND6_SEND_NS</a> || <a href="uip-nd6.h.html#95">UIP_ND6_SEND_NA</a> || <a href="uip-nd6.h.html#85">UIP_ND6_SEND_RA</a> || !UIP_CONF_ROUTER</div><div id="104" class="line none">  104 static uint16_t <a href="uip-nd6.c.html#104">nd6_opt_offset</a>; /** Offset from the end of the icmpv6 header to the option in uip_buf*/</div><div id="105" class="line none">  105 static uint8_t *<a href="uip-nd6.c.html#105">nd6_opt_llao</a>;   /**  Pointer to llao option in uip_buf */</div><div id="106" class="line none">  106 static <a href="uip-ds6-nbr.h.html#122">uip_ds6_nbr_t</a> *<a href="uip-nd6.c.html#106">nbr</a>; /**  Pointer to a nbr cache entry*/</div><div id="107" class="line none">  107 static <a href="uip-ds6.h.html#216">uip_ds6_addr_t</a> *<a href="uip-nd6.c.html#107">addr</a>; /**  Pointer to an interface address */</div><div id="108" class="line none">  108 #endif /* UIP_ND6_SEND_NS || UIP_ND6_SEND_NA || UIP_ND6_SEND_RA || !UIP_CONF_ROUTER */</div><div id="109" class="line none">  109 </div><div id="110" class="line none">  110 #if <a href="uip-nd6.h.html#90">UIP_ND6_SEND_NS</a> || <a href="uip-nd6.h.html#85">UIP_ND6_SEND_RA</a> || !UIP_CONF_ROUTER</div><div id="111" class="line none">  111 static uip_ds6_defrt_t *<a href="uip-nd6.c.html#111">defrt</a>; /**  Pointer to a router list entry */</div><div id="112" class="line none">  112 #endif /* UIP_ND6_SEND_NS || UIP_ND6_SEND_RA || !UIP_CONF_ROUTER */</div><div id="113" class="line none">  113 </div><div id="114" class="line none">  114 #if !UIP_CONF_ROUTER            // TBD see if we move it to ra_input</div><div id="115" class="line none">  115 static <a href="uip-nd6.h.html#330">uip_nd6_opt_prefix_info</a> *<a href="uip-nd6.c.html#115">nd6_opt_prefix_info</a>; /**  Pointer to prefix information option in uip_buf */</div><div id="116" class="line none">  116 static <a href="uip.h.html#105">uip_ipaddr_t</a> <a href="uip-ds6-nbr.h.html#110">ipaddr</a>;</div><div id="117" class="line none">  117 #endif</div><div id="118" class="line none">  118 #if (!UIP_CONF_ROUTER || <a href="uip-nd6.h.html#85">UIP_ND6_SEND_RA</a>)</div><div id="119" class="line none">  119 static <a href="uip-ds6.h.html#193">uip_ds6_prefix_t</a> *<a href="uip-nd6.c.html#119">prefix</a>; /**  Pointer to a prefix list entry */</div><div id="120" class="line none">  120 #endif</div><div id="121" class="line none">  121 </div><div id="122" class="line none">  122 #if <a href="uip-nd6.h.html#95">UIP_ND6_SEND_NA</a> || <a href="uip-nd6.h.html#85">UIP_ND6_SEND_RA</a> || !UIP_CONF_ROUTER</div><div id="123" class="line none">  123 /*------------------------------------------------------------------*/</div><div id="124" class="line none">  124 /* Copy link-layer address from LLAO option to a word-aligned uip_lladdr_t */</div><div id="125" class="line none">  125 static int</div><div id="126" class="line none">  126 <a href="uip-nd6.c.html#126">extract_lladdr_from_llao_aligned</a>(<a href="uip.h.html#138">uip_lladdr_t</a> *<a href="uip.h.html#1427">dest</a>)</div><div id="127" class="line none">  127 {</div><div id="128" class="line hit">  128   if(<a href="uip.h.html#1427">dest</a> != NULL &amp;&amp; <a href="uip-nd6.c.html#105">nd6_opt_llao</a> != NULL) {</div><div id="129" class="line hit">  129     memcpy(<a href="uip.h.html#1427">dest</a>, &amp;<a href="uip-nd6.c.html#105">nd6_opt_llao</a>[<a href="uip-nd6.h.html#209">UIP_ND6_OPT_DATA_OFFSET</a>], <a href="uip.h.html#145">UIP_LLADDR_LEN</a>);</div><div id="130" class="line hit">  130     return 1;</div><div id="131" class="line none">  131   }</div><div id="132" class="line missed">  132   return 0;</div><div id="133" class="line hit">  133 }</div><div id="134" class="line none">  134 #endif /* UIP_ND6_SEND_NA || UIP_ND6_SEND_RA || !UIP_CONF_ROUTER */</div><div id="135" class="line none">  135 /*------------------------------------------------------------------*/</div><div id="136" class="line none">  136 #if <a href="uip-nd6.h.html#95">UIP_ND6_SEND_NA</a> /* UIP_ND6_SEND_NA */</div><div id="137" class="line none">  137 /* create a llao */</div><div id="138" class="line none">  138 static void</div><div id="139" class="line none">  139 <a href="uip-nd6.c.html#139">create_llao</a>(uint8_t *llao, uint8_t <a href="uip-ds6.h.html#209">type</a>)</div><div id="140" class="line none">  140 {</div><div id="141" class="line none">  141   llao[<a href="uip-nd6.h.html#207">UIP_ND6_OPT_TYPE_OFFSET</a>] = <a href="uip-ds6.h.html#209">type</a>;</div><div id="142" class="line none">  142   llao[<a href="uip-nd6.h.html#208">UIP_ND6_OPT_LEN_OFFSET</a>] = <a href="uip-nd6.h.html#235">UIP_ND6_OPT_LLAO_LEN</a> &gt;&gt; 3;</div><div id="143" class="line none">  143   memcpy(&amp;llao[<a href="uip-nd6.h.html#209">UIP_ND6_OPT_DATA_OFFSET</a>], &amp;<a href="uip.h.html#1728">uip_lladdr</a>, <a href="uip.h.html#145">UIP_LLADDR_LEN</a>);</div><div id="144" class="line none">  144   /* padding on some */</div><div id="145" class="line none">  145   memset(&amp;llao[<a href="uip-nd6.h.html#209">UIP_ND6_OPT_DATA_OFFSET</a> + <a href="uip.h.html#145">UIP_LLADDR_LEN</a>], 0,</div><div id="146" class="line none">  146          <a href="uip-nd6.h.html#235">UIP_ND6_OPT_LLAO_LEN</a> - 2 - <a href="uip.h.html#145">UIP_LLADDR_LEN</a>);</div><div id="147" class="line none">  147 }</div><div id="148" class="line none">  148 #endif /* UIP_ND6_SEND_NA */</div><div id="149" class="line none">  149 /*------------------------------------------------------------------*/</div><div id="150" class="line none">  150  /**</div><div id="151" class="line none">  151  * Neighbor Solicitation Processing</div><div id="152" class="line none">  152  *</div><div id="153" class="line none">  153  * The NS can be received in 3 cases (procedures):</div><div id="154" class="line none">  154  * - sender is performing DAD (ip src = unspecified, no SLLAO option)</div><div id="155" class="line none">  155  * - sender is performing NUD (ip dst = unicast)</div><div id="156" class="line none">  156  * - sender is performing address resolution (ip dest = solicited node mcast</div><div id="157" class="line none">  157  * address)</div><div id="158" class="line none">  158  *</div><div id="159" class="line none">  159  * We do:</div><div id="160" class="line none">  160  * - if the tgt belongs to me, reply, otherwise ignore</div><div id="161" class="line none">  161  * - if i was performing DAD for the same address, two cases:</div><div id="162" class="line none">  162  * -- I already sent a NS, hence I win</div><div id="163" class="line none">  163  * -- I did not send a NS yet, hence I lose</div><div id="164" class="line none">  164  *</div><div id="165" class="line none">  165  * If we need to send a NA in response (i.e. the NS was done for NUD, or</div><div id="166" class="line none">  166  * address resolution, or DAD and there is a conflict), we do it in this</div><div id="167" class="line none">  167  * function: set src, dst, tgt address in the three cases, then for all cases</div><div id="168" class="line none">  168  * set the rest, including  SLLAO</div><div id="169" class="line none">  169  *</div><div id="170" class="line none">  170  */</div><div id="171" class="line none">  171 #if <a href="uip-nd6.h.html#95">UIP_ND6_SEND_NA</a></div><div id="172" class="line none">  172 static void</div><div id="173" class="line none">  173 <a href="uip-nd6.c.html#173">ns_input</a>(void)</div><div id="174" class="line none">  174 {</div><div id="175" class="line none">  175   uint8_t <a href="uip.h.html#1630">flags</a> = 0;</div><div id="176" class="line none">  176 </div><div id="177" class="line none">  177   <a href="../../sys/log.h.html#200">LOG_INFO</a>("Received NS from ");</div><div id="178" class="line none">  178   <a href="../../sys/log.h.html#218">LOG_INFO_6ADDR</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">srcipaddr</a>);</div><div id="179" class="line none">  179   <a href="../../sys/log.h.html#206">LOG_INFO_</a>(" to ");</div><div id="180" class="line none">  180   <a href="../../sys/log.h.html#218">LOG_INFO_6ADDR</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">destipaddr</a>);</div><div id="181" class="line none">  181   <a href="../../sys/log.h.html#206">LOG_INFO_</a>(" with target address ");</div><div id="182" class="line none">  182   <a href="../../sys/log.h.html#218">LOG_INFO_6ADDR</a>((<a href="uip.h.html#105">uip_ipaddr_t</a> *) (&amp;<a href="uip-nd6.c.html#92">UIP_ND6_NS_BUF</a>-&gt;<a href="uip-nd6.h.html#270">tgtipaddr</a>));</div><div id="183" class="line none">  183   <a href="../../sys/log.h.html#206">LOG_INFO_</a>("\n");</div><div id="184" class="line none">  184   <a href="uip.h.html#1349">UIP_STAT</a>(++uip_stat.<a href="uip.h.html#1413">nd6</a>.<a href="uip.h.html#1361">recv</a>);</div><div id="185" class="line none">  185 </div><div id="186" class="line none">  186 #if UIP_CONF_IPV6_CHECKS</div><div id="187" class="line none">  187   if((<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1313">ttl</a> != <a href="uip-nd6.h.html#55">UIP_ND6_HOP_LIMIT</a>) ||</div><div id="188" class="line none">  188      (<a href="uip.h.html#1886">uip_is_addr_mcast</a>(&amp;<a href="uip-nd6.c.html#92">UIP_ND6_NS_BUF</a>-&gt;<a href="uip-nd6.h.html#270">tgtipaddr</a>)) ||</div><div id="189" class="line none">  189      (<a href="uip.h.html#77">UIP_ICMP_BUF</a>-&gt;<a href="uip-icmp6.h.html#183">icode</a> != 0)) {</div><div id="190" class="line none">  190     <a href="../../sys/log.h.html#198">LOG_ERR</a>("NS received is bad\n");</div><div id="191" class="line none">  191     goto discard;</div><div id="192" class="line none">  192   }</div><div id="193" class="line none">  193 #endif /* UIP_CONF_IPV6_CHECKS */</div><div id="194" class="line none">  194 </div><div id="195" class="line none">  195   /* Options processing */</div><div id="196" class="line none">  196   <a href="uip-nd6.c.html#105">nd6_opt_llao</a> = NULL;</div><div id="197" class="line none">  197   <a href="uip-nd6.c.html#104">nd6_opt_offset</a> = <a href="uip-nd6.h.html#214">UIP_ND6_NS_LEN</a>;</div><div id="198" class="line none">  198   while(<a href="uip.h.html#66">uip_l3_icmp_hdr_len</a> + <a href="uip-nd6.c.html#104">nd6_opt_offset</a> + <a href="uip-nd6.h.html#222">UIP_ND6_OPT_HDR_LEN</a> &lt; <a href="../../../cbmc/proofs/net/ipv6/rs_input/rsi_harness.c.html#20">uip_len</a>) {</div><div id="199" class="line none">  199 #if UIP_CONF_IPV6_CHECKS</div><div id="200" class="line none">  200     if(<a href="uip-nd6.c.html#97">ND6_OPT_HDR_BUF</a>(<a href="uip-nd6.c.html#104">nd6_opt_offset</a>)-&gt;<a href="uip-nd6.h.html#326">len</a> == 0) {</div><div id="201" class="line none">  201       <a href="../../sys/log.h.html#198">LOG_ERR</a>("NS received is bad\n");</div><div id="202" class="line none">  202       goto discard;</div><div id="203" class="line none">  203     }</div><div id="204" class="line none">  204 #endif /* UIP_CONF_IPV6_CHECKS */</div><div id="205" class="line none">  205     switch (<a href="uip-nd6.c.html#97">ND6_OPT_HDR_BUF</a>(<a href="uip-nd6.c.html#104">nd6_opt_offset</a>)-&gt;<a href="uip-ds6.h.html#209">type</a>) {</div><div id="206" class="line none">  206     case <a href="uip-nd6.h.html#196">UIP_ND6_OPT_SLLAO</a>:</div><div id="207" class="line none">  207       if(<a href="uip.h.html#66">uip_l3_icmp_hdr_len</a> + <a href="uip-nd6.c.html#104">nd6_opt_offset</a> +</div><div id="208" class="line none">  208          <a href="uip-nd6.h.html#209">UIP_ND6_OPT_DATA_OFFSET</a> + <a href="uip.h.html#145">UIP_LLADDR_LEN</a> &gt; <a href="../../../cbmc/proofs/net/ipv6/rs_input/rsi_harness.c.html#20">uip_len</a>) {</div><div id="209" class="line none">  209         <a href="../../sys/log.h.html#198">LOG_ERR</a>("Insufficient data for NS SLLAO option\n");</div><div id="210" class="line none">  210         goto discard;</div><div id="211" class="line none">  211       }</div><div id="212" class="line none">  212       <a href="uip-nd6.c.html#105">nd6_opt_llao</a> = &amp;<a href="uip.h.html#465">uip_buf</a>[<a href="uip.h.html#66">uip_l3_icmp_hdr_len</a> + <a href="uip-nd6.c.html#104">nd6_opt_offset</a>];</div><div id="213" class="line none">  213 #if UIP_CONF_IPV6_CHECKS</div><div id="214" class="line none">  214       /* There must be NO option in a DAD NS */</div><div id="215" class="line none">  215       if(<a href="uip.h.html#1751">uip_is_addr_unspecified</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">srcipaddr</a>)) {</div><div id="216" class="line none">  216         <a href="../../sys/log.h.html#198">LOG_ERR</a>("NS received is bad\n");</div><div id="217" class="line none">  217         goto discard;</div><div id="218" class="line none">  218       } else {</div><div id="219" class="line none">  219 #endif /*UIP_CONF_IPV6_CHECKS */</div><div id="220" class="line none">  220         <a href="uip.h.html#138">uip_lladdr_t</a> lladdr_aligned;</div><div id="221" class="line none">  221         <a href="uip-nd6.c.html#126">extract_lladdr_from_llao_aligned</a>(&amp;lladdr_aligned);</div><div id="222" class="line none">  222         <a href="uip-nd6.c.html#106">nbr</a> = <a href="../../../cbmc/proofs/net/ipv6/rs_input/rsi_harness.c.html#23">uip_ds6_nbr_lookup</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">srcipaddr</a>);</div><div id="223" class="line none">  223         if(<a href="uip-nd6.c.html#106">nbr</a> == NULL) {</div><div id="224" class="line none">  224           <a href="../../../cbmc/proofs/net/ipv6/rs_input/rsi_harness.c.html#59">uip_ds6_nbr_add</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">srcipaddr</a>, &amp;lladdr_aligned,</div><div id="225" class="line none">  225                           0, <a href="uip-ds6-nbr.h.html#66">NBR_STALE</a>, <a href="../nbr-table.h.html#48">NBR_TABLE_REASON_IPV6_ND</a>, NULL);</div><div id="226" class="line none">  226         } else {</div><div id="227" class="line none">  227           const <a href="uip.h.html#138">uip_lladdr_t</a> *<a href="../nbr-table.h.html#93">lladdr</a> = <a href="../../../cbmc/proofs/net/ipv6/rs_input/rsi_harness.c.html#83">uip_ds6_nbr_get_ll</a>(<a href="uip-nd6.c.html#106">nbr</a>);</div><div id="228" class="line none">  228           if(<a href="../nbr-table.h.html#93">lladdr</a> == NULL) {</div><div id="229" class="line none">  229             goto discard;</div><div id="230" class="line none">  230           }</div><div id="231" class="line none">  231           if(memcmp(&amp;<a href="uip-nd6.c.html#105">nd6_opt_llao</a>[<a href="uip-nd6.h.html#209">UIP_ND6_OPT_DATA_OFFSET</a>],</div><div id="232" class="line none">  232               <a href="../nbr-table.h.html#93">lladdr</a>, <a href="uip.h.html#145">UIP_LLADDR_LEN</a>) != 0) {</div><div id="233" class="line none">  233             if(<a href="uip-ds6-nbr.h.html#173">uip_ds6_nbr_update_ll</a>(&amp;<a href="uip-nd6.c.html#106">nbr</a>,</div><div id="234" class="line none">  234                                      (const <a href="uip.h.html#138">uip_lladdr_t</a> *)&amp;lladdr_aligned)</div><div id="235" class="line none">  235                &lt; 0) {</div><div id="236" class="line none">  236               /* failed to update the lladdr */</div><div id="237" class="line none">  237               goto discard;</div><div id="238" class="line none">  238             }</div><div id="239" class="line none">  239             <a href="uip-nd6.c.html#106">nbr</a>-&gt;<a href="uip-ds6-nbr.h.html#112">state</a> = <a href="uip-ds6-nbr.h.html#66">NBR_STALE</a>;</div><div id="240" class="line none">  240           } else {</div><div id="241" class="line none">  241             if(<a href="uip-nd6.c.html#106">nbr</a>-&gt;<a href="uip-ds6-nbr.h.html#112">state</a> == <a href="uip-ds6-nbr.h.html#64">NBR_INCOMPLETE</a>) {</div><div id="242" class="line none">  242               <a href="uip-nd6.c.html#106">nbr</a>-&gt;<a href="uip-ds6-nbr.h.html#112">state</a> = <a href="uip-ds6-nbr.h.html#66">NBR_STALE</a>;</div><div id="243" class="line none">  243             }</div><div id="244" class="line none">  244           }</div><div id="245" class="line none">  245         }</div><div id="246" class="line none">  246 #if UIP_CONF_IPV6_CHECKS</div><div id="247" class="line none">  247       }</div><div id="248" class="line none">  248 #endif /*UIP_CONF_IPV6_CHECKS */</div><div id="249" class="line none">  249       break;</div><div id="250" class="line none">  250     default:</div><div id="251" class="line none">  251       <a href="../../sys/log.h.html#199">LOG_WARN</a>("ND option not supported in NS");</div><div id="252" class="line none">  252       break;</div><div id="253" class="line none">  253     }</div><div id="254" class="line none">  254     <a href="uip-nd6.c.html#104">nd6_opt_offset</a> += (<a href="uip-nd6.c.html#97">ND6_OPT_HDR_BUF</a>(<a href="uip-nd6.c.html#104">nd6_opt_offset</a>)-&gt;<a href="uip-nd6.h.html#326">len</a> &lt;&lt; 3);</div><div id="255" class="line none">  255   }</div><div id="256" class="line none">  256 </div><div id="257" class="line none">  257   <a href="uip-nd6.c.html#107">addr</a> = <a href="uip-ds6.h.html#324">uip_ds6_addr_lookup</a>(&amp;<a href="uip-nd6.c.html#92">UIP_ND6_NS_BUF</a>-&gt;<a href="uip-nd6.h.html#270">tgtipaddr</a>);</div><div id="258" class="line none">  258   if(<a href="uip-nd6.c.html#107">addr</a> != NULL) {</div><div id="259" class="line none">  259     if(<a href="uip.h.html#1751">uip_is_addr_unspecified</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">srcipaddr</a>)) {</div><div id="260" class="line none">  260       /* DAD CASE */</div><div id="261" class="line none">  261 #if <a href="uip-nd6.h.html#142">UIP_ND6_DEF_MAXDADNS</a> &gt; 0</div><div id="262" class="line none">  262 #if UIP_CONF_IPV6_CHECKS</div><div id="263" class="line none">  263       if(!<a href="uip.h.html#1815">uip_is_addr_solicited_node</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">destipaddr</a>)) {</div><div id="264" class="line none">  264         <a href="../../sys/log.h.html#198">LOG_ERR</a>("NS received is bad\n");</div><div id="265" class="line none">  265         goto discard;</div><div id="266" class="line none">  266       }</div><div id="267" class="line none">  267 #endif /* UIP_CONF_IPV6_CHECKS */</div><div id="268" class="line none">  268       if(<a href="uip-nd6.c.html#107">addr</a>-&gt;<a href="uip-ds6-nbr.h.html#112">state</a> != <a href="uip-ds6.h.html#156">ADDR_TENTATIVE</a>) {</div><div id="269" class="line none">  269         <a href="uip.h.html#1800">uip_create_linklocal_allnodes_mcast</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">destipaddr</a>);</div><div id="270" class="line none">  270         <a href="uip-ds6.h.html#365">uip_ds6_select_src</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">srcipaddr</a>, &amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">destipaddr</a>);</div><div id="271" class="line none">  271         <a href="uip.h.html#1630">flags</a> = <a href="uip-nd6.h.html#253">UIP_ND6_NA_FLAG_OVERRIDE</a>;</div><div id="272" class="line none">  272         goto create_na;</div><div id="273" class="line none">  273       } else {</div><div id="274" class="line none">  274           /** \todo if I sent a NS before him, I win */</div><div id="275" class="line none">  275         uip_ds6_dad_failed(<a href="uip-nd6.c.html#107">addr</a>);</div><div id="276" class="line none">  276         goto discard;</div><div id="277" class="line none">  277       }</div><div id="278" class="line none">  278 #else /* UIP_ND6_DEF_MAXDADNS &gt; 0 */</div><div id="279" class="line none">  279       goto discard;  /* DAD CASE */</div><div id="280" class="line none">  280 #endif /* UIP_ND6_DEF_MAXDADNS &gt; 0 */</div><div id="281" class="line none">  281     }</div><div id="282" class="line none">  282 #if UIP_CONF_IPV6_CHECKS</div><div id="283" class="line none">  283     if(<a href="uip-ds6.h.html#385">uip_ds6_is_my_addr</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">srcipaddr</a>)) {</div><div id="284" class="line none">  284         /**</div><div id="285" class="line none">  285          * \NOTE do we do something here? we both are using the same address.</div><div id="286" class="line none">  286          * If we are doing dad, we could cancel it, though we should receive a</div><div id="287" class="line none">  287          * NA in response of DAD NS we sent, hence DAD will fail anyway. If we</div><div id="288" class="line none">  288          * were not doing DAD, it means there is a duplicate in the network!</div><div id="289" class="line none">  289          */</div><div id="290" class="line none">  290       <a href="../../sys/log.h.html#198">LOG_ERR</a>("NS received is bad\n");</div><div id="291" class="line none">  291       goto discard;</div><div id="292" class="line none">  292     }</div><div id="293" class="line none">  293 #endif /*UIP_CONF_IPV6_CHECKS */</div><div id="294" class="line none">  294 </div><div id="295" class="line none">  295     /* Address resolution case */</div><div id="296" class="line none">  296     if(<a href="uip.h.html#1815">uip_is_addr_solicited_node</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">destipaddr</a>)) {</div><div id="297" class="line none">  297       <a href="uip.h.html#969">uip_ipaddr_copy</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">destipaddr</a>, &amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">srcipaddr</a>);</div><div id="298" class="line none">  298       <a href="uip.h.html#969">uip_ipaddr_copy</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">srcipaddr</a>, &amp;<a href="uip-nd6.c.html#92">UIP_ND6_NS_BUF</a>-&gt;<a href="uip-nd6.h.html#270">tgtipaddr</a>);</div><div id="299" class="line none">  299       <a href="uip.h.html#1630">flags</a> = <a href="uip-nd6.h.html#252">UIP_ND6_NA_FLAG_SOLICITED</a> | <a href="uip-nd6.h.html#253">UIP_ND6_NA_FLAG_OVERRIDE</a>;</div><div id="300" class="line none">  300       goto create_na;</div><div id="301" class="line none">  301     }</div><div id="302" class="line none">  302 </div><div id="303" class="line none">  303     /* NUD CASE */</div><div id="304" class="line none">  304     if(<a href="uip-ds6.h.html#324">uip_ds6_addr_lookup</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">destipaddr</a>) == <a href="uip-nd6.c.html#107">addr</a>) {</div><div id="305" class="line none">  305       <a href="uip.h.html#969">uip_ipaddr_copy</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">destipaddr</a>, &amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">srcipaddr</a>);</div><div id="306" class="line none">  306       <a href="uip.h.html#969">uip_ipaddr_copy</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">srcipaddr</a>, &amp;<a href="uip-nd6.c.html#92">UIP_ND6_NS_BUF</a>-&gt;<a href="uip-nd6.h.html#270">tgtipaddr</a>);</div><div id="307" class="line none">  307       <a href="uip.h.html#1630">flags</a> = <a href="uip-nd6.h.html#252">UIP_ND6_NA_FLAG_SOLICITED</a> | <a href="uip-nd6.h.html#253">UIP_ND6_NA_FLAG_OVERRIDE</a>;</div><div id="308" class="line none">  308       goto create_na;</div><div id="309" class="line none">  309     } else {</div><div id="310" class="line none">  310 #if UIP_CONF_IPV6_CHECKS</div><div id="311" class="line none">  311       <a href="../../sys/log.h.html#198">LOG_ERR</a>("NS received is bad\n");</div><div id="312" class="line none">  312       goto discard;</div><div id="313" class="line none">  313 #endif /* UIP_CONF_IPV6_CHECKS */</div><div id="314" class="line none">  314     }</div><div id="315" class="line none">  315   } else {</div><div id="316" class="line none">  316     goto discard;</div><div id="317" class="line none">  317   }</div><div id="318" class="line none">  318 </div><div id="319" class="line none">  319 </div><div id="320" class="line none">  320 create_na:</div><div id="321" class="line none">  321     /* If the node is a router it should set R flag in NAs */</div><div id="322" class="line none">  322 #if UIP_CONF_ROUTER</div><div id="323" class="line none">  323     <a href="uip.h.html#1630">flags</a> = <a href="uip.h.html#1630">flags</a> | <a href="uip-nd6.h.html#251">UIP_ND6_NA_FLAG_ROUTER</a>;</div><div id="324" class="line none">  324 #endif</div><div id="325" class="line none">  325   <a href="uipbuf.c.html#44">uipbuf_clear</a>();</div><div id="326" class="line none">  326   <a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1532">vtc</a> = 0x60;</div><div id="327" class="line none">  327   <a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1533">tcflow</a> = 0;</div><div id="328" class="line none">  328   <a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1534">flow</a> = 0;</div><div id="329" class="line none">  329   <a href="uipbuf.c.html#76">uipbuf_set_len_field</a>(<a href="uip.h.html#71">UIP_IP_BUF</a>, <a href="uip.h.html#61">UIP_ICMPH_LEN</a> + <a href="uip-nd6.h.html#213">UIP_ND6_NA_LEN</a> + <a href="uip-nd6.h.html#235">UIP_ND6_OPT_LLAO_LEN</a>);</div><div id="330" class="line none">  330   <a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1536">proto</a> = <a href="uip.h.html#1684">UIP_PROTO_ICMP6</a>;</div><div id="331" class="line none">  331   <a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1313">ttl</a> = <a href="uip-nd6.h.html#55">UIP_ND6_HOP_LIMIT</a>;</div><div id="332" class="line none">  332 </div><div id="333" class="line none">  333   <a href="uip.h.html#77">UIP_ICMP_BUF</a>-&gt;<a href="uip-ds6.h.html#209">type</a> = <a href="uip-icmp6.h.html#63">ICMP6_NA</a>;</div><div id="334" class="line none">  334   <a href="uip.h.html#77">UIP_ICMP_BUF</a>-&gt;<a href="uip-icmp6.h.html#183">icode</a> = 0;</div><div id="335" class="line none">  335 </div><div id="336" class="line none">  336   <a href="uip-nd6.c.html#93">UIP_ND6_NA_BUF</a>-&gt;<a href="uip-nd6.h.html#279">flagsreserved</a> = <a href="uip.h.html#1630">flags</a>;</div><div id="337" class="line none">  337   memcpy(&amp;<a href="uip-nd6.c.html#93">UIP_ND6_NA_BUF</a>-&gt;<a href="uip-nd6.h.html#270">tgtipaddr</a>, &amp;<a href="uip-nd6.c.html#107">addr</a>-&gt;<a href="uip-ds6-nbr.h.html#110">ipaddr</a>, sizeof(<a href="uip.h.html#105">uip_ipaddr_t</a>));</div><div id="338" class="line none">  338 </div><div id="339" class="line none">  339   <a href="uip-nd6.c.html#139">create_llao</a>(&amp;<a href="uip.h.html#465">uip_buf</a>[<a href="uip.h.html#66">uip_l3_icmp_hdr_len</a> + <a href="uip-nd6.h.html#213">UIP_ND6_NA_LEN</a>],</div><div id="340" class="line none">  340               <a href="uip-nd6.h.html#197">UIP_ND6_OPT_TLLAO</a>);</div><div id="341" class="line none">  341 </div><div id="342" class="line none">  342   <a href="uip.h.html#77">UIP_ICMP_BUF</a>-&gt;<a href="uip.h.html#1652">icmpchksum</a> = 0;</div><div id="343" class="line none">  343   <a href="uip.h.html#77">UIP_ICMP_BUF</a>-&gt;<a href="uip.h.html#1652">icmpchksum</a> = ~<a href="uip.h.html#2012">uip_icmp6chksum</a>();</div><div id="344" class="line none">  344 </div><div id="345" class="line none">  345   <a href="uipbuf.c.html#65">uipbuf_set_len</a>(<a href="uip.h.html#56">UIP_IPH_LEN</a> + <a href="uip.h.html#61">UIP_ICMPH_LEN</a> + <a href="uip-nd6.h.html#213">UIP_ND6_NA_LEN</a> + <a href="uip-nd6.h.html#235">UIP_ND6_OPT_LLAO_LEN</a>);</div><div id="346" class="line none">  346 </div><div id="347" class="line none">  347   <a href="uip.h.html#1349">UIP_STAT</a>(++uip_stat.<a href="uip.h.html#1413">nd6</a>.<a href="uip.h.html#1362">sent</a>);</div><div id="348" class="line none">  348   <a href="../../sys/log.h.html#200">LOG_INFO</a>("Sending NA to ");</div><div id="349" class="line none">  349   <a href="../../sys/log.h.html#218">LOG_INFO_6ADDR</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">destipaddr</a>);</div><div id="350" class="line none">  350   <a href="../../sys/log.h.html#206">LOG_INFO_</a>(" from ");</div><div id="351" class="line none">  351   <a href="../../sys/log.h.html#218">LOG_INFO_6ADDR</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">srcipaddr</a>);</div><div id="352" class="line none">  352   <a href="../../sys/log.h.html#206">LOG_INFO_</a>(" with target address ");</div><div id="353" class="line none">  353   <a href="../../sys/log.h.html#218">LOG_INFO_6ADDR</a>(&amp;<a href="uip-nd6.c.html#93">UIP_ND6_NA_BUF</a>-&gt;<a href="uip-nd6.h.html#270">tgtipaddr</a>);</div><div id="354" class="line none">  354   <a href="../../sys/log.h.html#206">LOG_INFO_</a>("\n");</div><div id="355" class="line none">  355   return;</div><div id="356" class="line none">  356 </div><div id="357" class="line none">  357 discard:</div><div id="358" class="line none">  358   <a href="uipbuf.c.html#44">uipbuf_clear</a>();</div><div id="359" class="line none">  359   return;</div><div id="360" class="line none">  360 }</div><div id="361" class="line none">  361 #endif /* UIP_ND6_SEND_NA */</div><div id="362" class="line none">  362 </div><div id="363" class="line none">  363 </div><div id="364" class="line none">  364 /*------------------------------------------------------------------*/</div><div id="365" class="line none">  365 #if <a href="uip-nd6.h.html#90">UIP_ND6_SEND_NS</a></div><div id="366" class="line none">  366 void</div><div id="367" class="line none">  367 <a href="uip-nd6.c.html#367">uip_nd6_ns_output</a>(const <a href="uip.h.html#105">uip_ipaddr_t</a> * <a href="uip.h.html#1428">src</a>, const <a href="uip.h.html#105">uip_ipaddr_t</a> * <a href="uip.h.html#1427">dest</a>,</div><div id="368" class="line none">  368                   <a href="uip.h.html#105">uip_ipaddr_t</a> * tgt)</div><div id="369" class="line none">  369 {</div><div id="370" class="line none">  370   <a href="uipbuf.c.html#44">uipbuf_clear</a>();</div><div id="371" class="line none">  371   <a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1532">vtc</a> = 0x60;</div><div id="372" class="line none">  372   <a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1533">tcflow</a> = 0;</div><div id="373" class="line none">  373   <a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1534">flow</a> = 0;</div><div id="374" class="line none">  374   <a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1536">proto</a> = <a href="uip.h.html#1684">UIP_PROTO_ICMP6</a>;</div><div id="375" class="line none">  375   <a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1313">ttl</a> = <a href="uip-nd6.h.html#55">UIP_ND6_HOP_LIMIT</a>;</div><div id="376" class="line none">  376 </div><div id="377" class="line none">  377   if(<a href="uip.h.html#1427">dest</a> == NULL) {</div><div id="378" class="line none">  378     <a href="uip.h.html#1830">uip_create_solicited_node</a>(tgt, &amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">destipaddr</a>);</div><div id="379" class="line none">  379   } else {</div><div id="380" class="line none">  380     <a href="uip.h.html#969">uip_ipaddr_copy</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">destipaddr</a>, <a href="uip.h.html#1427">dest</a>);</div><div id="381" class="line none">  381   }</div><div id="382" class="line none">  382   <a href="uip.h.html#77">UIP_ICMP_BUF</a>-&gt;<a href="uip-ds6.h.html#209">type</a> = <a href="uip-icmp6.h.html#62">ICMP6_NS</a>;</div><div id="383" class="line none">  383   <a href="uip.h.html#77">UIP_ICMP_BUF</a>-&gt;<a href="uip-icmp6.h.html#183">icode</a> = 0;</div><div id="384" class="line none">  384   <a href="uip-nd6.c.html#92">UIP_ND6_NS_BUF</a>-&gt;<a href="uip-nd6.h.html#269">reserved</a> = 0;</div><div id="385" class="line none">  385   <a href="uip.h.html#969">uip_ipaddr_copy</a>((<a href="uip.h.html#105">uip_ipaddr_t</a> *) &amp;<a href="uip-nd6.c.html#92">UIP_ND6_NS_BUF</a>-&gt;<a href="uip-nd6.h.html#270">tgtipaddr</a>, tgt);</div><div id="386" class="line none">  386   /*</div><div id="387" class="line none">  387    * check if we add a SLLAO option: for DAD, MUST NOT, for NUD, MAY</div><div id="388" class="line none">  388    * (here yes), for Address resolution , MUST</div><div id="389" class="line none">  389    */</div><div id="390" class="line none">  390   if(!(<a href="uip-ds6.h.html#385">uip_ds6_is_my_addr</a>(tgt))) {</div><div id="391" class="line none">  391     if(<a href="uip.h.html#1428">src</a> != NULL) {</div><div id="392" class="line none">  392       <a href="uip.h.html#969">uip_ipaddr_copy</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">srcipaddr</a>, <a href="uip.h.html#1428">src</a>);</div><div id="393" class="line none">  393     } else {</div><div id="394" class="line none">  394       <a href="uip-ds6.h.html#365">uip_ds6_select_src</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">srcipaddr</a>, &amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">destipaddr</a>);</div><div id="395" class="line none">  395     }</div><div id="396" class="line none">  396     if (<a href="uip.h.html#1751">uip_is_addr_unspecified</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">srcipaddr</a>)) {</div><div id="397" class="line none">  397       <a href="../../sys/log.h.html#198">LOG_ERR</a>("Dropping NS due to no suitable source address\n");</div><div id="398" class="line none">  398       <a href="uipbuf.c.html#44">uipbuf_clear</a>();</div><div id="399" class="line none">  399       return;</div><div id="400" class="line none">  400     }</div><div id="401" class="line none">  401     <a href="uipbuf.c.html#76">uipbuf_set_len_field</a>(<a href="uip.h.html#71">UIP_IP_BUF</a>, <a href="uip.h.html#61">UIP_ICMPH_LEN</a> + <a href="uip-nd6.h.html#214">UIP_ND6_NS_LEN</a> + <a href="uip-nd6.h.html#235">UIP_ND6_OPT_LLAO_LEN</a>);</div><div id="402" class="line none">  402 </div><div id="403" class="line none">  403     <a href="uip-nd6.c.html#139">create_llao</a>(&amp;<a href="uip.h.html#465">uip_buf</a>[<a href="uip.h.html#66">uip_l3_icmp_hdr_len</a> + <a href="uip-nd6.h.html#214">UIP_ND6_NS_LEN</a>],</div><div id="404" class="line none">  404                 <a href="uip-nd6.h.html#196">UIP_ND6_OPT_SLLAO</a>);</div><div id="405" class="line none">  405 </div><div id="406" class="line none">  406     <a href="../../../cbmc/proofs/net/ipv6/rs_input/rsi_harness.c.html#20">uip_len</a> =</div><div id="407" class="line none">  407       <a href="uip.h.html#56">UIP_IPH_LEN</a> + <a href="uip.h.html#61">UIP_ICMPH_LEN</a> + <a href="uip-nd6.h.html#214">UIP_ND6_NS_LEN</a> + <a href="uip-nd6.h.html#235">UIP_ND6_OPT_LLAO_LEN</a>;</div><div id="408" class="line none">  408   } else {</div><div id="409" class="line none">  409     <a href="uip.h.html#1797">uip_create_unspecified</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">srcipaddr</a>);</div><div id="410" class="line none">  410     <a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip-nd6.h.html#326">len</a>[1] = <a href="uip.h.html#61">UIP_ICMPH_LEN</a> + <a href="uip-nd6.h.html#214">UIP_ND6_NS_LEN</a>;</div><div id="411" class="line none">  411     <a href="../../../cbmc/proofs/net/ipv6/rs_input/rsi_harness.c.html#20">uip_len</a> = <a href="uip.h.html#56">UIP_IPH_LEN</a> + <a href="uip.h.html#61">UIP_ICMPH_LEN</a> + <a href="uip-nd6.h.html#214">UIP_ND6_NS_LEN</a>;</div><div id="412" class="line none">  412   }</div><div id="413" class="line none">  413 </div><div id="414" class="line none">  414   <a href="uip.h.html#77">UIP_ICMP_BUF</a>-&gt;<a href="uip.h.html#1652">icmpchksum</a> = 0;</div><div id="415" class="line none">  415   <a href="uip.h.html#77">UIP_ICMP_BUF</a>-&gt;<a href="uip.h.html#1652">icmpchksum</a> = ~<a href="uip.h.html#2012">uip_icmp6chksum</a>();</div><div id="416" class="line none">  416 </div><div id="417" class="line none">  417   <a href="uip.h.html#1349">UIP_STAT</a>(++uip_stat.<a href="uip.h.html#1413">nd6</a>.<a href="uip.h.html#1362">sent</a>);</div><div id="418" class="line none">  418   <a href="../../sys/log.h.html#200">LOG_INFO</a>("Sending NS to ");</div><div id="419" class="line none">  419   <a href="../../sys/log.h.html#218">LOG_INFO_6ADDR</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">destipaddr</a>);</div><div id="420" class="line none">  420   <a href="../../sys/log.h.html#206">LOG_INFO_</a>(" from ");</div><div id="421" class="line none">  421   <a href="../../sys/log.h.html#218">LOG_INFO_6ADDR</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">srcipaddr</a>);</div><div id="422" class="line none">  422   <a href="../../sys/log.h.html#206">LOG_INFO_</a>(" with target address ");</div><div id="423" class="line none">  423   <a href="../../sys/log.h.html#218">LOG_INFO_6ADDR</a>(tgt);</div><div id="424" class="line none">  424   <a href="../../sys/log.h.html#206">LOG_INFO_</a>("\n");</div><div id="425" class="line none">  425   return;</div><div id="426" class="line none">  426 }</div><div id="427" class="line none">  427 #endif /* UIP_ND6_SEND_NS */</div><div id="428" class="line none">  428 </div><div id="429" class="line none">  429 #if <a href="uip-nd6.h.html#90">UIP_ND6_SEND_NS</a></div><div id="430" class="line none">  430 /*------------------------------------------------------------------*/</div><div id="431" class="line none">  431 /**</div><div id="432" class="line none">  432  * Neighbor Advertisement Processing</div><div id="433" class="line none">  433  *</div><div id="434" class="line none">  434  * we might have to send a pkt that had been buffered while address</div><div id="435" class="line none">  435  * resolution was performed (if we support buffering, see UIP_CONF_QUEUE_PKT)</div><div id="436" class="line none">  436  *</div><div id="437" class="line none">  437  * As per RFC 4861, on link layer that have addresses, TLLAO options MUST be</div><div id="438" class="line none">  438  * included when responding to multicast solicitations, SHOULD be included in</div><div id="439" class="line none">  439  * response to unicast (here we assume it is for now)</div><div id="440" class="line none">  440  *</div><div id="441" class="line none">  441  * NA can be received after sending NS for DAD, Address resolution or NUD. Can</div><div id="442" class="line none">  442  * be unsolicited as well.</div><div id="443" class="line none">  443  * It can trigger update of the state of the neighbor in the neighbor cache,</div><div id="444" class="line none">  444  * router in the router list.</div><div id="445" class="line none">  445  * If the NS was for DAD, it means DAD failed</div><div id="446" class="line none">  446  *</div><div id="447" class="line none">  447  */</div><div id="448" class="line none">  448 static void</div><div id="449" class="line none">  449 <a href="uip-nd6.c.html#449">na_input</a>(void)</div><div id="450" class="line none">  450 {</div><div id="451" class="line none">  451   uint8_t is_llchange;</div><div id="452" class="line none">  452   uint8_t is_router;</div><div id="453" class="line none">  453   uint8_t is_solicited;</div><div id="454" class="line none">  454   uint8_t is_override;</div><div id="455" class="line none">  455   <a href="uip.h.html#138">uip_lladdr_t</a> lladdr_aligned;</div><div id="456" class="line none">  456 </div><div id="457" class="line none">  457   <a href="../../sys/log.h.html#200">LOG_INFO</a>("Received NA from ");</div><div id="458" class="line none">  458   <a href="../../sys/log.h.html#218">LOG_INFO_6ADDR</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">srcipaddr</a>);</div><div id="459" class="line none">  459   <a href="../../sys/log.h.html#206">LOG_INFO_</a>(" to ");</div><div id="460" class="line none">  460   <a href="../../sys/log.h.html#218">LOG_INFO_6ADDR</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">destipaddr</a>);</div><div id="461" class="line none">  461   <a href="../../sys/log.h.html#206">LOG_INFO_</a>(" with target address ");</div><div id="462" class="line none">  462   <a href="../../sys/log.h.html#218">LOG_INFO_6ADDR</a>((<a href="uip.h.html#105">uip_ipaddr_t</a> *) (&amp;<a href="uip-nd6.c.html#93">UIP_ND6_NA_BUF</a>-&gt;<a href="uip-nd6.h.html#270">tgtipaddr</a>));</div><div id="463" class="line none">  463   <a href="../../sys/log.h.html#206">LOG_INFO_</a>("\n");</div><div id="464" class="line none">  464   <a href="uip.h.html#1349">UIP_STAT</a>(++uip_stat.<a href="uip.h.html#1413">nd6</a>.<a href="uip.h.html#1361">recv</a>);</div><div id="465" class="line none">  465 </div><div id="466" class="line none">  466   /*</div><div id="467" class="line none">  467    * booleans. the three last one are not 0 or 1 but 0 or 0x80, 0x40, 0x20</div><div id="468" class="line none">  468    * but it works. Be careful though, do not use tests such as is_router == 1</div><div id="469" class="line none">  469    */</div><div id="470" class="line none">  470   is_llchange = 0;</div><div id="471" class="line none">  471   is_router = ((<a href="uip-nd6.c.html#93">UIP_ND6_NA_BUF</a>-&gt;<a href="uip-nd6.h.html#279">flagsreserved</a> &amp; <a href="uip-nd6.h.html#251">UIP_ND6_NA_FLAG_ROUTER</a>));</div><div id="472" class="line none">  472   is_solicited =</div><div id="473" class="line none">  473     ((<a href="uip-nd6.c.html#93">UIP_ND6_NA_BUF</a>-&gt;<a href="uip-nd6.h.html#279">flagsreserved</a> &amp; <a href="uip-nd6.h.html#252">UIP_ND6_NA_FLAG_SOLICITED</a>));</div><div id="474" class="line none">  474   is_override =</div><div id="475" class="line none">  475     ((<a href="uip-nd6.c.html#93">UIP_ND6_NA_BUF</a>-&gt;<a href="uip-nd6.h.html#279">flagsreserved</a> &amp; <a href="uip-nd6.h.html#253">UIP_ND6_NA_FLAG_OVERRIDE</a>));</div><div id="476" class="line none">  476 </div><div id="477" class="line none">  477 #if UIP_CONF_IPV6_CHECKS</div><div id="478" class="line none">  478   if((<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1313">ttl</a> != <a href="uip-nd6.h.html#55">UIP_ND6_HOP_LIMIT</a>) ||</div><div id="479" class="line none">  479      (<a href="uip.h.html#77">UIP_ICMP_BUF</a>-&gt;<a href="uip-icmp6.h.html#183">icode</a> != 0) ||</div><div id="480" class="line none">  480      (<a href="uip.h.html#1886">uip_is_addr_mcast</a>(&amp;<a href="uip-nd6.c.html#93">UIP_ND6_NA_BUF</a>-&gt;<a href="uip-nd6.h.html#270">tgtipaddr</a>)) ||</div><div id="481" class="line none">  481      (is_solicited &amp;&amp; <a href="uip.h.html#1886">uip_is_addr_mcast</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">destipaddr</a>))) {</div><div id="482" class="line none">  482     <a href="../../sys/log.h.html#198">LOG_ERR</a>("NA received is bad\n");</div><div id="483" class="line none">  483     goto discard;</div><div id="484" class="line none">  484   }</div><div id="485" class="line none">  485 #endif /*UIP_CONF_IPV6_CHECKS */</div><div id="486" class="line none">  486 </div><div id="487" class="line none">  487   /* Options processing: we handle TLLAO, and must ignore others */</div><div id="488" class="line none">  488   <a href="uip-nd6.c.html#104">nd6_opt_offset</a> = <a href="uip-nd6.h.html#213">UIP_ND6_NA_LEN</a>;</div><div id="489" class="line none">  489   <a href="uip-nd6.c.html#105">nd6_opt_llao</a> = NULL;</div><div id="490" class="line none">  490   while(<a href="uip.h.html#66">uip_l3_icmp_hdr_len</a> + <a href="uip-nd6.c.html#104">nd6_opt_offset</a> &lt; <a href="../../../cbmc/proofs/net/ipv6/rs_input/rsi_harness.c.html#20">uip_len</a>) {</div><div id="491" class="line none">  491 #if UIP_CONF_IPV6_CHECKS</div><div id="492" class="line none">  492     if(<a href="uip-nd6.c.html#97">ND6_OPT_HDR_BUF</a>(<a href="uip-nd6.c.html#104">nd6_opt_offset</a>)-&gt;<a href="uip-nd6.h.html#326">len</a> == 0) {</div><div id="493" class="line none">  493       <a href="../../sys/log.h.html#198">LOG_ERR</a>("NA received is bad\n");</div><div id="494" class="line none">  494       goto discard;</div><div id="495" class="line none">  495     }</div><div id="496" class="line none">  496 #endif /*UIP_CONF_IPV6_CHECKS */</div><div id="497" class="line none">  497     switch (<a href="uip-nd6.c.html#97">ND6_OPT_HDR_BUF</a>(<a href="uip-nd6.c.html#104">nd6_opt_offset</a>)-&gt;<a href="uip-ds6.h.html#209">type</a>) {</div><div id="498" class="line none">  498     case <a href="uip-nd6.h.html#197">UIP_ND6_OPT_TLLAO</a>:</div><div id="499" class="line none">  499       <a href="uip-nd6.c.html#105">nd6_opt_llao</a> = (uint8_t *)<a href="uip-nd6.c.html#97">ND6_OPT_HDR_BUF</a>(<a href="uip-nd6.c.html#104">nd6_opt_offset</a>);</div><div id="500" class="line none">  500       break;</div><div id="501" class="line none">  501     default:</div><div id="502" class="line none">  502       <a href="../../sys/log.h.html#199">LOG_WARN</a>("ND option not supported in NA\n");</div><div id="503" class="line none">  503       break;</div><div id="504" class="line none">  504     }</div><div id="505" class="line none">  505     <a href="uip-nd6.c.html#104">nd6_opt_offset</a> += (<a href="uip-nd6.c.html#97">ND6_OPT_HDR_BUF</a>(<a href="uip-nd6.c.html#104">nd6_opt_offset</a>)-&gt;<a href="uip-nd6.h.html#326">len</a> &lt;&lt; 3);</div><div id="506" class="line none">  506   }</div><div id="507" class="line none">  507   <a href="uip-nd6.c.html#107">addr</a> = <a href="uip-ds6.h.html#324">uip_ds6_addr_lookup</a>(&amp;<a href="uip-nd6.c.html#93">UIP_ND6_NA_BUF</a>-&gt;<a href="uip-nd6.h.html#270">tgtipaddr</a>);</div><div id="508" class="line none">  508   /* Message processing, including TLLAO if any */</div><div id="509" class="line none">  509   if(<a href="uip-nd6.c.html#107">addr</a> != NULL) {</div><div id="510" class="line none">  510 #if <a href="uip-nd6.h.html#142">UIP_ND6_DEF_MAXDADNS</a> &gt; 0</div><div id="511" class="line none">  511     if(<a href="uip-nd6.c.html#107">addr</a>-&gt;<a href="uip-ds6-nbr.h.html#112">state</a> == <a href="uip-ds6.h.html#156">ADDR_TENTATIVE</a>) {</div><div id="512" class="line none">  512       uip_ds6_dad_failed(<a href="uip-nd6.c.html#107">addr</a>);</div><div id="513" class="line none">  513     }</div><div id="514" class="line none">  514 #endif /*UIP_ND6_DEF_MAXDADNS &gt; 0 */</div><div id="515" class="line none">  515     <a href="../../sys/log.h.html#198">LOG_ERR</a>("NA received is bad\n");</div><div id="516" class="line none">  516     goto discard;</div><div id="517" class="line none">  517   } else {</div><div id="518" class="line none">  518     const <a href="uip.h.html#138">uip_lladdr_t</a> *<a href="../nbr-table.h.html#93">lladdr</a>;</div><div id="519" class="line none">  519     <a href="uip-nd6.c.html#106">nbr</a> = <a href="../../../cbmc/proofs/net/ipv6/rs_input/rsi_harness.c.html#23">uip_ds6_nbr_lookup</a>(&amp;<a href="uip-nd6.c.html#93">UIP_ND6_NA_BUF</a>-&gt;<a href="uip-nd6.h.html#270">tgtipaddr</a>);</div><div id="520" class="line none">  520     if(<a href="uip-nd6.c.html#106">nbr</a> == NULL) {</div><div id="521" class="line none">  521       goto discard;</div><div id="522" class="line none">  522     }</div><div id="523" class="line none">  523     <a href="../nbr-table.h.html#93">lladdr</a> = <a href="../../../cbmc/proofs/net/ipv6/rs_input/rsi_harness.c.html#83">uip_ds6_nbr_get_ll</a>(<a href="uip-nd6.c.html#106">nbr</a>);</div><div id="524" class="line none">  524     if(<a href="../nbr-table.h.html#93">lladdr</a> == NULL) {</div><div id="525" class="line none">  525       goto discard;</div><div id="526" class="line none">  526     }</div><div id="527" class="line none">  527     if(<a href="uip-nd6.c.html#105">nd6_opt_llao</a> != NULL) {</div><div id="528" class="line none">  528       is_llchange =</div><div id="529" class="line none">  529         memcmp(&amp;<a href="uip-nd6.c.html#105">nd6_opt_llao</a>[<a href="uip-nd6.h.html#209">UIP_ND6_OPT_DATA_OFFSET</a>], <a href="../nbr-table.h.html#93">lladdr</a>,</div><div id="530" class="line none">  530                <a href="uip.h.html#145">UIP_LLADDR_LEN</a>) == 0 ? 0 : 1;</div><div id="531" class="line none">  531     }</div><div id="532" class="line none">  532     if(<a href="uip-nd6.c.html#106">nbr</a>-&gt;<a href="uip-ds6-nbr.h.html#112">state</a> == <a href="uip-ds6-nbr.h.html#64">NBR_INCOMPLETE</a>) {</div><div id="533" class="line none">  533       if(<a href="uip-nd6.c.html#105">nd6_opt_llao</a> == NULL || !<a href="uip-nd6.c.html#126">extract_lladdr_from_llao_aligned</a>(&amp;lladdr_aligned)) {</div><div id="534" class="line none">  534         goto discard;</div><div id="535" class="line none">  535       }</div><div id="536" class="line none">  536       if(<a href="uip-ds6-nbr.h.html#173">uip_ds6_nbr_update_ll</a>(&amp;<a href="uip-nd6.c.html#106">nbr</a>,</div><div id="537" class="line none">  537                                (const <a href="uip.h.html#138">uip_lladdr_t</a> *)&amp;lladdr_aligned) &lt; 0) {</div><div id="538" class="line none">  538         /* failed to update the lladdr */</div><div id="539" class="line none">  539         goto discard;</div><div id="540" class="line none">  540       }</div><div id="541" class="line none">  541 </div><div id="542" class="line none">  542       /* Note: No need to refresh the state of the nbr here.</div><div id="543" class="line none">  543        * It has already been refreshed upon receiving the unicast IPv6 ND packet.</div><div id="544" class="line none">  544        * See: uip_ds6_nbr_refresh_reachable_state()</div><div id="545" class="line none">  545        */</div><div id="546" class="line none">  546       if(!is_solicited) {</div><div id="547" class="line none">  547         <a href="uip-nd6.c.html#106">nbr</a>-&gt;<a href="uip-ds6-nbr.h.html#112">state</a> = <a href="uip-ds6-nbr.h.html#66">NBR_STALE</a>;</div><div id="548" class="line none">  548       }</div><div id="549" class="line none">  549       <a href="uip-nd6.c.html#106">nbr</a>-&gt;<a href="uip-ds6-nbr.h.html#111">isrouter</a> = is_router;</div><div id="550" class="line none">  550     } else { /* NBR is not INCOMPLETE */</div><div id="551" class="line none">  551       if(!is_override &amp;&amp; is_llchange) {</div><div id="552" class="line none">  552         if(<a href="uip-nd6.c.html#106">nbr</a>-&gt;<a href="uip-ds6-nbr.h.html#112">state</a> == <a href="uip-ds6-nbr.h.html#65">NBR_REACHABLE</a>) {</div><div id="553" class="line none">  553           <a href="uip-nd6.c.html#106">nbr</a>-&gt;<a href="uip-ds6-nbr.h.html#112">state</a> = <a href="uip-ds6-nbr.h.html#66">NBR_STALE</a>;</div><div id="554" class="line none">  554         }</div><div id="555" class="line none">  555         goto discard;</div><div id="556" class="line none">  556       } else {</div><div id="557" class="line none">  557         /**</div><div id="558" class="line none">  558          *  If this is an cache override, or same lladdr, or no llao -</div><div id="559" class="line none">  559          *  do updates of nbr states.</div><div id="560" class="line none">  560          */</div><div id="561" class="line none">  561         if(is_override || !is_llchange || <a href="uip-nd6.c.html#105">nd6_opt_llao</a> == NULL) {</div><div id="562" class="line none">  562           if(<a href="uip-nd6.c.html#105">nd6_opt_llao</a> != NULL &amp;&amp; is_llchange) {</div><div id="563" class="line none">  563             if(!<a href="uip-nd6.c.html#126">extract_lladdr_from_llao_aligned</a>(&amp;lladdr_aligned) ||</div><div id="564" class="line none">  564                <a href="uip-ds6-nbr.h.html#173">uip_ds6_nbr_update_ll</a>(&amp;<a href="uip-nd6.c.html#106">nbr</a>,</div><div id="565" class="line none">  565                                      (const <a href="uip.h.html#138">uip_lladdr_t</a> *)&amp;lladdr_aligned)</div><div id="566" class="line none">  566                &lt; 0) {</div><div id="567" class="line none">  567               /* failed to update the lladdr */</div><div id="568" class="line none">  568               goto discard;</div><div id="569" class="line none">  569             }</div><div id="570" class="line none">  570           }</div><div id="571" class="line none">  571           /* Note: No need to refresh the state of the nbr here.</div><div id="572" class="line none">  572            * It has already been refreshed upon receiving the unicast IPv6 ND packet.</div><div id="573" class="line none">  573            * See: uip_ds6_nbr_refresh_reachable_state()</div><div id="574" class="line none">  574            */</div><div id="575" class="line none">  575         }</div><div id="576" class="line none">  576       }</div><div id="577" class="line none">  577       if(<a href="uip-nd6.c.html#106">nbr</a>-&gt;<a href="uip-ds6-nbr.h.html#111">isrouter</a> &amp;&amp; !is_router) {</div><div id="578" class="line none">  578         <a href="uip-nd6.c.html#111">defrt</a> = uip_ds6_defrt_lookup(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">srcipaddr</a>);</div><div id="579" class="line none">  579         if(<a href="uip-nd6.c.html#111">defrt</a> != NULL) {</div><div id="580" class="line none">  580           uip_ds6_defrt_rm(<a href="uip-nd6.c.html#111">defrt</a>);</div><div id="581" class="line none">  581         }</div><div id="582" class="line none">  582       }</div><div id="583" class="line none">  583       <a href="uip-nd6.c.html#106">nbr</a>-&gt;<a href="uip-ds6-nbr.h.html#111">isrouter</a> = is_router;</div><div id="584" class="line none">  584     }</div><div id="585" class="line none">  585   }</div><div id="586" class="line none">  586 #if UIP_CONF_IPV6_QUEUE_PKT</div><div id="587" class="line none">  587   /* The nbr is now reachable, check if we had buffered a pkt for it */</div><div id="588" class="line none">  588   if(uip_packetqueue_buflen(&amp;<a href="uip-nd6.c.html#106">nbr</a>-&gt;<a href="uip-ds6-nbr.h.html#119">packethandle</a>) != 0) {</div><div id="589" class="line none">  589     <a href="../../../cbmc/proofs/net/ipv6/rs_input/rsi_harness.c.html#20">uip_len</a> = uip_packetqueue_buflen(&amp;<a href="uip-nd6.c.html#106">nbr</a>-&gt;<a href="uip-ds6-nbr.h.html#119">packethandle</a>);</div><div id="590" class="line none">  590     memcpy(<a href="uip.h.html#71">UIP_IP_BUF</a>, uip_packetqueue_buf(&amp;<a href="uip-nd6.c.html#106">nbr</a>-&gt;<a href="uip-ds6-nbr.h.html#119">packethandle</a>), <a href="../../../cbmc/proofs/net/ipv6/rs_input/rsi_harness.c.html#20">uip_len</a>);</div><div id="591" class="line none">  591     uip_packetqueue_free(&amp;<a href="uip-nd6.c.html#106">nbr</a>-&gt;<a href="uip-ds6-nbr.h.html#119">packethandle</a>);</div><div id="592" class="line none">  592     return;</div><div id="593" class="line none">  593   }</div><div id="594" class="line none">  594 </div><div id="595" class="line none">  595 #endif /*UIP_CONF_IPV6_QUEUE_PKT */</div><div id="596" class="line none">  596 </div><div id="597" class="line none">  597 discard:</div><div id="598" class="line none">  598   <a href="uipbuf.c.html#44">uipbuf_clear</a>();</div><div id="599" class="line none">  599   return;</div><div id="600" class="line none">  600 }</div><div id="601" class="line none">  601 #endif /* UIP_ND6_SEND_NS */</div><div id="602" class="line none">  602 </div><div id="603" class="line none">  603 #if UIP_CONF_ROUTER</div><div id="604" class="line none">  604 #if <a href="uip-nd6.h.html#85">UIP_ND6_SEND_RA</a></div><div id="605" class="line none">  605 /*---------------------------------------------------------------------------*/</div><div id="606" class="line none">  606 void</div><div id="607" class="line none">  607 <a href="uip-nd6.c.html#607">rs_input</a>(void)</div><div id="608" class="line none">  608 {</div><div id="609" class="line none">  609 </div><div id="610" class="line both">  610   <a href="../../sys/log.h.html#200">LOG_INFO</a>("Received RS from ");</div><div id="611" class="line both">  611   <a href="../../sys/log.h.html#218">LOG_INFO_6ADDR</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">srcipaddr</a>);</div><div id="612" class="line both">  612   <a href="../../sys/log.h.html#206">LOG_INFO_</a>(" to ");</div><div id="613" class="line both">  613   <a href="../../sys/log.h.html#218">LOG_INFO_6ADDR</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">destipaddr</a>);</div><div id="614" class="line both">  614   <a href="../../sys/log.h.html#206">LOG_INFO_</a>("\n");</div><div id="615" class="line none">  615   <a href="uip.h.html#1349">UIP_STAT</a>(++uip_stat.<a href="uip.h.html#1413">nd6</a>.<a href="uip.h.html#1361">recv</a>);</div><div id="616" class="line none">  616 </div><div id="617" class="line none">  617 </div><div id="618" class="line none">  618 #if UIP_CONF_IPV6_CHECKS</div><div id="619" class="line none">  619   /*</div><div id="620" class="line none">  620    * Check hop limit / icmp code</div><div id="621" class="line none">  621    * target address must not be multicast</div><div id="622" class="line none">  622    * if the NA is solicited, dest must not be multicast</div><div id="623" class="line none">  623    */</div><div id="624" class="line hit">  624   if((<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1313">ttl</a> != <a href="uip-nd6.h.html#55">UIP_ND6_HOP_LIMIT</a>) || (<a href="uip.h.html#77">UIP_ICMP_BUF</a>-&gt;<a href="uip-icmp6.h.html#183">icode</a> != 0)) {</div><div id="625" class="line both">  625     <a href="../../sys/log.h.html#198">LOG_ERR</a>("RS received is bad\n");</div><div id="626" class="line hit">  626     goto discard;</div><div id="627" class="line none">  627   }</div><div id="628" class="line none">  628 #endif /*UIP_CONF_IPV6_CHECKS */</div><div id="629" class="line none">  629 </div><div id="630" class="line none">  630   /* Only valid option is Source Link-Layer Address option any thing</div><div id="631" class="line none">  631      else is discarded */</div><div id="632" class="line hit">  632   <a href="uip-nd6.c.html#104">nd6_opt_offset</a> = <a href="uip-nd6.h.html#216">UIP_ND6_RS_LEN</a>;</div><div id="633" class="line hit">  633   <a href="uip-nd6.c.html#105">nd6_opt_llao</a> = NULL;</div><div id="634" class="line none">  634 </div><div id="635" class="line hit">  635   while(<a href="uip.h.html#66">uip_l3_icmp_hdr_len</a> + <a href="uip-nd6.c.html#104">nd6_opt_offset</a> &lt; <a href="../../../cbmc/proofs/net/ipv6/rs_input/rsi_harness.c.html#20">uip_len</a>) {</div><div id="636" class="line none">  636 #if UIP_CONF_IPV6_CHECKS</div><div id="637" class="line hit">  637     if(<a href="uip-nd6.c.html#97">ND6_OPT_HDR_BUF</a>(<a href="uip-nd6.c.html#104">nd6_opt_offset</a>)-&gt;<a href="uip-nd6.h.html#326">len</a> == 0) {</div><div id="638" class="line both">  638       <a href="../../sys/log.h.html#198">LOG_ERR</a>("RS received is bad\n");</div><div id="639" class="line hit">  639       goto discard;</div><div id="640" class="line none">  640     }</div><div id="641" class="line none">  641 #endif /*UIP_CONF_IPV6_CHECKS */</div><div id="642" class="line hit">  642     switch (<a href="uip-nd6.c.html#97">ND6_OPT_HDR_BUF</a>(<a href="uip-nd6.c.html#104">nd6_opt_offset</a>)-&gt;<a href="uip-ds6.h.html#209">type</a>) {</div><div id="643" class="line hit">  643     case <a href="uip-nd6.h.html#196">UIP_ND6_OPT_SLLAO</a>:</div><div id="644" class="line hit">  644       <a href="uip-nd6.c.html#105">nd6_opt_llao</a> = (uint8_t *)<a href="uip-nd6.c.html#97">ND6_OPT_HDR_BUF</a>(<a href="uip-nd6.c.html#104">nd6_opt_offset</a>);</div><div id="645" class="line hit">  645       break;</div><div id="646" class="line none">  646     default:</div><div id="647" class="line both">  647       <a href="../../sys/log.h.html#199">LOG_WARN</a>("ND option not supported in RS\n");</div><div id="648" class="line none">  648       break;</div><div id="649" class="line none">  649     }</div><div id="650" class="line hit">  650     <a href="uip-nd6.c.html#104">nd6_opt_offset</a> += (<a href="uip-nd6.c.html#97">ND6_OPT_HDR_BUF</a>(<a href="uip-nd6.c.html#104">nd6_opt_offset</a>)-&gt;<a href="uip-nd6.h.html#326">len</a> &lt;&lt; 3);</div><div id="651" class="line none">  651   }</div><div id="652" class="line none">  652   /* Options processing: only SLLAO */</div><div id="653" class="line hit">  653   if(<a href="uip-nd6.c.html#105">nd6_opt_llao</a> != NULL) {</div><div id="654" class="line none">  654 #if UIP_CONF_IPV6_CHECKS</div><div id="655" class="line hit">  655     if(<a href="uip.h.html#1751">uip_is_addr_unspecified</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">srcipaddr</a>)) {</div><div id="656" class="line both">  656       <a href="../../sys/log.h.html#198">LOG_ERR</a>("RS received is bad\n");</div><div id="657" class="line hit">  657       goto discard;</div><div id="658" class="line missed">  658     } else {</div><div id="659" class="line none">  659 #endif /*UIP_CONF_IPV6_CHECKS */</div><div id="660" class="line hit">  660       <a href="uip.h.html#138">uip_lladdr_t</a> lladdr_aligned;</div><div id="661" class="line hit">  661       <a href="uip-nd6.c.html#126">extract_lladdr_from_llao_aligned</a>(&amp;lladdr_aligned);</div><div id="662" class="line hit">  662       if((<a href="uip-nd6.c.html#106">nbr</a> = <a href="../../../cbmc/proofs/net/ipv6/rs_input/rsi_harness.c.html#23">uip_ds6_nbr_lookup</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">srcipaddr</a>)) == NULL) {</div><div id="663" class="line none">  663         /* we need to add the neighbor */</div><div id="664" class="line hit">  664         <a href="../../../cbmc/proofs/net/ipv6/rs_input/rsi_harness.c.html#59">uip_ds6_nbr_add</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">srcipaddr</a>, &amp;lladdr_aligned,</div><div id="665" class="line hit">  665                         0, <a href="uip-ds6-nbr.h.html#66">NBR_STALE</a>, <a href="../nbr-table.h.html#48">NBR_TABLE_REASON_IPV6_ND</a>, NULL);</div><div id="666" class="line hit">  666       } else {</div><div id="667" class="line none">  667         /* If LL address changed, set neighbor state to stale */</div><div id="668" class="line hit">  668         const <a href="uip.h.html#138">uip_lladdr_t</a> *<a href="../nbr-table.h.html#93">lladdr</a> = <a href="../../../cbmc/proofs/net/ipv6/rs_input/rsi_harness.c.html#83">uip_ds6_nbr_get_ll</a>(<a href="uip-nd6.c.html#106">nbr</a>);</div><div id="669" class="line hit">  669         if(<a href="../nbr-table.h.html#93">lladdr</a> == NULL) {</div><div id="670" class="line hit">  670           goto discard;</div><div id="671" class="line none">  671         }</div><div id="672" class="line both">  672         if(memcmp(&amp;<a href="uip-nd6.c.html#105">nd6_opt_llao</a>[<a href="uip-nd6.h.html#209">UIP_ND6_OPT_DATA_OFFSET</a>],</div><div id="673" class="line hit">  673             <a href="../nbr-table.h.html#93">lladdr</a>, <a href="uip.h.html#145">UIP_LLADDR_LEN</a>) != 0) {</div><div id="674" class="line hit">  674           <a href="uip-ds6-nbr.h.html#122">uip_ds6_nbr_t</a> nbr_data;</div><div id="675" class="line hit">  675           nbr_data = *<a href="uip-nd6.c.html#106">nbr</a>;</div><div id="676" class="line hit">  676           <a href="../../../cbmc/proofs/net/ipv6/rs_input/rsi_harness.c.html#44">uip_ds6_nbr_rm</a>(<a href="uip-nd6.c.html#106">nbr</a>);</div><div id="677" class="line hit">  677           <a href="uip-nd6.c.html#106">nbr</a> = <a href="../../../cbmc/proofs/net/ipv6/rs_input/rsi_harness.c.html#59">uip_ds6_nbr_add</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">srcipaddr</a>, &amp;lladdr_aligned,</div><div id="678" class="line hit">  678                                 0, <a href="uip-ds6-nbr.h.html#66">NBR_STALE</a>, <a href="../nbr-table.h.html#48">NBR_TABLE_REASON_IPV6_ND</a>, NULL);</div><div id="679" class="line hit">  679           if(<a href="uip-nd6.c.html#106">nbr</a> == NULL) {</div><div id="680" class="line hit">  680             goto discard;</div><div id="681" class="line none">  681           }</div><div id="682" class="line hit">  682           <a href="uip-nd6.c.html#106">nbr</a>-&gt;<a href="uip-ds6-nbr.h.html#114">reachable</a> = nbr_data.<a href="uip-ds6-nbr.h.html#114">reachable</a>;</div><div id="683" class="line hit">  683           <a href="uip-nd6.c.html#106">nbr</a>-&gt;<a href="uip-ds6-nbr.h.html#115">sendns</a> = nbr_data.<a href="uip-ds6-nbr.h.html#115">sendns</a>;</div><div id="684" class="line hit">  684           <a href="uip-nd6.c.html#106">nbr</a>-&gt;<a href="uip-ds6-nbr.h.html#116">nscount</a> = nbr_data.<a href="uip-ds6-nbr.h.html#116">nscount</a>;</div><div id="685" class="line hit">  685         }</div><div id="686" class="line hit">  686         <a href="uip-nd6.c.html#106">nbr</a>-&gt;<a href="uip-ds6-nbr.h.html#111">isrouter</a> = 0;</div><div id="687" class="line hit">  687       }</div><div id="688" class="line none">  688 #if UIP_CONF_IPV6_CHECKS</div><div id="689" class="line hit">  689     }</div><div id="690" class="line none">  690 #endif /*UIP_CONF_IPV6_CHECKS */</div><div id="691" class="line none">  691   }</div><div id="692" class="line none">  692 </div><div id="693" class="line none">  693   /* Schedule a sollicited RA */</div><div id="694" class="line hit">  694   <a href="uip-ds6.h.html#370">uip_ds6_send_ra_sollicited</a>();</div><div id="695" class="line none">  695 </div><div id="696" class="line none">  696 discard:</div><div id="697" class="line hit">  697   <a href="uipbuf.c.html#44">uipbuf_clear</a>();</div><div id="698" class="line none">  698   return;</div><div id="699" class="line hit">  699 }</div><div id="700" class="line none">  700 </div><div id="701" class="line none">  701 /*---------------------------------------------------------------------------*/</div><div id="702" class="line none">  702 void</div><div id="703" class="line none">  703 <a href="uip-nd6.c.html#703">uip_nd6_ra_output</a>(const <a href="uip.h.html#105">uip_ipaddr_t</a> * <a href="uip.h.html#1427">dest</a>)</div><div id="704" class="line none">  704 {</div><div id="705" class="line none">  705 </div><div id="706" class="line none">  706   <a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1532">vtc</a> = 0x60;</div><div id="707" class="line none">  707   <a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1533">tcflow</a> = 0;</div><div id="708" class="line none">  708   <a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1534">flow</a> = 0;</div><div id="709" class="line none">  709   <a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1536">proto</a> = <a href="uip.h.html#1684">UIP_PROTO_ICMP6</a>;</div><div id="710" class="line none">  710   <a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1313">ttl</a> = <a href="uip-nd6.h.html#55">UIP_ND6_HOP_LIMIT</a>;</div><div id="711" class="line none">  711 </div><div id="712" class="line none">  712   if(<a href="uip.h.html#1427">dest</a> == NULL) {</div><div id="713" class="line none">  713     <a href="uip.h.html#1800">uip_create_linklocal_allnodes_mcast</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">destipaddr</a>);</div><div id="714" class="line none">  714   } else {</div><div id="715" class="line none">  715     /* For sollicited RA */</div><div id="716" class="line none">  716     <a href="uip.h.html#969">uip_ipaddr_copy</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">destipaddr</a>, <a href="uip.h.html#1427">dest</a>);</div><div id="717" class="line none">  717   }</div><div id="718" class="line none">  718   <a href="uip-ds6.h.html#365">uip_ds6_select_src</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">srcipaddr</a>, &amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">destipaddr</a>);</div><div id="719" class="line none">  719 </div><div id="720" class="line none">  720   <a href="uip.h.html#77">UIP_ICMP_BUF</a>-&gt;<a href="uip-ds6.h.html#209">type</a> = <a href="uip-icmp6.h.html#61">ICMP6_RA</a>;</div><div id="721" class="line none">  721   <a href="uip.h.html#77">UIP_ICMP_BUF</a>-&gt;<a href="uip-icmp6.h.html#183">icode</a> = 0;</div><div id="722" class="line none">  722 </div><div id="723" class="line none">  723   <a href="uip-nd6.c.html#91">UIP_ND6_RA_BUF</a>-&gt;<a href="uip-nd6.h.html#299">cur_ttl</a> = <a href="uip-ds6.h.html#257">uip_ds6_if</a>.<a href="uip-ds6.h.html#245">cur_hop_limit</a>;</div><div id="724" class="line none">  724 </div><div id="725" class="line none">  725   <a href="uip-nd6.c.html#91">UIP_ND6_RA_BUF</a>-&gt;<a href="uip-nd6.h.html#300">flags_reserved</a> =</div><div id="726" class="line none">  726     (<a href="uip-nd6.h.html#120">UIP_ND6_M_FLAG</a> &lt;&lt; 7) | (<a href="uip-nd6.h.html#121">UIP_ND6_O_FLAG</a> &lt;&lt; 6);</div><div id="727" class="line none">  727 </div><div id="728" class="line none">  728   <a href="uip-nd6.c.html#91">UIP_ND6_RA_BUF</a>-&gt;<a href="uip-nd6.h.html#301">router_lifetime</a> = <a href="uip.h.html#1175">uip_htons</a>(<a href="uip-nd6.h.html#123">UIP_ND6_ROUTER_LIFETIME</a>);</div><div id="729" class="line none">  729   <a href="uip-nd6.c.html#91">UIP_ND6_RA_BUF</a>-&gt;<a href="uip-ds6.h.html#234">reachable_time</a> = 0;</div><div id="730" class="line none">  730   <a href="uip-nd6.c.html#91">UIP_ND6_RA_BUF</a>-&gt;<a href="uip-ds6.h.html#235">retrans_timer</a> = 0;</div><div id="731" class="line none">  731 </div><div id="732" class="line none">  732   <a href="../../../cbmc/proofs/net/ipv6/rs_input/rsi_harness.c.html#20">uip_len</a> = <a href="uip.h.html#56">UIP_IPH_LEN</a> + <a href="uip.h.html#61">UIP_ICMPH_LEN</a> + <a href="uip-nd6.h.html#215">UIP_ND6_RA_LEN</a>;</div><div id="733" class="line none">  733   <a href="uip-nd6.c.html#104">nd6_opt_offset</a> = <a href="uip-nd6.h.html#215">UIP_ND6_RA_LEN</a>;</div><div id="734" class="line none">  734 </div><div id="735" class="line none">  735 </div><div id="736" class="line none">  736   /* Prefix list */</div><div id="737" class="line none">  737   for(<a href="uip-nd6.c.html#119">prefix</a> = <a href="uip-ds6.h.html#261">uip_ds6_prefix_list</a>;</div><div id="738" class="line none">  738       <a href="uip-nd6.c.html#119">prefix</a> &lt; <a href="uip-ds6.h.html#261">uip_ds6_prefix_list</a> + <a href="uip-ds6.h.html#110">UIP_DS6_PREFIX_NB</a>; <a href="uip-nd6.c.html#119">prefix</a>++) {</div><div id="739" class="line none">  739     if((<a href="uip-nd6.c.html#119">prefix</a>-&gt;<a href="uip-ds6.h.html#187">isused</a>) &amp;&amp; (<a href="uip-nd6.c.html#119">prefix</a>-&gt;<a href="uip-ds6.h.html#189">advertise</a>)) {</div><div id="740" class="line none">  740       <a href="uip-nd6.c.html#98">ND6_OPT_PREFIX_BUF</a>(<a href="uip-nd6.c.html#104">nd6_opt_offset</a>)-&gt;<a href="uip-ds6.h.html#209">type</a> = <a href="uip-nd6.h.html#198">UIP_ND6_OPT_PREFIX_INFO</a>;</div><div id="741" class="line none">  741       <a href="uip-nd6.c.html#98">ND6_OPT_PREFIX_BUF</a>(<a href="uip-nd6.c.html#104">nd6_opt_offset</a>)-&gt;<a href="uip-nd6.h.html#326">len</a> = <a href="uip-nd6.h.html#223">UIP_ND6_OPT_PREFIX_INFO_LEN</a> / 8;</div><div id="742" class="line none">  742       <a href="uip-nd6.c.html#98">ND6_OPT_PREFIX_BUF</a>(<a href="uip-nd6.c.html#104">nd6_opt_offset</a>)-&gt;<a href="uip-nd6.h.html#333">preflen</a> = <a href="uip-nd6.c.html#119">prefix</a>-&gt;<a href="uip-ds6.h.html#188">length</a>;</div><div id="743" class="line none">  743       <a href="uip-nd6.c.html#98">ND6_OPT_PREFIX_BUF</a>(<a href="uip-nd6.c.html#104">nd6_opt_offset</a>)-&gt;<a href="uip-nd6.h.html#334">flagsreserved1</a> = <a href="uip-nd6.c.html#119">prefix</a>-&gt;<a href="uip-ds6.h.html#190">l_a_reserved</a>;</div><div id="744" class="line none">  744       <a href="uip-nd6.c.html#98">ND6_OPT_PREFIX_BUF</a>(<a href="uip-nd6.c.html#104">nd6_opt_offset</a>)-&gt;<a href="uip-nd6.h.html#335">validlt</a> = <a href="uip.h.html#1182">uip_htonl</a>(<a href="uip-nd6.c.html#119">prefix</a>-&gt;<a href="uip-ds6.h.html#191">vlifetime</a>);</div><div id="745" class="line none">  745       <a href="uip-nd6.c.html#98">ND6_OPT_PREFIX_BUF</a>(<a href="uip-nd6.c.html#104">nd6_opt_offset</a>)-&gt;<a href="uip-nd6.h.html#336">preferredlt</a> = <a href="uip.h.html#1182">uip_htonl</a>(<a href="uip-nd6.c.html#119">prefix</a>-&gt;<a href="uip-ds6.h.html#192">plifetime</a>);</div><div id="746" class="line none">  746       <a href="uip-nd6.c.html#98">ND6_OPT_PREFIX_BUF</a>(<a href="uip-nd6.c.html#104">nd6_opt_offset</a>)-&gt;<a href="uip-nd6.h.html#337">reserved2</a> = 0;</div><div id="747" class="line none">  747       <a href="uip.h.html#969">uip_ipaddr_copy</a>(&amp;(<a href="uip-nd6.c.html#98">ND6_OPT_PREFIX_BUF</a>(<a href="uip-nd6.c.html#104">nd6_opt_offset</a>)-&gt;<a href="uip-nd6.c.html#119">prefix</a>), &amp;(<a href="uip-nd6.c.html#119">prefix</a>-&gt;<a href="uip-ds6-nbr.h.html#110">ipaddr</a>));</div><div id="748" class="line none">  748       <a href="uip-nd6.c.html#104">nd6_opt_offset</a> += <a href="uip-nd6.h.html#223">UIP_ND6_OPT_PREFIX_INFO_LEN</a>;</div><div id="749" class="line none">  749       <a href="../../../cbmc/proofs/net/ipv6/rs_input/rsi_harness.c.html#20">uip_len</a> += <a href="uip-nd6.h.html#223">UIP_ND6_OPT_PREFIX_INFO_LEN</a>;</div><div id="750" class="line none">  750     }</div><div id="751" class="line none">  751   }</div><div id="752" class="line none">  752 </div><div id="753" class="line none">  753   /* Source link-layer option */</div><div id="754" class="line none">  754   <a href="uip-nd6.c.html#139">create_llao</a>((uint8_t *)<a href="uip-nd6.c.html#97">ND6_OPT_HDR_BUF</a>(<a href="uip-nd6.c.html#104">nd6_opt_offset</a>), <a href="uip-nd6.h.html#196">UIP_ND6_OPT_SLLAO</a>);</div><div id="755" class="line none">  755 </div><div id="756" class="line none">  756   <a href="../../../cbmc/proofs/net/ipv6/rs_input/rsi_harness.c.html#20">uip_len</a> += <a href="uip-nd6.h.html#235">UIP_ND6_OPT_LLAO_LEN</a>;</div><div id="757" class="line none">  757   <a href="uip-nd6.c.html#104">nd6_opt_offset</a> += <a href="uip-nd6.h.html#235">UIP_ND6_OPT_LLAO_LEN</a>;</div><div id="758" class="line none">  758 </div><div id="759" class="line none">  759   /* MTU */</div><div id="760" class="line none">  760   <a href="uip-nd6.c.html#99">ND6_OPT_MTU_BUF</a>(<a href="uip-nd6.c.html#104">nd6_opt_offset</a>)-&gt;<a href="uip-ds6.h.html#209">type</a> = <a href="uip-nd6.h.html#200">UIP_ND6_OPT_MTU</a>;</div><div id="761" class="line none">  761   <a href="uip-nd6.c.html#99">ND6_OPT_MTU_BUF</a>(<a href="uip-nd6.c.html#104">nd6_opt_offset</a>)-&gt;<a href="uip-nd6.h.html#326">len</a> = <a href="uip-nd6.h.html#224">UIP_ND6_OPT_MTU_LEN</a> &gt;&gt; 3;</div><div id="762" class="line none">  762   <a href="uip-nd6.c.html#99">ND6_OPT_MTU_BUF</a>(<a href="uip-nd6.c.html#104">nd6_opt_offset</a>)-&gt;<a href="uip-nd6.h.html#269">reserved</a> = 0;</div><div id="763" class="line none">  763   <a href="uip-nd6.c.html#99">ND6_OPT_MTU_BUF</a>(<a href="uip-nd6.c.html#104">nd6_opt_offset</a>)-&gt;<a href="uip-nd6.h.html#346">mtu</a> = <a href="uip.h.html#1182">uip_htonl</a>(1500);</div><div id="764" class="line none">  764 </div><div id="765" class="line none">  765   <a href="../../../cbmc/proofs/net/ipv6/rs_input/rsi_harness.c.html#20">uip_len</a> += <a href="uip-nd6.h.html#224">UIP_ND6_OPT_MTU_LEN</a>;</div><div id="766" class="line none">  766   <a href="uip-nd6.c.html#104">nd6_opt_offset</a> += <a href="uip-nd6.h.html#224">UIP_ND6_OPT_MTU_LEN</a>;</div><div id="767" class="line none">  767 </div><div id="768" class="line none">  768 #if <a href="uip-nd6.h.html#180">UIP_ND6_RA_RDNSS</a></div><div id="769" class="line none">  769   if(uip_nameserver_count() &gt; 0) {</div><div id="770" class="line none">  770     uint8_t i = 0;</div><div id="771" class="line none">  771     <a href="uip.h.html#105">uip_ipaddr_t</a> *<a href="uip-nd6.h.html#355">ip</a> = &amp;<a href="uip-nd6.c.html#100">ND6_OPT_RDNSS_BUF</a>(<a href="uip-nd6.c.html#104">nd6_opt_offset</a>)-&gt;<a href="uip-nd6.h.html#355">ip</a>;</div><div id="772" class="line none">  772     <a href="uip.h.html#105">uip_ipaddr_t</a> *dns = NULL;</div><div id="773" class="line none">  773     <a href="uip-nd6.c.html#100">ND6_OPT_RDNSS_BUF</a>(<a href="uip-nd6.c.html#104">nd6_opt_offset</a>)-&gt;<a href="uip-ds6.h.html#209">type</a> = <a href="uip-nd6.h.html#201">UIP_ND6_OPT_RDNSS</a>;</div><div id="774" class="line none">  774     <a href="uip-nd6.c.html#100">ND6_OPT_RDNSS_BUF</a>(<a href="uip-nd6.c.html#104">nd6_opt_offset</a>)-&gt;<a href="uip-nd6.h.html#269">reserved</a> = 0;</div><div id="775" class="line none">  775     <a href="uip-nd6.c.html#100">ND6_OPT_RDNSS_BUF</a>(<a href="uip-nd6.c.html#104">nd6_opt_offset</a>)-&gt;<a href="uip-nd6.h.html#354">lifetime</a> = uip_nameserver_next_expiration();</div><div id="776" class="line none">  776     if(<a href="uip-nd6.c.html#100">ND6_OPT_RDNSS_BUF</a>(<a href="uip-nd6.c.html#104">nd6_opt_offset</a>)-&gt;<a href="uip-nd6.h.html#354">lifetime</a> != UIP_NAMESERVER_INFINITE_LIFETIME) {</div><div id="777" class="line none">  777       <a href="uip-nd6.c.html#100">ND6_OPT_RDNSS_BUF</a>(<a href="uip-nd6.c.html#104">nd6_opt_offset</a>)-&gt;<a href="uip-nd6.h.html#354">lifetime</a> -= clock_seconds();</div><div id="778" class="line none">  778     }</div><div id="779" class="line none">  779     while((dns = uip_nameserver_get(i)) != NULL) {</div><div id="780" class="line none">  780       <a href="uip.h.html#969">uip_ipaddr_copy</a>(<a href="uip-nd6.h.html#355">ip</a>++, dns);</div><div id="781" class="line none">  781       i++;</div><div id="782" class="line none">  782     }</div><div id="783" class="line none">  783     <a href="uip-nd6.c.html#100">ND6_OPT_RDNSS_BUF</a>(<a href="uip-nd6.c.html#104">nd6_opt_offset</a>)-&gt;<a href="uip-nd6.h.html#326">len</a> = <a href="uip-nd6.h.html#225">UIP_ND6_OPT_RDNSS_LEN</a> + (i &lt;&lt; 1);</div><div id="784" class="line none">  784     <a href="../../sys/log.h.html#200">LOG_INFO</a>("%d nameservers reported\n", i);</div><div id="785" class="line none">  785     <a href="../../../cbmc/proofs/net/ipv6/rs_input/rsi_harness.c.html#20">uip_len</a> += <a href="uip-nd6.c.html#100">ND6_OPT_RDNSS_BUF</a>(<a href="uip-nd6.c.html#104">nd6_opt_offset</a>)-&gt;<a href="uip-nd6.h.html#326">len</a> &lt;&lt; 3;</div><div id="786" class="line none">  786     <a href="uip-nd6.c.html#104">nd6_opt_offset</a> += <a href="uip-nd6.c.html#100">ND6_OPT_RDNSS_BUF</a>(<a href="uip-nd6.c.html#104">nd6_opt_offset</a>)-&gt;<a href="uip-nd6.h.html#326">len</a> &lt;&lt; 3;</div><div id="787" class="line none">  787   }</div><div id="788" class="line none">  788 #endif /* UIP_ND6_RA_RDNSS */</div><div id="789" class="line none">  789 </div><div id="790" class="line none">  790   <a href="uipbuf.c.html#76">uipbuf_set_len_field</a>(<a href="uip.h.html#71">UIP_IP_BUF</a>, <a href="../../../cbmc/proofs/net/ipv6/rs_input/rsi_harness.c.html#20">uip_len</a> - <a href="uip.h.html#56">UIP_IPH_LEN</a>);</div><div id="791" class="line none">  791 </div><div id="792" class="line none">  792   /*ICMP checksum */</div><div id="793" class="line none">  793   <a href="uip.h.html#77">UIP_ICMP_BUF</a>-&gt;<a href="uip.h.html#1652">icmpchksum</a> = 0;</div><div id="794" class="line none">  794   <a href="uip.h.html#77">UIP_ICMP_BUF</a>-&gt;<a href="uip.h.html#1652">icmpchksum</a> = ~<a href="uip.h.html#2012">uip_icmp6chksum</a>();</div><div id="795" class="line none">  795 </div><div id="796" class="line none">  796   <a href="uip.h.html#1349">UIP_STAT</a>(++uip_stat.<a href="uip.h.html#1413">nd6</a>.<a href="uip.h.html#1362">sent</a>);</div><div id="797" class="line none">  797   <a href="../../sys/log.h.html#200">LOG_INFO</a>("Sending RA to ");</div><div id="798" class="line none">  798   <a href="../../sys/log.h.html#218">LOG_INFO_6ADDR</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">destipaddr</a>);</div><div id="799" class="line none">  799   <a href="../../sys/log.h.html#206">LOG_INFO_</a>(" from ");</div><div id="800" class="line none">  800   <a href="../../sys/log.h.html#218">LOG_INFO_6ADDR</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">srcipaddr</a>);</div><div id="801" class="line none">  801   <a href="../../sys/log.h.html#206">LOG_INFO_</a>("\n");</div><div id="802" class="line none">  802   return;</div><div id="803" class="line none">  803 }</div><div id="804" class="line none">  804 #endif /* UIP_ND6_SEND_RA */</div><div id="805" class="line none">  805 #endif /* UIP_CONF_ROUTER */</div><div id="806" class="line none">  806 </div><div id="807" class="line none">  807 #if !UIP_CONF_ROUTER</div><div id="808" class="line none">  808 /*---------------------------------------------------------------------------*/</div><div id="809" class="line none">  809 void</div><div id="810" class="line none">  810 <a href="uip-nd6.c.html#810">uip_nd6_rs_output</a>(void)</div><div id="811" class="line none">  811 {</div><div id="812" class="line none">  812   <a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1532">vtc</a> = 0x60;</div><div id="813" class="line none">  813   <a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1533">tcflow</a> = 0;</div><div id="814" class="line none">  814   <a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1534">flow</a> = 0;</div><div id="815" class="line none">  815   <a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1536">proto</a> = <a href="uip.h.html#1684">UIP_PROTO_ICMP6</a>;</div><div id="816" class="line none">  816   <a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1313">ttl</a> = <a href="uip-nd6.h.html#55">UIP_ND6_HOP_LIMIT</a>;</div><div id="817" class="line none">  817   <a href="uip.h.html#1803">uip_create_linklocal_allrouters_mcast</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">destipaddr</a>);</div><div id="818" class="line none">  818   <a href="uip-ds6.h.html#365">uip_ds6_select_src</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">srcipaddr</a>, &amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">destipaddr</a>);</div><div id="819" class="line none">  819   <a href="uip.h.html#77">UIP_ICMP_BUF</a>-&gt;<a href="uip-ds6.h.html#209">type</a> = <a href="uip-icmp6.h.html#60">ICMP6_RS</a>;</div><div id="820" class="line none">  820   <a href="uip.h.html#77">UIP_ICMP_BUF</a>-&gt;<a href="uip-icmp6.h.html#183">icode</a> = 0;</div><div id="821" class="line none">  821 </div><div id="822" class="line none">  822   if(<a href="uip.h.html#1751">uip_is_addr_unspecified</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">srcipaddr</a>)) {</div><div id="823" class="line none">  823     <a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip-nd6.h.html#326">len</a>[1] = <a href="uip.h.html#61">UIP_ICMPH_LEN</a> + <a href="uip-nd6.h.html#216">UIP_ND6_RS_LEN</a>;</div><div id="824" class="line none">  824     <a href="../../../cbmc/proofs/net/ipv6/rs_input/rsi_harness.c.html#20">uip_len</a> = <a href="uip.h.html#66">uip_l3_icmp_hdr_len</a> + <a href="uip-nd6.h.html#216">UIP_ND6_RS_LEN</a>;</div><div id="825" class="line none">  825   } else {</div><div id="826" class="line none">  826     <a href="../../../cbmc/proofs/net/ipv6/rs_input/rsi_harness.c.html#20">uip_len</a> = <a href="uip.h.html#66">uip_l3_icmp_hdr_len</a> + <a href="uip-nd6.h.html#216">UIP_ND6_RS_LEN</a> + <a href="uip-nd6.h.html#235">UIP_ND6_OPT_LLAO_LEN</a>;</div><div id="827" class="line none">  827     <a href="uipbuf.c.html#76">uipbuf_set_len_field</a>(<a href="uip.h.html#71">UIP_IP_BUF</a>, <a href="uip.h.html#61">UIP_ICMPH_LEN</a> + <a href="uip-nd6.h.html#216">UIP_ND6_RS_LEN</a> + <a href="uip-nd6.h.html#235">UIP_ND6_OPT_LLAO_LEN</a>);</div><div id="828" class="line none">  828 </div><div id="829" class="line none">  829     <a href="uip-nd6.c.html#139">create_llao</a>(&amp;<a href="uip.h.html#465">uip_buf</a>[<a href="uip.h.html#66">uip_l3_icmp_hdr_len</a> + <a href="uip-nd6.h.html#216">UIP_ND6_RS_LEN</a>],</div><div id="830" class="line none">  830                 <a href="uip-nd6.h.html#196">UIP_ND6_OPT_SLLAO</a>);</div><div id="831" class="line none">  831   }</div><div id="832" class="line none">  832 </div><div id="833" class="line none">  833   <a href="uip.h.html#77">UIP_ICMP_BUF</a>-&gt;<a href="uip.h.html#1652">icmpchksum</a> = 0;</div><div id="834" class="line none">  834   <a href="uip.h.html#77">UIP_ICMP_BUF</a>-&gt;<a href="uip.h.html#1652">icmpchksum</a> = ~<a href="uip.h.html#2012">uip_icmp6chksum</a>();</div><div id="835" class="line none">  835 </div><div id="836" class="line none">  836   <a href="uip.h.html#1349">UIP_STAT</a>(++uip_stat.<a href="uip.h.html#1413">nd6</a>.<a href="uip.h.html#1362">sent</a>);</div><div id="837" class="line none">  837   <a href="../../sys/log.h.html#200">LOG_INFO</a>("Sending RS to ");</div><div id="838" class="line none">  838   <a href="../../sys/log.h.html#218">LOG_INFO_6ADDR</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">destipaddr</a>);</div><div id="839" class="line none">  839   <a href="../../sys/log.h.html#206">LOG_INFO_</a>(" from ");</div><div id="840" class="line none">  840   <a href="../../sys/log.h.html#218">LOG_INFO_6ADDR</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">srcipaddr</a>);</div><div id="841" class="line none">  841   <a href="../../sys/log.h.html#206">LOG_INFO_</a>("\n");</div><div id="842" class="line none">  842   return;</div><div id="843" class="line none">  843 }</div><div id="844" class="line none">  844 /*---------------------------------------------------------------------------*/</div><div id="845" class="line none">  845 /**</div><div id="846" class="line none">  846  * Process a Router Advertisement</div><div id="847" class="line none">  847  *</div><div id="848" class="line none">  848  * - Possible actions when receiving a RA: add router to router list,</div><div id="849" class="line none">  849  *   recalculate reachable time, update link hop limit, update retrans timer.</div><div id="850" class="line none">  850  * - If MTU option: update MTU.</div><div id="851" class="line none">  851  * - If SLLAO option: update entry in neighbor cache</div><div id="852" class="line none">  852  * - If prefix option: start autoconf, add prefix to prefix list</div><div id="853" class="line none">  853  */</div><div id="854" class="line none">  854 void</div><div id="855" class="line none">  855 <a href="uip-nd6.c.html#855">ra_input</a>(void)</div><div id="856" class="line none">  856 {</div><div id="857" class="line none">  857   <a href="uip.h.html#138">uip_lladdr_t</a> lladdr_aligned;</div><div id="858" class="line none">  858 </div><div id="859" class="line none">  859   <a href="../../sys/log.h.html#200">LOG_INFO</a>("Received RA from ");</div><div id="860" class="line none">  860   <a href="../../sys/log.h.html#218">LOG_INFO_6ADDR</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">srcipaddr</a>);</div><div id="861" class="line none">  861   <a href="../../sys/log.h.html#206">LOG_INFO_</a>(" to ");</div><div id="862" class="line none">  862   <a href="../../sys/log.h.html#218">LOG_INFO_6ADDR</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">destipaddr</a>);</div><div id="863" class="line none">  863   <a href="../../sys/log.h.html#206">LOG_INFO_</a>("\n");</div><div id="864" class="line none">  864   <a href="uip.h.html#1349">UIP_STAT</a>(++uip_stat.<a href="uip.h.html#1413">nd6</a>.<a href="uip.h.html#1361">recv</a>);</div><div id="865" class="line none">  865 </div><div id="866" class="line none">  866 #if UIP_CONF_IPV6_CHECKS</div><div id="867" class="line none">  867   if((<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1313">ttl</a> != <a href="uip-nd6.h.html#55">UIP_ND6_HOP_LIMIT</a>) ||</div><div id="868" class="line none">  868      (!<a href="uip.h.html#1792">uip_is_addr_linklocal</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">srcipaddr</a>)) ||</div><div id="869" class="line none">  869      (<a href="uip.h.html#77">UIP_ICMP_BUF</a>-&gt;<a href="uip-icmp6.h.html#183">icode</a> != 0)) {</div><div id="870" class="line none">  870     <a href="../../sys/log.h.html#198">LOG_ERR</a>("RA received is bad");</div><div id="871" class="line none">  871     goto discard;</div><div id="872" class="line none">  872   }</div><div id="873" class="line none">  873 #endif /*UIP_CONF_IPV6_CHECKS */</div><div id="874" class="line none">  874 </div><div id="875" class="line none">  875   if(<a href="uip-nd6.c.html#91">UIP_ND6_RA_BUF</a>-&gt;<a href="uip-nd6.h.html#299">cur_ttl</a> != 0) {</div><div id="876" class="line none">  876     <a href="uip-ds6.h.html#257">uip_ds6_if</a>.<a href="uip-ds6.h.html#245">cur_hop_limit</a> = <a href="uip-nd6.c.html#91">UIP_ND6_RA_BUF</a>-&gt;<a href="uip-nd6.h.html#299">cur_ttl</a>;</div><div id="877" class="line none">  877     <a href="../../sys/log.h.html#200">LOG_INFO</a>("uip_ds6_if.cur_hop_limit %u\n", <a href="uip-ds6.h.html#257">uip_ds6_if</a>.<a href="uip-ds6.h.html#245">cur_hop_limit</a>);</div><div id="878" class="line none">  878   }</div><div id="879" class="line none">  879 </div><div id="880" class="line none">  880   if(<a href="uip-nd6.c.html#91">UIP_ND6_RA_BUF</a>-&gt;<a href="uip-ds6.h.html#234">reachable_time</a> != 0) {</div><div id="881" class="line none">  881     if(<a href="uip-ds6.h.html#257">uip_ds6_if</a>.<a href="uip-ds6.h.html#233">base_reachable_time</a> !=</div><div id="882" class="line none">  882        <a href="uip.h.html#1185">uip_ntohl</a>(<a href="uip-nd6.c.html#91">UIP_ND6_RA_BUF</a>-&gt;<a href="uip-ds6.h.html#234">reachable_time</a>)) {</div><div id="883" class="line none">  883       <a href="uip-ds6.h.html#257">uip_ds6_if</a>.<a href="uip-ds6.h.html#233">base_reachable_time</a> = <a href="uip.h.html#1185">uip_ntohl</a>(<a href="uip-nd6.c.html#91">UIP_ND6_RA_BUF</a>-&gt;<a href="uip-ds6.h.html#234">reachable_time</a>);</div><div id="884" class="line none">  884       <a href="uip-ds6.h.html#257">uip_ds6_if</a>.<a href="uip-ds6.h.html#234">reachable_time</a> = uip_ds6_compute_reachable_time();</div><div id="885" class="line none">  885     }</div><div id="886" class="line none">  886   }</div><div id="887" class="line none">  887   if(<a href="uip-nd6.c.html#91">UIP_ND6_RA_BUF</a>-&gt;<a href="uip-ds6.h.html#235">retrans_timer</a> != 0) {</div><div id="888" class="line none">  888     <a href="uip-ds6.h.html#257">uip_ds6_if</a>.<a href="uip-ds6.h.html#235">retrans_timer</a> = <a href="uip.h.html#1185">uip_ntohl</a>(<a href="uip-nd6.c.html#91">UIP_ND6_RA_BUF</a>-&gt;<a href="uip-ds6.h.html#235">retrans_timer</a>);</div><div id="889" class="line none">  889   }</div><div id="890" class="line none">  890 </div><div id="891" class="line none">  891   /* Options processing */</div><div id="892" class="line none">  892   <a href="uip-nd6.c.html#104">nd6_opt_offset</a> = <a href="uip-nd6.h.html#215">UIP_ND6_RA_LEN</a>;</div><div id="893" class="line none">  893   while(<a href="uip.h.html#66">uip_l3_icmp_hdr_len</a> + <a href="uip-nd6.c.html#104">nd6_opt_offset</a> &lt; <a href="../../../cbmc/proofs/net/ipv6/rs_input/rsi_harness.c.html#20">uip_len</a>) {</div><div id="894" class="line none">  894     if(<a href="uip-nd6.c.html#97">ND6_OPT_HDR_BUF</a>(<a href="uip-nd6.c.html#104">nd6_opt_offset</a>)-&gt;<a href="uip-nd6.h.html#326">len</a> == 0) {</div><div id="895" class="line none">  895       <a href="../../sys/log.h.html#198">LOG_ERR</a>("RA received is bad");</div><div id="896" class="line none">  896       goto discard;</div><div id="897" class="line none">  897     }</div><div id="898" class="line none">  898     switch (<a href="uip-nd6.c.html#97">ND6_OPT_HDR_BUF</a>(<a href="uip-nd6.c.html#104">nd6_opt_offset</a>)-&gt;<a href="uip-ds6.h.html#209">type</a>) {</div><div id="899" class="line none">  899     case <a href="uip-nd6.h.html#196">UIP_ND6_OPT_SLLAO</a>:</div><div id="900" class="line none">  900       <a href="../../sys/log.h.html#201">LOG_DBG</a>("Processing SLLAO option in RA\n");</div><div id="901" class="line none">  901       <a href="uip-nd6.c.html#105">nd6_opt_llao</a> = (uint8_t *) <a href="uip-nd6.c.html#97">ND6_OPT_HDR_BUF</a>(<a href="uip-nd6.c.html#104">nd6_opt_offset</a>);</div><div id="902" class="line none">  902       <a href="uip-nd6.c.html#106">nbr</a> = <a href="../../../cbmc/proofs/net/ipv6/rs_input/rsi_harness.c.html#23">uip_ds6_nbr_lookup</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">srcipaddr</a>);</div><div id="903" class="line none">  903       if(!<a href="uip-nd6.c.html#126">extract_lladdr_from_llao_aligned</a>(&amp;lladdr_aligned)) {</div><div id="904" class="line none">  904         /* failed to extract llao - discard packet */</div><div id="905" class="line none">  905         goto discard;</div><div id="906" class="line none">  906       }</div><div id="907" class="line none">  907       if(<a href="uip-nd6.c.html#106">nbr</a> == NULL) {</div><div id="908" class="line none">  908         <a href="uip-nd6.c.html#106">nbr</a> = <a href="../../../cbmc/proofs/net/ipv6/rs_input/rsi_harness.c.html#59">uip_ds6_nbr_add</a>(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">srcipaddr</a>, &amp;lladdr_aligned,</div><div id="909" class="line none">  909                               1, <a href="uip-ds6-nbr.h.html#66">NBR_STALE</a>, <a href="../nbr-table.h.html#48">NBR_TABLE_REASON_IPV6_ND</a>, NULL);</div><div id="910" class="line none">  910       } else {</div><div id="911" class="line none">  911         const <a href="uip.h.html#138">uip_lladdr_t</a> *<a href="../nbr-table.h.html#93">lladdr</a> = <a href="../../../cbmc/proofs/net/ipv6/rs_input/rsi_harness.c.html#83">uip_ds6_nbr_get_ll</a>(<a href="uip-nd6.c.html#106">nbr</a>);</div><div id="912" class="line none">  912         if(<a href="../nbr-table.h.html#93">lladdr</a> == NULL) {</div><div id="913" class="line none">  913           goto discard;</div><div id="914" class="line none">  914         }</div><div id="915" class="line none">  915         if(<a href="uip-nd6.c.html#106">nbr</a>-&gt;<a href="uip-ds6-nbr.h.html#112">state</a> == <a href="uip-ds6-nbr.h.html#64">NBR_INCOMPLETE</a>) {</div><div id="916" class="line none">  916           <a href="uip-nd6.c.html#106">nbr</a>-&gt;<a href="uip-ds6-nbr.h.html#112">state</a> = <a href="uip-ds6-nbr.h.html#66">NBR_STALE</a>;</div><div id="917" class="line none">  917         }</div><div id="918" class="line none">  918         if(memcmp(&amp;<a href="uip-nd6.c.html#105">nd6_opt_llao</a>[<a href="uip-nd6.h.html#209">UIP_ND6_OPT_DATA_OFFSET</a>],</div><div id="919" class="line none">  919                   <a href="../nbr-table.h.html#93">lladdr</a>, <a href="uip.h.html#145">UIP_LLADDR_LEN</a>) != 0) {</div><div id="920" class="line none">  920           /* change of link layer address */</div><div id="921" class="line none">  921           if(<a href="uip-ds6-nbr.h.html#173">uip_ds6_nbr_update_ll</a>(&amp;<a href="uip-nd6.c.html#106">nbr</a>,</div><div id="922" class="line none">  922                                    (const <a href="uip.h.html#138">uip_lladdr_t</a> *)&amp;lladdr_aligned) &lt; 0) {</div><div id="923" class="line none">  923             /* failed to update the lladdr */</div><div id="924" class="line none">  924             goto discard;</div><div id="925" class="line none">  925           }</div><div id="926" class="line none">  926           <a href="uip-nd6.c.html#106">nbr</a>-&gt;<a href="uip-ds6-nbr.h.html#112">state</a> = <a href="uip-ds6-nbr.h.html#66">NBR_STALE</a>;</div><div id="927" class="line none">  927         }</div><div id="928" class="line none">  928         <a href="uip-nd6.c.html#106">nbr</a>-&gt;<a href="uip-ds6-nbr.h.html#111">isrouter</a> = 1;</div><div id="929" class="line none">  929       }</div><div id="930" class="line none">  930       break;</div><div id="931" class="line none">  931     case <a href="uip-nd6.h.html#200">UIP_ND6_OPT_MTU</a>:</div><div id="932" class="line none">  932       <a href="../../sys/log.h.html#201">LOG_DBG</a>("Processing MTU option in RA\n");</div><div id="933" class="line none">  933       <a href="uip-ds6.h.html#257">uip_ds6_if</a>.<a href="uip-ds6.h.html#232">link_mtu</a> =</div><div id="934" class="line none">  934         <a href="uip.h.html#1185">uip_ntohl</a>(((<a href="uip-nd6.h.html#342">uip_nd6_opt_mtu</a> *) <a href="uip-nd6.c.html#97">ND6_OPT_HDR_BUF</a>(<a href="uip-nd6.c.html#104">nd6_opt_offset</a>))-&gt;<a href="uip-nd6.h.html#346">mtu</a>);</div><div id="935" class="line none">  935       break;</div><div id="936" class="line none">  936     case <a href="uip-nd6.h.html#198">UIP_ND6_OPT_PREFIX_INFO</a>:</div><div id="937" class="line none">  937       <a href="../../sys/log.h.html#201">LOG_DBG</a>("Processing PREFIX option in RA\n");</div><div id="938" class="line none">  938       <a href="uip-nd6.c.html#115">nd6_opt_prefix_info</a> = (<a href="uip-nd6.h.html#330">uip_nd6_opt_prefix_info</a> *) <a href="uip-nd6.c.html#97">ND6_OPT_HDR_BUF</a>(<a href="uip-nd6.c.html#104">nd6_opt_offset</a>);</div><div id="939" class="line none">  939       if((<a href="uip.h.html#1185">uip_ntohl</a>(<a href="uip-nd6.c.html#115">nd6_opt_prefix_info</a>-&gt;<a href="uip-nd6.h.html#335">validlt</a>) &gt;=</div><div id="940" class="line none">  940           <a href="uip.h.html#1185">uip_ntohl</a>(<a href="uip-nd6.c.html#115">nd6_opt_prefix_info</a>-&gt;<a href="uip-nd6.h.html#336">preferredlt</a>))</div><div id="941" class="line none">  941          &amp;&amp; (!<a href="uip.h.html#1792">uip_is_addr_linklocal</a>(&amp;<a href="uip-nd6.c.html#115">nd6_opt_prefix_info</a>-&gt;<a href="uip-nd6.c.html#119">prefix</a>))) {</div><div id="942" class="line none">  942         /* on-link flag related processing */</div><div id="943" class="line none">  943         if(<a href="uip-nd6.c.html#115">nd6_opt_prefix_info</a>-&gt;<a href="uip-nd6.h.html#334">flagsreserved1</a> &amp; <a href="uip-nd6.h.html#254">UIP_ND6_RA_FLAG_ONLINK</a>) {</div><div id="944" class="line none">  944           <a href="uip-nd6.c.html#119">prefix</a> =</div><div id="945" class="line none">  945             uip_ds6_prefix_lookup(&amp;<a href="uip-nd6.c.html#115">nd6_opt_prefix_info</a>-&gt;<a href="uip-nd6.c.html#119">prefix</a>,</div><div id="946" class="line none">  946                                   <a href="uip-nd6.c.html#115">nd6_opt_prefix_info</a>-&gt;<a href="uip-nd6.h.html#333">preflen</a>);</div><div id="947" class="line none">  947           if(<a href="uip-nd6.c.html#119">prefix</a> == NULL) {</div><div id="948" class="line none">  948             if(<a href="uip-nd6.c.html#115">nd6_opt_prefix_info</a>-&gt;<a href="uip-nd6.h.html#335">validlt</a> != 0) {</div><div id="949" class="line none">  949               if(<a href="uip-nd6.c.html#115">nd6_opt_prefix_info</a>-&gt;<a href="uip-nd6.h.html#335">validlt</a> != <a href="uip-nd6.h.html#57">UIP_ND6_INFINITE_LIFETIME</a>) {</div><div id="950" class="line none">  950                 <a href="uip-nd6.c.html#119">prefix</a> = uip_ds6_prefix_add(&amp;<a href="uip-nd6.c.html#115">nd6_opt_prefix_info</a>-&gt;<a href="uip-nd6.c.html#119">prefix</a>,</div><div id="951" class="line none">  951                                             <a href="uip-nd6.c.html#115">nd6_opt_prefix_info</a>-&gt;<a href="uip-nd6.h.html#333">preflen</a>,</div><div id="952" class="line none">  952                                             <a href="uip.h.html#1185">uip_ntohl</a>(<a href="uip-nd6.c.html#115">nd6_opt_prefix_info</a>-&gt;</div><div id="953" class="line none">  953                                                   <a href="uip-nd6.h.html#335">validlt</a>));</div><div id="954" class="line none">  954               } else {</div><div id="955" class="line none">  955                 <a href="uip-nd6.c.html#119">prefix</a> = uip_ds6_prefix_add(&amp;<a href="uip-nd6.c.html#115">nd6_opt_prefix_info</a>-&gt;<a href="uip-nd6.c.html#119">prefix</a>,</div><div id="956" class="line none">  956                                             <a href="uip-nd6.c.html#115">nd6_opt_prefix_info</a>-&gt;<a href="uip-nd6.h.html#333">preflen</a>, 0);</div><div id="957" class="line none">  957               }</div><div id="958" class="line none">  958             }</div><div id="959" class="line none">  959           } else {</div><div id="960" class="line none">  960             switch (<a href="uip-nd6.c.html#115">nd6_opt_prefix_info</a>-&gt;<a href="uip-nd6.h.html#335">validlt</a>) {</div><div id="961" class="line none">  961             case 0:</div><div id="962" class="line none">  962               uip_ds6_prefix_rm(<a href="uip-nd6.c.html#119">prefix</a>);</div><div id="963" class="line none">  963               break;</div><div id="964" class="line none">  964             case <a href="uip-nd6.h.html#57">UIP_ND6_INFINITE_LIFETIME</a>:</div><div id="965" class="line none">  965               <a href="uip-nd6.c.html#119">prefix</a>-&gt;<a href="uip-ds6.h.html#199">isinfinite</a> = 1;</div><div id="966" class="line none">  966               break;</div><div id="967" class="line none">  967             default:</div><div id="968" class="line none">  968               <a href="../../sys/log.h.html#201">LOG_DBG</a>("Updating timer of prefix ");</div><div id="969" class="line none">  969               <a href="../../sys/log.h.html#219">LOG_DBG_6ADDR</a>(&amp;<a href="uip-nd6.c.html#119">prefix</a>-&gt;<a href="uip-ds6-nbr.h.html#110">ipaddr</a>);</div><div id="970" class="line none">  970               <a href="../../sys/log.h.html#207">LOG_DBG_</a>(" new value %"PRIu32"\n", <a href="uip.h.html#1185">uip_ntohl</a>(<a href="uip-nd6.c.html#115">nd6_opt_prefix_info</a>-&gt;<a href="uip-nd6.h.html#335">validlt</a>));</div><div id="971" class="line none">  971               <a href="../../sys/stimer.h.html#100">stimer_set</a>(&amp;<a href="uip-nd6.c.html#119">prefix</a>-&gt;<a href="uip-ds6.h.html#191">vlifetime</a>,</div><div id="972" class="line none">  972                          <a href="uip.h.html#1185">uip_ntohl</a>(<a href="uip-nd6.c.html#115">nd6_opt_prefix_info</a>-&gt;<a href="uip-nd6.h.html#335">validlt</a>));</div><div id="973" class="line none">  973               <a href="uip-nd6.c.html#119">prefix</a>-&gt;<a href="uip-ds6.h.html#199">isinfinite</a> = 0;</div><div id="974" class="line none">  974               break;</div><div id="975" class="line none">  975             }</div><div id="976" class="line none">  976           }</div><div id="977" class="line none">  977         }</div><div id="978" class="line none">  978         /* End of on-link flag related processing */</div><div id="979" class="line none">  979         /* autonomous flag related processing */</div><div id="980" class="line none">  980         if((<a href="uip-nd6.c.html#115">nd6_opt_prefix_info</a>-&gt;<a href="uip-nd6.h.html#334">flagsreserved1</a> &amp; <a href="uip-nd6.h.html#255">UIP_ND6_RA_FLAG_AUTONOMOUS</a>)</div><div id="981" class="line none">  981            &amp;&amp; (<a href="uip-nd6.c.html#115">nd6_opt_prefix_info</a>-&gt;<a href="uip-nd6.h.html#335">validlt</a> != 0)</div><div id="982" class="line none">  982            &amp;&amp; (<a href="uip-nd6.c.html#115">nd6_opt_prefix_info</a>-&gt;<a href="uip-nd6.h.html#333">preflen</a> == UIP_DEFAULT_PREFIX_LEN)) {</div><div id="983" class="line none">  983 </div><div id="984" class="line none">  984           <a href="uip.h.html#969">uip_ipaddr_copy</a>(&amp;<a href="uip-ds6-nbr.h.html#110">ipaddr</a>, &amp;<a href="uip-nd6.c.html#115">nd6_opt_prefix_info</a>-&gt;<a href="uip-nd6.c.html#119">prefix</a>);</div><div id="985" class="line none">  985           uip_ds6_set_addr_iid(&amp;<a href="uip-ds6-nbr.h.html#110">ipaddr</a>, &amp;<a href="uip.h.html#1728">uip_lladdr</a>);</div><div id="986" class="line none">  986           <a href="uip-nd6.c.html#107">addr</a> = <a href="uip-ds6.h.html#324">uip_ds6_addr_lookup</a>(&amp;<a href="uip-ds6-nbr.h.html#110">ipaddr</a>);</div><div id="987" class="line none">  987           if((<a href="uip-nd6.c.html#107">addr</a> != NULL) &amp;&amp; (<a href="uip-nd6.c.html#107">addr</a>-&gt;<a href="uip-ds6.h.html#209">type</a> == <a href="uip-ds6.h.html#162">ADDR_AUTOCONF</a>)) {</div><div id="988" class="line none">  988             if(<a href="uip-nd6.c.html#115">nd6_opt_prefix_info</a>-&gt;<a href="uip-nd6.h.html#335">validlt</a> != <a href="uip-nd6.h.html#57">UIP_ND6_INFINITE_LIFETIME</a>) {</div><div id="989" class="line none">  989               /* The processing below is defined in RFC4862 section 5.5.3 e */</div><div id="990" class="line none">  990               if((<a href="uip.h.html#1185">uip_ntohl</a>(<a href="uip-nd6.c.html#115">nd6_opt_prefix_info</a>-&gt;<a href="uip-nd6.h.html#335">validlt</a>) &gt; 2 * 60 * 60) ||</div><div id="991" class="line none">  991                  (<a href="uip.h.html#1185">uip_ntohl</a>(<a href="uip-nd6.c.html#115">nd6_opt_prefix_info</a>-&gt;<a href="uip-nd6.h.html#335">validlt</a>) &gt;</div><div id="992" class="line none">  992                   <a href="../../sys/stimer.h.html#121">stimer_remaining</a>(&amp;<a href="uip-nd6.c.html#107">addr</a>-&gt;<a href="uip-ds6.h.html#191">vlifetime</a>))) {</div><div id="993" class="line none">  993                 <a href="../../sys/log.h.html#201">LOG_DBG</a>("Updating timer of address ");</div><div id="994" class="line none">  994                 <a href="../../sys/log.h.html#219">LOG_DBG_6ADDR</a>(&amp;<a href="uip-nd6.c.html#107">addr</a>-&gt;<a href="uip-ds6-nbr.h.html#110">ipaddr</a>);</div><div id="995" class="line none">  995                 <a href="../../sys/log.h.html#207">LOG_DBG_</a>(" new value %lu\n",</div><div id="996" class="line none">  996                        (unsigned long)<a href="uip.h.html#1185">uip_ntohl</a>(<a href="uip-nd6.c.html#115">nd6_opt_prefix_info</a>-&gt;<a href="uip-nd6.h.html#335">validlt</a>));</div><div id="997" class="line none">  997                 <a href="../../sys/stimer.h.html#100">stimer_set</a>(&amp;<a href="uip-nd6.c.html#107">addr</a>-&gt;<a href="uip-ds6.h.html#191">vlifetime</a>,</div><div id="998" class="line none">  998                            <a href="uip.h.html#1185">uip_ntohl</a>(<a href="uip-nd6.c.html#115">nd6_opt_prefix_info</a>-&gt;<a href="uip-nd6.h.html#335">validlt</a>));</div><div id="999" class="line none">  999               } else {</div><div id="1000" class="line none"> 1000                 <a href="../../sys/stimer.h.html#100">stimer_set</a>(&amp;<a href="uip-nd6.c.html#107">addr</a>-&gt;<a href="uip-ds6.h.html#191">vlifetime</a>, 2 * 60 * 60);</div><div id="1001" class="line none"> 1001                 <a href="../../sys/log.h.html#201">LOG_DBG</a>("Updating timer of address ");</div><div id="1002" class="line none"> 1002                 <a href="../../sys/log.h.html#219">LOG_DBG_6ADDR</a>(&amp;<a href="uip-nd6.c.html#107">addr</a>-&gt;<a href="uip-ds6-nbr.h.html#110">ipaddr</a>);</div><div id="1003" class="line none"> 1003                 <a href="../../sys/log.h.html#207">LOG_DBG_</a>(" new value %lu\n", (unsigned long)(2 * 60 * 60));</div><div id="1004" class="line none"> 1004               }</div><div id="1005" class="line none"> 1005               <a href="uip-nd6.c.html#107">addr</a>-&gt;<a href="uip-ds6.h.html#199">isinfinite</a> = 0;</div><div id="1006" class="line none"> 1006             } else {</div><div id="1007" class="line none"> 1007               <a href="uip-nd6.c.html#107">addr</a>-&gt;<a href="uip-ds6.h.html#199">isinfinite</a> = 1;</div><div id="1008" class="line none"> 1008             }</div><div id="1009" class="line none"> 1009           } else {</div><div id="1010" class="line none"> 1010             if(<a href="uip.h.html#1185">uip_ntohl</a>(<a href="uip-nd6.c.html#115">nd6_opt_prefix_info</a>-&gt;<a href="uip-nd6.h.html#335">validlt</a>) ==</div><div id="1011" class="line none"> 1011                <a href="uip-nd6.h.html#57">UIP_ND6_INFINITE_LIFETIME</a>) {</div><div id="1012" class="line none"> 1012               uip_ds6_addr_add(&amp;<a href="uip-ds6-nbr.h.html#110">ipaddr</a>, 0, <a href="uip-ds6.h.html#162">ADDR_AUTOCONF</a>);</div><div id="1013" class="line none"> 1013             } else {</div><div id="1014" class="line none"> 1014               uip_ds6_addr_add(&amp;<a href="uip-ds6-nbr.h.html#110">ipaddr</a>, <a href="uip.h.html#1185">uip_ntohl</a>(<a href="uip-nd6.c.html#115">nd6_opt_prefix_info</a>-&gt;<a href="uip-nd6.h.html#335">validlt</a>),</div><div id="1015" class="line none"> 1015                                <a href="uip-ds6.h.html#162">ADDR_AUTOCONF</a>);</div><div id="1016" class="line none"> 1016             }</div><div id="1017" class="line none"> 1017           }</div><div id="1018" class="line none"> 1018         }</div><div id="1019" class="line none"> 1019         /* End of autonomous flag related processing */</div><div id="1020" class="line none"> 1020       }</div><div id="1021" class="line none"> 1021       break;</div><div id="1022" class="line none"> 1022 #if <a href="uip-nd6.h.html#180">UIP_ND6_RA_RDNSS</a></div><div id="1023" class="line none"> 1023     case <a href="uip-nd6.h.html#201">UIP_ND6_OPT_RDNSS</a>:</div><div id="1024" class="line none"> 1024       <a href="../../sys/log.h.html#201">LOG_DBG</a>("Processing RDNSS option\n");</div><div id="1025" class="line none"> 1025       uint8_t naddr = (<a href="uip-nd6.c.html#100">ND6_OPT_RDNSS_BUF</a>(<a href="uip-nd6.c.html#104">nd6_opt_offset</a>)-&gt;<a href="uip-nd6.h.html#326">len</a> - 1) / 2;</div><div id="1026" class="line none"> 1026       <a href="uip.h.html#105">uip_ipaddr_t</a> *<a href="uip-nd6.h.html#355">ip</a> = (<a href="uip.h.html#105">uip_ipaddr_t</a> *)(&amp;<a href="uip-nd6.c.html#100">ND6_OPT_RDNSS_BUF</a>(<a href="uip-nd6.c.html#104">nd6_opt_offset</a>)-&gt;<a href="uip-nd6.h.html#355">ip</a>);</div><div id="1027" class="line none"> 1027       <a href="../../sys/log.h.html#201">LOG_DBG</a>("got %d nameservers\n", naddr);</div><div id="1028" class="line none"> 1028       while(naddr-- &gt; 0) {</div><div id="1029" class="line none"> 1029         <a href="../../sys/log.h.html#201">LOG_DBG</a>("nameserver: ");</div><div id="1030" class="line none"> 1030         <a href="../../sys/log.h.html#219">LOG_DBG_6ADDR</a>(<a href="uip-nd6.h.html#355">ip</a>);</div><div id="1031" class="line none"> 1031         <a href="../../sys/log.h.html#207">LOG_DBG_</a>(" lifetime: %"PRIx32"\n", <a href="uip.h.html#1185">uip_ntohl</a>(<a href="uip-nd6.c.html#100">ND6_OPT_RDNSS_BUF</a>(<a href="uip-nd6.c.html#104">nd6_opt_offset</a>)-&gt;<a href="uip-nd6.h.html#354">lifetime</a>));</div><div id="1032" class="line none"> 1032         uip_nameserver_update(<a href="uip-nd6.h.html#355">ip</a>, <a href="uip.h.html#1185">uip_ntohl</a>(<a href="uip-nd6.c.html#100">ND6_OPT_RDNSS_BUF</a>(<a href="uip-nd6.c.html#104">nd6_opt_offset</a>)-&gt;<a href="uip-nd6.h.html#354">lifetime</a>));</div><div id="1033" class="line none"> 1033         <a href="uip-nd6.h.html#355">ip</a>++;</div><div id="1034" class="line none"> 1034       }</div><div id="1035" class="line none"> 1035       break;</div><div id="1036" class="line none"> 1036 #endif /* UIP_ND6_RA_RDNSS */</div><div id="1037" class="line none"> 1037     default:</div><div id="1038" class="line none"> 1038       <a href="../../sys/log.h.html#198">LOG_ERR</a>("ND option not supported in RA\n");</div><div id="1039" class="line none"> 1039       break;</div><div id="1040" class="line none"> 1040     }</div><div id="1041" class="line none"> 1041     <a href="uip-nd6.c.html#104">nd6_opt_offset</a> += (<a href="uip-nd6.c.html#97">ND6_OPT_HDR_BUF</a>(<a href="uip-nd6.c.html#104">nd6_opt_offset</a>)-&gt;<a href="uip-nd6.h.html#326">len</a> &lt;&lt; 3);</div><div id="1042" class="line none"> 1042   }</div><div id="1043" class="line none"> 1043 </div><div id="1044" class="line none"> 1044   <a href="uip-nd6.c.html#111">defrt</a> = uip_ds6_defrt_lookup(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">srcipaddr</a>);</div><div id="1045" class="line none"> 1045   if(<a href="uip-nd6.c.html#91">UIP_ND6_RA_BUF</a>-&gt;<a href="uip-nd6.h.html#301">router_lifetime</a> != 0) {</div><div id="1046" class="line none"> 1046     if(<a href="uip-nd6.c.html#106">nbr</a> != NULL) {</div><div id="1047" class="line none"> 1047       <a href="uip-nd6.c.html#106">nbr</a>-&gt;<a href="uip-ds6-nbr.h.html#111">isrouter</a> = 1;</div><div id="1048" class="line none"> 1048     }</div><div id="1049" class="line none"> 1049     if(<a href="uip-nd6.c.html#111">defrt</a> == NULL) {</div><div id="1050" class="line none"> 1050       uip_ds6_defrt_add(&amp;<a href="uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="uip.h.html#1537">srcipaddr</a>,</div><div id="1051" class="line none"> 1051                         (unsigned</div><div id="1052" class="line none"> 1052                          long)(<a href="uip.h.html#1178">uip_ntohs</a>(<a href="uip-nd6.c.html#91">UIP_ND6_RA_BUF</a>-&gt;<a href="uip-nd6.h.html#301">router_lifetime</a>)));</div><div id="1053" class="line none"> 1053     } else {</div><div id="1054" class="line none"> 1054       <a href="../../sys/stimer.h.html#100">stimer_set</a>(&amp;(<a href="uip-nd6.c.html#111">defrt</a>-&gt;<a href="uip-nd6.h.html#354">lifetime</a>),</div><div id="1055" class="line none"> 1055                  (unsigned long)(<a href="uip.h.html#1178">uip_ntohs</a>(<a href="uip-nd6.c.html#91">UIP_ND6_RA_BUF</a>-&gt;<a href="uip-nd6.h.html#301">router_lifetime</a>)));</div><div id="1056" class="line none"> 1056     }</div><div id="1057" class="line none"> 1057   } else {</div><div id="1058" class="line none"> 1058     if(<a href="uip-nd6.c.html#111">defrt</a> != NULL) {</div><div id="1059" class="line none"> 1059       uip_ds6_defrt_rm(<a href="uip-nd6.c.html#111">defrt</a>);</div><div id="1060" class="line none"> 1060     }</div><div id="1061" class="line none"> 1061   }</div><div id="1062" class="line none"> 1062 </div><div id="1063" class="line none"> 1063 #if UIP_CONF_IPV6_QUEUE_PKT</div><div id="1064" class="line none"> 1064   /* If the nbr just became reachable (e.g. it was in NBR_INCOMPLETE state</div><div id="1065" class="line none"> 1065    * and we got a SLLAO), check if we had buffered a pkt for it */</div><div id="1066" class="line none"> 1066   /*  if((nbr != NULL) &amp;&amp; (nbr-&gt;queue_buf_len != 0)) {</div><div id="1067" class="line none"> 1067     uip_len = nbr-&gt;queue_buf_len;</div><div id="1068" class="line none"> 1068     memcpy(UIP_IP_BUF, nbr-&gt;queue_buf, uip_len);</div><div id="1069" class="line none"> 1069     nbr-&gt;queue_buf_len = 0;</div><div id="1070" class="line none"> 1070     return;</div><div id="1071" class="line none"> 1071     }*/</div><div id="1072" class="line none"> 1072   if(<a href="uip-nd6.c.html#106">nbr</a> != NULL &amp;&amp; uip_packetqueue_buflen(&amp;<a href="uip-nd6.c.html#106">nbr</a>-&gt;<a href="uip-ds6-nbr.h.html#119">packethandle</a>) != 0) {</div><div id="1073" class="line none"> 1073     <a href="../../../cbmc/proofs/net/ipv6/rs_input/rsi_harness.c.html#20">uip_len</a> = uip_packetqueue_buflen(&amp;<a href="uip-nd6.c.html#106">nbr</a>-&gt;<a href="uip-ds6-nbr.h.html#119">packethandle</a>);</div><div id="1074" class="line none"> 1074     memcpy(<a href="uip.h.html#71">UIP_IP_BUF</a>, uip_packetqueue_buf(&amp;<a href="uip-nd6.c.html#106">nbr</a>-&gt;<a href="uip-ds6-nbr.h.html#119">packethandle</a>), <a href="../../../cbmc/proofs/net/ipv6/rs_input/rsi_harness.c.html#20">uip_len</a>);</div><div id="1075" class="line none"> 1075     uip_packetqueue_free(&amp;<a href="uip-nd6.c.html#106">nbr</a>-&gt;<a href="uip-ds6-nbr.h.html#119">packethandle</a>);</div><div id="1076" class="line none"> 1076     return;</div><div id="1077" class="line none"> 1077   }</div><div id="1078" class="line none"> 1078 </div><div id="1079" class="line none"> 1079 #endif /*UIP_CONF_IPV6_QUEUE_PKT */</div><div id="1080" class="line none"> 1080 </div><div id="1081" class="line none"> 1081 discard:</div><div id="1082" class="line none"> 1082   <a href="uipbuf.c.html#44">uipbuf_clear</a>();</div><div id="1083" class="line none"> 1083   return;</div><div id="1084" class="line none"> 1084 }</div><div id="1085" class="line none"> 1085 #endif /* !UIP_CONF_ROUTER */</div><div id="1086" class="line none"> 1086 /*------------------------------------------------------------------*/</div><div id="1087" class="line none"> 1087 /* ICMPv6 input handlers */</div><div id="1088" class="line none"> 1088 #if <a href="uip-nd6.h.html#95">UIP_ND6_SEND_NA</a></div><div id="1089" class="line none"> 1089 <a href="uip-icmp6.h.html#202">UIP_ICMP6_HANDLER</a>(<a href="uip-nd6.c.html#1089">ns_input_handler</a>, <a href="uip-icmp6.h.html#62">ICMP6_NS</a>, <a href="uip-icmp6.h.html#189">UIP_ICMP6_HANDLER_CODE_ANY</a>,</div><div id="1090" class="line none"> 1090                   <a href="uip-nd6.c.html#173">ns_input</a>);</div><div id="1091" class="line none"> 1091 #endif</div><div id="1092" class="line none"> 1092 #if <a href="uip-nd6.h.html#90">UIP_ND6_SEND_NS</a></div><div id="1093" class="line none"> 1093 <a href="uip-icmp6.h.html#202">UIP_ICMP6_HANDLER</a>(na_input_handler, <a href="uip-icmp6.h.html#63">ICMP6_NA</a>, <a href="uip-icmp6.h.html#189">UIP_ICMP6_HANDLER_CODE_ANY</a>,</div><div id="1094" class="line none"> 1094                   <a href="uip-nd6.c.html#449">na_input</a>);</div><div id="1095" class="line none"> 1095 #endif</div><div id="1096" class="line none"> 1096 </div><div id="1097" class="line none"> 1097 #if UIP_CONF_ROUTER &amp;&amp; <a href="uip-nd6.h.html#85">UIP_ND6_SEND_RA</a></div><div id="1098" class="line none"> 1098 <a href="uip-icmp6.h.html#202">UIP_ICMP6_HANDLER</a>(<a href="uip-nd6.c.html#1098">rs_input_handler</a>, <a href="uip-icmp6.h.html#60">ICMP6_RS</a>, <a href="uip-icmp6.h.html#189">UIP_ICMP6_HANDLER_CODE_ANY</a>,</div><div id="1099" class="line none"> 1099                   <a href="uip-nd6.c.html#607">rs_input</a>);</div><div id="1100" class="line none"> 1100 #endif</div><div id="1101" class="line none"> 1101 </div><div id="1102" class="line none"> 1102 #if !UIP_CONF_ROUTER</div><div id="1103" class="line none"> 1103 <a href="uip-icmp6.h.html#202">UIP_ICMP6_HANDLER</a>(ra_input_handler, <a href="uip-icmp6.h.html#61">ICMP6_RA</a>, <a href="uip-icmp6.h.html#189">UIP_ICMP6_HANDLER_CODE_ANY</a>,</div><div id="1104" class="line none"> 1104                   <a href="uip-nd6.c.html#855">ra_input</a>);</div><div id="1105" class="line none"> 1105 #endif</div><div id="1106" class="line none"> 1106 /*---------------------------------------------------------------------------*/</div><div id="1107" class="line none"> 1107 void</div><div id="1108" class="line none"> 1108 <a href="uip-nd6.c.html#1108">uip_nd6_init</a>()</div><div id="1109" class="line none"> 1109 {</div><div id="1110" class="line none"> 1110 #if <a href="uip-nd6.h.html#95">UIP_ND6_SEND_NA</a></div><div id="1111" class="line none"> 1111   /* Only handle NSs if we are prepared to send out NAs */</div><div id="1112" class="line none"> 1112   <a href="uip-icmp6.h.html#231">uip_icmp6_register_input_handler</a>(&amp;<a href="uip-nd6.c.html#1089">ns_input_handler</a>);</div><div id="1113" class="line none"> 1113 #endif</div><div id="1114" class="line none"> 1114 </div><div id="1115" class="line none"> 1115 #if <a href="uip-nd6.h.html#90">UIP_ND6_SEND_NS</a></div><div id="1116" class="line none"> 1116   /*</div><div id="1117" class="line none"> 1117    * Only handle NAs if we are prepared to send out NSs. */</div><div id="1118" class="line none"> 1118   <a href="uip-icmp6.h.html#231">uip_icmp6_register_input_handler</a>(&amp;na_input_handler);</div><div id="1119" class="line none"> 1119 #endif</div><div id="1120" class="line none"> 1120 </div><div id="1121" class="line none"> 1121 #if UIP_CONF_ROUTER &amp;&amp; <a href="uip-nd6.h.html#85">UIP_ND6_SEND_RA</a></div><div id="1122" class="line none"> 1122   /* Only accept RS if we are a router and happy to send out RAs */</div><div id="1123" class="line none"> 1123   <a href="uip-icmp6.h.html#231">uip_icmp6_register_input_handler</a>(&amp;<a href="uip-nd6.c.html#1098">rs_input_handler</a>);</div><div id="1124" class="line none"> 1124 #endif</div><div id="1125" class="line none"> 1125 </div><div id="1126" class="line none"> 1126 #if !UIP_CONF_ROUTER</div><div id="1127" class="line none"> 1127   /* Only process RAs if we are not a router */</div><div id="1128" class="line none"> 1128   <a href="uip-icmp6.h.html#231">uip_icmp6_register_input_handler</a>(&amp;ra_input_handler);</div><div id="1129" class="line none"> 1129 #endif</div><div id="1130" class="line none"> 1130 }</div><div id="1131" class="line none"> 1131 /*---------------------------------------------------------------------------*/</div><div id="1132" class="line none"> 1132  /** @} */</div>
</div>
</body>
</html>
