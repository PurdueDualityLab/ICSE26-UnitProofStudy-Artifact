
<html>
<head>
<title>os/net/ipv6/uipbuf.c</title>
<link rel="stylesheet" type="text/css" href="../../../viewer.css">
</head>

<body>
<div class="code">
<div id="1" class="line none">    1 /*</div><div id="2" class="line none">    2  * Copyright (c) 2017, RISE SICS, Yanzi Networks</div><div id="3" class="line none">    3  * All rights reserved.</div><div id="4" class="line none">    4  *</div><div id="5" class="line none">    5  * Redistribution and use in source and binary forms, with or without</div><div id="6" class="line none">    6  * modification, are permitted provided that the following conditions</div><div id="7" class="line none">    7  * are met:</div><div id="8" class="line none">    8  * 1. Redistributions of source code must retain the above copyright</div><div id="9" class="line none">    9  *    notice, this list of conditions and the following disclaimer.</div><div id="10" class="line none">   10  * 2. Redistributions in binary form must reproduce the above copyright</div><div id="11" class="line none">   11  *    notice, this list of conditions and the following disclaimer in the</div><div id="12" class="line none">   12  *    documentation and/or other materials provided with the distribution.</div><div id="13" class="line none">   13  * 3. The name of the authors may not be used to endorse or promote</div><div id="14" class="line none">   14  *    products derived from this software without specific prior</div><div id="15" class="line none">   15  *    written permission.</div><div id="16" class="line none">   16  *</div><div id="17" class="line none">   17  * THIS SOFTWARE IS PROVIDED BY THE AUTHORS ``AS IS''</div><div id="18" class="line none">   18  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED</div><div id="19" class="line none">   19  * TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A</div><div id="20" class="line none">   20  * PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR BE</div><div id="21" class="line none">   21  * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</div><div id="22" class="line none">   22  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT</div><div id="23" class="line none">   23  * OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR</div><div id="24" class="line none">   24  * BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF</div><div id="25" class="line none">   25  * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</div><div id="26" class="line none">   26  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE</div><div id="27" class="line none">   27  * USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH</div><div id="28" class="line none">   28  * DAMAGE.</div><div id="29" class="line none">   29  *</div><div id="30" class="line none">   30  *</div><div id="31" class="line none">   31  */</div><div id="32" class="line none">   32 #include "contiki.h"</div><div id="33" class="line none">   33 #include "net/ipv6/uip.h"</div><div id="34" class="line none">   34 #include "net/ipv6/uipbuf.h"</div><div id="35" class="line none">   35 #include &lt;string.h&gt;</div><div id="36" class="line none">   36 </div><div id="37" class="line none">   37 /*---------------------------------------------------------------------------*/</div><div id="38" class="line none">   38 </div><div id="39" class="line none">   39 static uint16_t <a href="uipbuf.c.html#39">uipbuf_attrs</a>[<a href="uipbuf.h.html#213">UIPBUF_ATTR_MAX</a>];</div><div id="40" class="line none">   40 static uint16_t <a href="uipbuf.c.html#40">uipbuf_default_attrs</a>[<a href="uipbuf.h.html#213">UIPBUF_ATTR_MAX</a>];</div><div id="41" class="line none">   41 </div><div id="42" class="line none">   42 /*---------------------------------------------------------------------------*/</div><div id="43" class="line none">   43 void</div><div id="44" class="line none">   44 <a href="uipbuf.c.html#44">uipbuf_clear</a>(void)</div><div id="45" class="line none">   45 {</div><div id="46" class="line hit">   46   <a href="../../../cbmc/proofs/net/ipv6/rs_input/rsi_harness.c.html#20">uip_len</a> = 0;</div><div id="47" class="line hit">   47   <a href="../../../cbmc/proofs/net/ipv6/rs_input/rsi_harness.c.html#17">uip_ext_len</a> = 0;</div><div id="48" class="line hit">   48   <a href="uip.h.html#1241">uip_last_proto</a> = 0;</div><div id="49" class="line hit">   49   <a href="uipbuf.c.html#215">uipbuf_clear_attr</a>();</div><div id="50" class="line hit">   50 }</div><div id="51" class="line none">   51 /*---------------------------------------------------------------------------*/</div><div id="52" class="line none">   52 bool</div><div id="53" class="line none">   53 <a href="uipbuf.c.html#53">uipbuf_add_ext_hdr</a>(int16_t <a href="uip-nd6.h.html#326">len</a>)</div><div id="54" class="line none">   54 {</div><div id="55" class="line none">   55   if(<a href="uip-nd6.h.html#326">len</a> + <a href="../../../cbmc/proofs/net/ipv6/rs_input/rsi_harness.c.html#20">uip_len</a> &lt;= UIP_LINK_MTU &amp;&amp; <a href="uip-nd6.h.html#326">len</a> + <a href="../../../cbmc/proofs/net/ipv6/rs_input/rsi_harness.c.html#20">uip_len</a> &gt;= 0 &amp;&amp; <a href="uip-nd6.h.html#326">len</a> + <a href="../../../cbmc/proofs/net/ipv6/rs_input/rsi_harness.c.html#17">uip_ext_len</a> &gt;= 0) {</div><div id="56" class="line none">   56     <a href="../../../cbmc/proofs/net/ipv6/rs_input/rsi_harness.c.html#17">uip_ext_len</a> += <a href="uip-nd6.h.html#326">len</a>;</div><div id="57" class="line none">   57     <a href="../../../cbmc/proofs/net/ipv6/rs_input/rsi_harness.c.html#20">uip_len</a> += <a href="uip-nd6.h.html#326">len</a>;</div><div id="58" class="line none">   58     return true;</div><div id="59" class="line none">   59   } else {</div><div id="60" class="line none">   60     return false;</div><div id="61" class="line none">   61   }</div><div id="62" class="line none">   62 }</div><div id="63" class="line none">   63 /*---------------------------------------------------------------------------*/</div><div id="64" class="line none">   64 bool</div><div id="65" class="line none">   65 <a href="uipbuf.c.html#65">uipbuf_set_len</a>(uint16_t <a href="uip-nd6.h.html#326">len</a>)</div><div id="66" class="line none">   66 {</div><div id="67" class="line none">   67   if(<a href="uip-nd6.h.html#326">len</a> &lt;= UIP_LINK_MTU) {</div><div id="68" class="line none">   68     <a href="../../../cbmc/proofs/net/ipv6/rs_input/rsi_harness.c.html#20">uip_len</a> = <a href="uip-nd6.h.html#326">len</a>;</div><div id="69" class="line none">   69     return true;</div><div id="70" class="line none">   70   } else {</div><div id="71" class="line none">   71     return false;</div><div id="72" class="line none">   72   }</div><div id="73" class="line none">   73 }</div><div id="74" class="line none">   74 /*---------------------------------------------------------------------------*/</div><div id="75" class="line none">   75 void</div><div id="76" class="line none">   76 <a href="uipbuf.c.html#76">uipbuf_set_len_field</a>(struct <a href="uipbuf.h.html#37">uip_ip_hdr</a> *hdr, uint16_t <a href="uip-nd6.h.html#326">len</a>)</div><div id="77" class="line none">   77 {</div><div id="78" class="line none">   78   hdr-&gt;<a href="uip-nd6.h.html#326">len</a>[0] = (<a href="uip-nd6.h.html#326">len</a> &gt;&gt; 8);</div><div id="79" class="line none">   79   hdr-&gt;<a href="uip-nd6.h.html#326">len</a>[1] = (<a href="uip-nd6.h.html#326">len</a> &amp; 0xff);</div><div id="80" class="line none">   80 }</div><div id="81" class="line none">   81 /*---------------------------------------------------------------------------*/</div><div id="82" class="line none">   82 uint16_t</div><div id="83" class="line none">   83 <a href="uipbuf.c.html#83">uipbuf_get_len_field</a>(struct <a href="uipbuf.h.html#37">uip_ip_hdr</a> *hdr)</div><div id="84" class="line none">   84 {</div><div id="85" class="line none">   85   return ((uint16_t)(hdr-&gt;<a href="uip-nd6.h.html#326">len</a>[0]) &lt;&lt; 8) + hdr-&gt;<a href="uip-nd6.h.html#326">len</a>[1];</div><div id="86" class="line none">   86 }</div><div id="87" class="line none">   87 /*---------------------------------------------------------------------------*/</div><div id="88" class="line none">   88 /* Get the next header given the buffer - start indicates that this is</div><div id="89" class="line none">   89    start of the IPv6 header - needs to be set to 0 when in an ext hdr */</div><div id="90" class="line none">   90 uint8_t *</div><div id="91" class="line none">   91 <a href="uipbuf.c.html#91">uipbuf_get_next_header</a>(uint8_t *buffer, uint16_t size, uint8_t *protocol, bool <a href="../../sys/stimer.h.html#84">start</a>)</div><div id="92" class="line none">   92 {</div><div id="93" class="line none">   93   int curr_hdr_len = 0;</div><div id="94" class="line none">   94   int next_hdr_len = 0;</div><div id="95" class="line none">   95   uint8_t *next_header = NULL;</div><div id="96" class="line none">   96   struct <a href="uipbuf.h.html#37">uip_ip_hdr</a> *ipbuf = NULL;</div><div id="97" class="line none">   97   struct <a href="uip.h.html#1562">uip_ext_hdr</a> *curr_ext = NULL;</div><div id="98" class="line none">   98   struct <a href="uip.h.html#1562">uip_ext_hdr</a> *next_ext = NULL;</div><div id="99" class="line none">   99 </div><div id="100" class="line none">  100   if(<a href="../../sys/stimer.h.html#84">start</a>) {</div><div id="101" class="line none">  101     /* protocol in the IP buffer */</div><div id="102" class="line none">  102     ipbuf = (struct <a href="uipbuf.h.html#37">uip_ip_hdr</a> *)buffer;</div><div id="103" class="line none">  103     *protocol = ipbuf-&gt;<a href="uip.h.html#1536">proto</a>;</div><div id="104" class="line none">  104     curr_hdr_len = <a href="uip.h.html#56">UIP_IPH_LEN</a>;</div><div id="105" class="line none">  105   } else {</div><div id="106" class="line none">  106     /* protocol in the Ext hdr */</div><div id="107" class="line none">  107     curr_ext = (struct <a href="uip.h.html#1562">uip_ext_hdr</a> *)buffer;</div><div id="108" class="line none">  108     *protocol = curr_ext-&gt;<a href="uip-ds6-nbr.h.html#107">next</a>;</div><div id="109" class="line none">  109     /* This is just an ext header */</div><div id="110" class="line none">  110     curr_hdr_len = (curr_ext-&gt;<a href="uip-nd6.h.html#326">len</a> &lt;&lt; 3) + 8;</div><div id="111" class="line none">  111   }</div><div id="112" class="line none">  112 </div><div id="113" class="line none">  113   /* Check first if enough space for current header */</div><div id="114" class="line none">  114   if(curr_hdr_len &gt; size) {</div><div id="115" class="line none">  115     return NULL;</div><div id="116" class="line none">  116   }</div><div id="117" class="line none">  117   next_header = buffer + curr_hdr_len;</div><div id="118" class="line none">  118 </div><div id="119" class="line none">  119   /* Check if the buffer is large enough for the next header */</div><div id="120" class="line none">  120   if(<a href="uip.h.html#1696">uip_is_proto_ext_hdr</a>(*protocol)) {</div><div id="121" class="line none">  121     if(curr_hdr_len + sizeof(struct <a href="uip.h.html#1562">uip_ext_hdr</a>) &gt; size) {</div><div id="122" class="line none">  122       return NULL;</div><div id="123" class="line none">  123     }</div><div id="124" class="line none">  124     next_ext = (struct <a href="uip.h.html#1562">uip_ext_hdr</a> *)next_header;</div><div id="125" class="line none">  125     next_hdr_len = (next_ext-&gt;<a href="uip-nd6.h.html#326">len</a> &lt;&lt; 3) + 8;</div><div id="126" class="line none">  126   } else {</div><div id="127" class="line none">  127     if(*protocol == <a href="uip.h.html#1682">UIP_PROTO_TCP</a>) {</div><div id="128" class="line none">  128       next_hdr_len = <a href="uip.h.html#60">UIP_TCPH_LEN</a>;</div><div id="129" class="line none">  129     } else if(*protocol == <a href="uip.h.html#1683">UIP_PROTO_UDP</a>) {</div><div id="130" class="line none">  130       next_hdr_len = <a href="uip.h.html#59">UIP_UDPH_LEN</a>;</div><div id="131" class="line none">  131     } else if(*protocol == <a href="uip.h.html#1684">UIP_PROTO_ICMP6</a>) {</div><div id="132" class="line none">  132       next_hdr_len = <a href="uip.h.html#61">UIP_ICMPH_LEN</a>;</div><div id="133" class="line none">  133     }</div><div id="134" class="line none">  134   }</div><div id="135" class="line none">  135 </div><div id="136" class="line none">  136   /* Size must be enough to hold both the current and next header */</div><div id="137" class="line none">  137   if(next_hdr_len == 0 || curr_hdr_len + next_hdr_len &gt; size) {</div><div id="138" class="line none">  138     return NULL;</div><div id="139" class="line none">  139   }</div><div id="140" class="line none">  140 </div><div id="141" class="line none">  141   return next_header;</div><div id="142" class="line none">  142 }</div><div id="143" class="line none">  143 /*---------------------------------------------------------------------------*/</div><div id="144" class="line none">  144 /* Get the final header given the buffer - that is assumed to be at start</div><div id="145" class="line none">  145    of an IPv6 header */</div><div id="146" class="line none">  146 uint8_t *</div><div id="147" class="line none">  147 <a href="uipbuf.c.html#147">uipbuf_get_last_header</a>(uint8_t *buffer, uint16_t size, uint8_t *protocol)</div><div id="148" class="line none">  148 {</div><div id="149" class="line none">  149   uint8_t *nbuf;</div><div id="150" class="line none">  150 </div><div id="151" class="line none">  151   nbuf = <a href="uipbuf.c.html#91">uipbuf_get_next_header</a>(buffer, size, protocol, true);</div><div id="152" class="line none">  152   while(nbuf != NULL &amp;&amp; <a href="uip.h.html#1696">uip_is_proto_ext_hdr</a>(*protocol)) {</div><div id="153" class="line none">  153     /* move to the ext hdr */</div><div id="154" class="line none">  154     nbuf = <a href="uipbuf.c.html#91">uipbuf_get_next_header</a>(nbuf, size - (nbuf - buffer), protocol, false);</div><div id="155" class="line none">  155   }</div><div id="156" class="line none">  156 </div><div id="157" class="line none">  157   /* In case the buffer wasn't large enough for all headers, return NULL */</div><div id="158" class="line none">  158   return nbuf;</div><div id="159" class="line none">  159 }</div><div id="160" class="line none">  160 /*---------------------------------------------------------------------------*/</div><div id="161" class="line none">  161 uint8_t *</div><div id="162" class="line none">  162 <a href="uipbuf.c.html#162">uipbuf_search_header</a>(uint8_t *buffer, uint16_t size, uint8_t protocol)</div><div id="163" class="line none">  163 {</div><div id="164" class="line none">  164   uint8_t *nbuf;</div><div id="165" class="line none">  165   uint8_t next_proto;</div><div id="166" class="line none">  166 </div><div id="167" class="line none">  167   nbuf = <a href="uipbuf.c.html#91">uipbuf_get_next_header</a>(buffer, size, &amp;next_proto, true);</div><div id="168" class="line none">  168   while(nbuf != NULL &amp;&amp; next_proto != protocol &amp;&amp; <a href="uip.h.html#1696">uip_is_proto_ext_hdr</a>(next_proto)) {</div><div id="169" class="line none">  169     /* move to the ext hdr */</div><div id="170" class="line none">  170     nbuf = <a href="uipbuf.c.html#91">uipbuf_get_next_header</a>(nbuf, size - (nbuf - buffer), &amp;next_proto, false);</div><div id="171" class="line none">  171   }</div><div id="172" class="line none">  172 </div><div id="173" class="line none">  173   if(next_proto == protocol) {</div><div id="174" class="line none">  174     return nbuf;</div><div id="175" class="line none">  175   } else {</div><div id="176" class="line none">  176     return NULL;</div><div id="177" class="line none">  177   }</div><div id="178" class="line none">  178 }</div><div id="179" class="line none">  179 /*---------------------------------------------------------------------------*/</div><div id="180" class="line none">  180 /**</div><div id="181" class="line none">  181  * Common functions for uipbuf (attributes, etc).</div><div id="182" class="line none">  182  *</div><div id="183" class="line none">  183  */</div><div id="184" class="line none">  184 /*---------------------------------------------------------------------------*/</div><div id="185" class="line none">  185 uint16_t</div><div id="186" class="line none">  186 <a href="uipbuf.c.html#186">uipbuf_get_attr</a>(uint8_t <a href="uip-ds6.h.html#209">type</a>)</div><div id="187" class="line none">  187 {</div><div id="188" class="line none">  188   if(<a href="uip-ds6.h.html#209">type</a> &lt; <a href="uipbuf.h.html#213">UIPBUF_ATTR_MAX</a>) {</div><div id="189" class="line none">  189     return <a href="uipbuf.c.html#39">uipbuf_attrs</a>[<a href="uip-ds6.h.html#209">type</a>];</div><div id="190" class="line none">  190   }</div><div id="191" class="line none">  191   return 0;</div><div id="192" class="line none">  192 }</div><div id="193" class="line none">  193 /*---------------------------------------------------------------------------*/</div><div id="194" class="line none">  194 int</div><div id="195" class="line none">  195 <a href="uipbuf.c.html#195">uipbuf_set_attr</a>(uint8_t <a href="uip-ds6.h.html#209">type</a>, uint16_t value)</div><div id="196" class="line none">  196 {</div><div id="197" class="line none">  197   if(<a href="uip-ds6.h.html#209">type</a> &lt; <a href="uipbuf.h.html#213">UIPBUF_ATTR_MAX</a>) {</div><div id="198" class="line none">  198     <a href="uipbuf.c.html#39">uipbuf_attrs</a>[<a href="uip-ds6.h.html#209">type</a>] = value;</div><div id="199" class="line none">  199     return 1;</div><div id="200" class="line none">  200   }</div><div id="201" class="line none">  201   return 0;</div><div id="202" class="line none">  202 }</div><div id="203" class="line none">  203 /*---------------------------------------------------------------------------*/</div><div id="204" class="line none">  204 int</div><div id="205" class="line none">  205 <a href="uipbuf.c.html#205">uipbuf_set_default_attr</a>(uint8_t <a href="uip-ds6.h.html#209">type</a>, uint16_t value)</div><div id="206" class="line none">  206 {</div><div id="207" class="line none">  207   if(<a href="uip-ds6.h.html#209">type</a> &lt; <a href="uipbuf.h.html#213">UIPBUF_ATTR_MAX</a>) {</div><div id="208" class="line none">  208     <a href="uipbuf.c.html#40">uipbuf_default_attrs</a>[<a href="uip-ds6.h.html#209">type</a>] = value;</div><div id="209" class="line none">  209     return 1;</div><div id="210" class="line none">  210   }</div><div id="211" class="line none">  211   return 0;</div><div id="212" class="line none">  212 }</div><div id="213" class="line none">  213 /*---------------------------------------------------------------------------*/</div><div id="214" class="line none">  214 void</div><div id="215" class="line none">  215 <a href="uipbuf.c.html#215">uipbuf_clear_attr</a>(void)</div><div id="216" class="line none">  216 {</div><div id="217" class="line none">  217   /* set everything to "defaults" */</div><div id="218" class="line none">  218   memcpy(<a href="uipbuf.c.html#39">uipbuf_attrs</a>, <a href="uipbuf.c.html#40">uipbuf_default_attrs</a>, sizeof(<a href="uipbuf.c.html#39">uipbuf_attrs</a>));</div><div id="219" class="line none">  219 }</div><div id="220" class="line none">  220 /*---------------------------------------------------------------------------*/</div><div id="221" class="line none">  221 void</div><div id="222" class="line none">  222 <a href="uipbuf.c.html#222">uipbuf_set_attr_flag</a>(uint16_t flag)</div><div id="223" class="line none">  223 {</div><div id="224" class="line none">  224   /* Assume only 16-bits for flags now */</div><div id="225" class="line none">  225   <a href="uipbuf.c.html#39">uipbuf_attrs</a>[<a href="uipbuf.h.html#210">UIPBUF_ATTR_FLAGS</a>] |= flag;</div><div id="226" class="line none">  226 }</div><div id="227" class="line none">  227 /*---------------------------------------------------------------------------*/</div><div id="228" class="line none">  228 void</div><div id="229" class="line none">  229 <a href="uipbuf.c.html#229">uipbuf_clr_attr_flag</a>(uint16_t flag)</div><div id="230" class="line none">  230 {</div><div id="231" class="line none">  231   <a href="uipbuf.c.html#39">uipbuf_attrs</a>[<a href="uipbuf.h.html#210">UIPBUF_ATTR_FLAGS</a>] &amp;= ~flag;</div><div id="232" class="line none">  232 }</div><div id="233" class="line none">  233 /*---------------------------------------------------------------------------*/</div><div id="234" class="line none">  234 uint16_t</div><div id="235" class="line none">  235 <a href="uipbuf.c.html#235">uipbuf_is_attr_flag</a>(uint16_t flag)</div><div id="236" class="line none">  236 {</div><div id="237" class="line none">  237   return (<a href="uipbuf.c.html#39">uipbuf_attrs</a>[<a href="uipbuf.h.html#210">UIPBUF_ATTR_FLAGS</a>] &amp; flag) == flag;</div><div id="238" class="line none">  238 }</div><div id="239" class="line none">  239 /*---------------------------------------------------------------------------*/</div><div id="240" class="line none">  240 void</div><div id="241" class="line none">  241 <a href="uipbuf.c.html#241">uipbuf_init</a>(void)</div><div id="242" class="line none">  242 {</div><div id="243" class="line none">  243   memset(<a href="uipbuf.c.html#40">uipbuf_default_attrs</a>, 0, sizeof(<a href="uipbuf.c.html#40">uipbuf_default_attrs</a>));</div><div id="244" class="line none">  244   /* And initialize anything that should be initialized */</div><div id="245" class="line none">  245   <a href="uipbuf.c.html#205">uipbuf_set_default_attr</a>(<a href="uipbuf.h.html#209">UIPBUF_ATTR_MAX_MAC_TRANSMISSIONS</a>,</div><div id="246" class="line none">  246                           UIP_MAX_MAC_TRANSMISSIONS_UNDEFINED);</div><div id="247" class="line none">  247   /* set the not-set default value - this will cause the MAC layer to</div><div id="248" class="line none">  248      configure its default */</div><div id="249" class="line none">  249   <a href="uipbuf.c.html#205">uipbuf_set_default_attr</a>(<a href="uipbuf.h.html#205">UIPBUF_ATTR_LLSEC_LEVEL</a>,</div><div id="250" class="line none">  250                           <a href="uipbuf.h.html#193">UIPBUF_ATTR_LLSEC_LEVEL_MAC_DEFAULT</a>);</div><div id="251" class="line none">  251 }</div><div id="252" class="line none">  252 </div><div id="253" class="line none">  253 /*---------------------------------------------------------------------------*/</div>
</div>
</body>
</html>
