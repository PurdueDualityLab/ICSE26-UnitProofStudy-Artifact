
<html>
<head>
<title>cbmc/proofs/net/snmp/snmp-generic.h</title>
<link rel="stylesheet" type="text/css" href="../../../../viewer.css">
</head>

<body>
<div class="code">
<div id="1" class="line none">    1 /**</div><div id="2" class="line none">    2  * @file snmp-generic.h</div><div id="3" class="line none">    3  * @author Owen Cochell (owencochell@gmail.com)</div><div id="4" class="line none">    4  * @brief Various functions for SNMP-BER harnesses</div><div id="5" class="line none">    5  * @version 0.1</div><div id="6" class="line none">    6  * @date 2024-06-05</div><div id="7" class="line none">    7  * </div><div id="8" class="line none">    8  * @copyright Copyright (c) 2024</div><div id="9" class="line none">    9  * </div><div id="10" class="line none">   10  */</div><div id="11" class="line none">   11 </div><div id="12" class="line none">   12 #include "contiki.h"</div><div id="13" class="line none">   13 #include "net/app-layer/snmp/snmp.h"</div><div id="14" class="line none">   14 #include "net/ipv6/uipopt.h"</div><div id="15" class="line none">   15 #include "net/ipv6/uip.h"</div><div id="16" class="line none">   16 </div><div id="17" class="line none">   17 /**</div><div id="18" class="line none">   18  * @brief Initialises a packet in a standard way for decoding</div><div id="19" class="line none">   19  * </div><div id="20" class="line none">   20  * We preform the following steps:</div><div id="21" class="line none">   21  * - Define packet max size</div><div id="22" class="line none">   22  * - Set packet size as unconstrained (won't exceed max)</div><div id="23" class="line none">   23  * - Set used value to match our determined size</div><div id="24" class="line none">   24  * - Allocate input buffer (won't be null)</div><div id="25" class="line none">   25  * </div><div id="26" class="line none">   26  * Simply pass your packet and this function will initialize it as described.</div><div id="27" class="line none">   27  */</div><div id="28" class="line none">   28 inline void <a href="snmp-generic.h.html#28">init_packet_in</a>(<a href="../../../../os/net/app-layer/snmp/snmp.h.html#227">snmp_packet_t</a>* pack) {</div><div id="29" class="line none">   29 </div><div id="30" class="line none">   30     // Define the max size:</div><div id="31" class="line none">   31     pack-&gt;<a href="../../../../os/net/app-layer/snmp/snmp.h.html#216">max</a> = UIP_BUFSIZE - UIP_IPUDPH_LEN;</div><div id="32" class="line none">   32 </div><div id="33" class="line none">   33     // Determine the size to work with, should not exceed max:</div><div id="34" class="line none">   34     uint16_t size;</div><div id="35" class="line none">   35 </div><div id="36" class="line none">   36     __CPROVER_assume(size &lt;= pack-&gt;<a href="../../../../os/net/app-layer/snmp/snmp.h.html#216">max</a>);</div><div id="37" class="line none">   37 </div><div id="38" class="line none">   38     // Set used amount:</div><div id="39" class="line none">   39 </div><div id="40" class="line none">   40     pack-&gt;<a href="../../../../os/net/app-layer/snmp/snmp.h.html#211">used</a> = size;</div><div id="41" class="line none">   41 </div><div id="42" class="line none">   42     // Allocate input to in buffer:</div><div id="43" class="line none">   43 </div><div id="44" class="line none">   44     pack-&gt;<a href="../../../../os/net/app-layer/snmp/snmp.h.html#221">in</a> = (uint8_t*)malloc(sizeof(uint8_t) * size);</div><div id="45" class="line none">   45 </div><div id="46" class="line none">   46     // Allocated data should not be null:</div><div id="47" class="line none">   47 </div><div id="48" class="line none">   48     __CPROVER_assume(pack-&gt;<a href="../../../../os/net/app-layer/snmp/snmp.h.html#221">in</a> != NULL);</div><div id="49" class="line none">   49 </div><div id="50" class="line none">   50     __CPROVER_assume(__CPROVER_rw_ok(pack-&gt;<a href="../../../../os/net/app-layer/snmp/snmp.h.html#221">in</a>, size));</div><div id="51" class="line none">   51 }</div><div id="52" class="line none">   52 </div><div id="53" class="line none">   53 /**</div><div id="54" class="line none">   54  * @brief Initialises a packet in a standard way for encoding</div><div id="55" class="line none">   55  * </div><div id="56" class="line none">   56  * We preform the following steps:</div><div id="57" class="line none">   57  * - Define packet max size</div><div id="58" class="line none">   58  * - Set packet size as the maximum size</div><div id="59" class="line none">   59  * - Set used value to zero</div><div id="60" class="line none">   60  * - Allocate output buffer (won't be null)</div><div id="61" class="line none">   61  * </div><div id="62" class="line none">   62  * Simply pass your packet and this function will initialize it as described.</div><div id="63" class="line none">   63  * SNMP encodes in data backwards, so we have to do things in reverse.</div><div id="64" class="line none">   64  * Also, I believe the SNMP packets assume the max size of the out data to be the max value.</div><div id="65" class="line none">   65  * As data is written, the used value is is incremented, so the only way the writing functions</div><div id="66" class="line none">   66  * are able to tell that all data is written is by comparing it with the max value.</div><div id="67" class="line none">   67  * So, if we set the buffer size to be less than the max,</div><div id="68" class="line none">   68  * we will see problems SNMP has no way of knowing it is out of bounds.</div><div id="69" class="line none">   69  */</div><div id="70" class="line none">   70 inline void <a href="snmp-generic.h.html#70">init_packet_out</a>(<a href="../../../../os/net/app-layer/snmp/snmp.h.html#227">snmp_packet_t</a>* pack) {</div><div id="71" class="line none">   71 </div><div id="72" class="line none">   72     // Define the max size:</div><div id="73" class="line hit">   73     pack-&gt;<a href="../../../../os/net/app-layer/snmp/snmp.h.html#216">max</a> = UIP_BUFSIZE - UIP_IPUDPH_LEN;</div><div id="74" class="line none">   74 </div><div id="75" class="line none">   75     // Determine the size to work with, should not exceed max:</div><div id="76" class="line hit">   76     uint16_t size = pack-&gt;<a href="../../../../os/net/app-layer/snmp/snmp.h.html#216">max</a>;</div><div id="77" class="line none">   77 </div><div id="78" class="line hit">   78     __CPROVER_assume(size &lt;= pack-&gt;<a href="../../../../os/net/app-layer/snmp/snmp.h.html#216">max</a>);</div><div id="79" class="line none">   79 </div><div id="80" class="line none">   80     // Set used amount:</div><div id="81" class="line none">   81 </div><div id="82" class="line hit">   82     pack-&gt;<a href="../../../../os/net/app-layer/snmp/snmp.h.html#211">used</a> = 0;</div><div id="83" class="line none">   83 </div><div id="84" class="line none">   84     // Allocate input to in buffer:</div><div id="85" class="line none">   85 </div><div id="86" class="line hit">   86     pack-&gt;<a href="../../../../os/net/app-layer/snmp/snmp.h.html#226">out</a> = (uint8_t*)malloc(sizeof(uint8_t) * size);</div><div id="87" class="line none">   87 </div><div id="88" class="line none">   88     // Allocated data should not be null:</div><div id="89" class="line none">   89 </div><div id="90" class="line hit">   90     __CPROVER_assume(pack-&gt;<a href="../../../../os/net/app-layer/snmp/snmp.h.html#226">out</a> != NULL);</div><div id="91" class="line none">   91 </div><div id="92" class="line none">   92     // Move pointer to end (don't do so if zero):</div><div id="93" class="line none">   93 </div><div id="94" class="line hit">   94     if (size != 0) {</div><div id="95" class="line none">   95 </div><div id="96" class="line hit">   96         pack-&gt;<a href="../../../../os/net/app-layer/snmp/snmp.h.html#226">out</a> += (size-1);</div><div id="97" class="line none">   97     }</div><div id="98" class="line hit">   98 }</div><div id="99" class="line none">   99 </div><div id="100" class="line none">  100 /**</div><div id="101" class="line none">  101  * @brief Offsets in packet pointers</div><div id="102" class="line none">  102  * </div><div id="103" class="line none">  103  * We offset the in packet data by some amount,</div><div id="104" class="line none">  104  * and we ensure this amount will not exceed the packet length.</div><div id="105" class="line none">  105  * This function is primarily useful for snmp-ber functions,</div><div id="106" class="line none">  106  * where they are expected to decode data at arbitrary positions.</div><div id="107" class="line none">  107  * </div><div id="108" class="line none">  108  * @param pack Packet to offset</div><div id="109" class="line none">  109  */</div><div id="110" class="line none">  110 void <a href="snmp-generic.h.html#110">offset_packet_in</a>(<a href="../../../../os/net/app-layer/snmp/snmp.h.html#227">snmp_packet_t</a>* pack) {</div><div id="111" class="line none">  111 </div><div id="112" class="line none">  112     // Move pointers around by some amount (less than size):</div><div id="113" class="line none">  113 </div><div id="114" class="line none">  114     uint16_t offset;</div><div id="115" class="line none">  115 </div><div id="116" class="line none">  116     __CPROVER_assume(offset &lt;= pack-&gt;<a href="../../../../os/net/app-layer/snmp/snmp.h.html#211">used</a>);</div><div id="117" class="line none">  117 </div><div id="118" class="line none">  118     pack-&gt;<a href="../../../../os/net/app-layer/snmp/snmp.h.html#221">in</a> += offset;</div><div id="119" class="line none">  119     pack-&gt;<a href="../../../../os/net/app-layer/snmp/snmp.h.html#211">used</a> -= offset;</div><div id="120" class="line none">  120 }</div><div id="121" class="line none">  121 </div><div id="122" class="line none">  122 /**</div><div id="123" class="line none">  123  * @brief Offsets out packet pointers</div><div id="124" class="line none">  124  * </div><div id="125" class="line none">  125  * We offset the out packet data by some amount.</div><div id="126" class="line none">  126  * and we ensure this amount will not exceed the packet length.</div><div id="127" class="line none">  127  * This function is primarily useful for snmp-ber functions,</div><div id="128" class="line none">  128  * where they are expected to decode data at arbitrary positions.</div><div id="129" class="line none">  129  * </div><div id="130" class="line none">  130  * @param pack Packet to offset</div><div id="131" class="line none">  131  */</div><div id="132" class="line none">  132 void <a href="snmp-generic.h.html#132">offset_packet_out</a>(<a href="../../../../os/net/app-layer/snmp/snmp.h.html#227">snmp_packet_t</a>* pack) {</div><div id="133" class="line none">  133 </div><div id="134" class="line none">  134     // Move pointers around by some amount (less than size):</div><div id="135" class="line none">  135 </div><div id="136" class="line none">  136     uint16_t offset;</div><div id="137" class="line none">  137 </div><div id="138" class="line none">  138     __CPROVER_assume(offset &lt;= pack-&gt;<a href="../../../../os/net/app-layer/snmp/snmp.h.html#211">used</a>);</div><div id="139" class="line none">  139 </div><div id="140" class="line none">  140     pack-&gt;<a href="../../../../os/net/app-layer/snmp/snmp.h.html#226">out</a> -= offset;</div><div id="141" class="line none">  141     pack-&gt;<a href="../../../../os/net/app-layer/snmp/snmp.h.html#211">used</a> += offset;</div><div id="142" class="line none">  142 }</div>
</div>
</body>
</html>
