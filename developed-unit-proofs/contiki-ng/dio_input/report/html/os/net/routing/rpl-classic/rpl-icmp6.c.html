
<html>
<head>
<title>os/net/routing/rpl-classic/rpl-icmp6.c</title>
<link rel="stylesheet" type="text/css" href="../../../../viewer.css">
</head>

<body>
<div class="code">
<div id="1" class="line none">    1 /*</div><div id="2" class="line none">    2  * Copyright (c) 2010, Swedish Institute of Computer Science.</div><div id="3" class="line none">    3  * All rights reserved.</div><div id="4" class="line none">    4  *</div><div id="5" class="line none">    5  * Redistribution and use in source and binary forms, with or without</div><div id="6" class="line none">    6  * modification, are permitted provided that the following conditions</div><div id="7" class="line none">    7  * are met:</div><div id="8" class="line none">    8  * 1. Redistributions of source code must retain the above copyright</div><div id="9" class="line none">    9  *    notice, this list of conditions and the following disclaimer.</div><div id="10" class="line none">   10  * 2. Redistributions in binary form must reproduce the above copyright</div><div id="11" class="line none">   11  *    notice, this list of conditions and the following disclaimer in the</div><div id="12" class="line none">   12  *    documentation and/or other materials provided with the distribution.</div><div id="13" class="line none">   13  * 3. Neither the name of the Institute nor the names of its contributors</div><div id="14" class="line none">   14  *    may be used to endorse or promote products derived from this software</div><div id="15" class="line none">   15  *    without specific prior written permission.</div><div id="16" class="line none">   16  *</div><div id="17" class="line none">   17  * THIS SOFTWARE IS PROVIDED BY THE INSTITUTE AND CONTRIBUTORS ``AS IS'' AND</div><div id="18" class="line none">   18  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</div><div id="19" class="line none">   19  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</div><div id="20" class="line none">   20  * ARE DISCLAIMED.  IN NO EVENT SHALL THE INSTITUTE OR CONTRIBUTORS BE LIABLE</div><div id="21" class="line none">   21  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</div><div id="22" class="line none">   22  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS</div><div id="23" class="line none">   23  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</div><div id="24" class="line none">   24  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</div><div id="25" class="line none">   25  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</div><div id="26" class="line none">   26  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</div><div id="27" class="line none">   27  * SUCH DAMAGE.</div><div id="28" class="line none">   28  */</div><div id="29" class="line none">   29 </div><div id="30" class="line none">   30 /**</div><div id="31" class="line none">   31  * \file</div><div id="32" class="line none">   32  *         ICMP6 I/O for RPL control messages.</div><div id="33" class="line none">   33  *</div><div id="34" class="line none">   34  * \author Joakim Eriksson &lt;joakime@sics.se&gt;, Nicolas Tsiftes &lt;nvt@sics.se&gt;</div><div id="35" class="line none">   35  * Contributors: Niclas Finne &lt;nfi@sics.se&gt;, Joel Hoglund &lt;joel@sics.se&gt;,</div><div id="36" class="line none">   36  *               Mathieu Pouillot &lt;m.pouillot@watteco.com&gt;</div><div id="37" class="line none">   37  *               George Oikonomou &lt;oikonomou@users.sourceforge.net&gt; (multicast)</div><div id="38" class="line none">   38  */</div><div id="39" class="line none">   39 </div><div id="40" class="line none">   40 /**</div><div id="41" class="line none">   41  * \addtogroup uip</div><div id="42" class="line none">   42  * @{</div><div id="43" class="line none">   43  */</div><div id="44" class="line none">   44 </div><div id="45" class="line none">   45 #include "net/ipv6/tcpip.h"</div><div id="46" class="line none">   46 #include "net/ipv6/uip.h"</div><div id="47" class="line none">   47 #include "net/ipv6/uip-ds6.h"</div><div id="48" class="line none">   48 #include "net/ipv6/uip-nd6.h"</div><div id="49" class="line none">   49 #include "net/ipv6/uip-sr.h"</div><div id="50" class="line none">   50 #include "net/ipv6/uip-icmp6.h"</div><div id="51" class="line none">   51 #include "net/routing/rpl-classic/rpl-private.h"</div><div id="52" class="line none">   52 #include "net/packetbuf.h"</div><div id="53" class="line none">   53 #include "net/ipv6/multicast/uip-mcast6.h"</div><div id="54" class="line none">   54 #include "lib/random.h"</div><div id="55" class="line none">   55 </div><div id="56" class="line none">   56 #include "sys/log.h"</div><div id="57" class="line none">   57 </div><div id="58" class="line none">   58 #include &lt;limits.h&gt;</div><div id="59" class="line none">   59 #include &lt;string.h&gt;</div><div id="60" class="line none">   60 </div><div id="61" class="line none">   61 #define <a href="rpl-icmp6.c.html#61">LOG_MODULE</a> "RPL"</div><div id="62" class="line none">   62 #define <a href="rpl-icmp6.c.html#62">LOG_LEVEL</a> <a href="../../../sys/log.h.html#125">LOG_LEVEL_RPL</a></div><div id="63" class="line none">   63 </div><div id="64" class="line none">   64 /*---------------------------------------------------------------------------*/</div><div id="65" class="line none">   65 #define <a href="rpl-icmp6.c.html#65">RPL_DIO_GROUNDED</a>                 0x80</div><div id="66" class="line none">   66 #define <a href="rpl-icmp6.c.html#66">RPL_DIO_MOP_SHIFT</a>                3</div><div id="67" class="line none">   67 #define <a href="rpl-icmp6.c.html#67">RPL_DIO_MOP_MASK</a>                 0x38</div><div id="68" class="line none">   68 #define <a href="rpl-icmp6.c.html#68">RPL_DIO_PREFERENCE_MASK</a>          0x07</div><div id="69" class="line none">   69 </div><div id="70" class="line none">   70 /*---------------------------------------------------------------------------*/</div><div id="71" class="line none">   71 static void <a href="rpl-icmp6.c.html#213">dis_input</a>(void);</div><div id="72" class="line none">   72 void <a href="rpl-icmp6.c.html#283">dio_input</a>(void);</div><div id="73" class="line none">   73 static void <a href="rpl-icmp6.c.html#1132">dao_input</a>(void);</div><div id="74" class="line none">   74 static void <a href="rpl-icmp6.c.html#1388">dao_ack_input</a>(void);</div><div id="75" class="line none">   75 </div><div id="76" class="line none">   76 static void <a href="rpl-icmp6.c.html#1271">dao_output_target_seq</a>(<a href="rpl.h.html#125">rpl_parent_t</a> *parent, <a href="../../ipv6/uip.h.html#105">uip_ipaddr_t</a> *<a href="rpl.h.html#129">prefix</a>,</div><div id="77" class="line none">   77                                   uint8_t <a href="../../ipv6/uip-ds6-route.h.html#156">lifetime</a>, uint8_t seq_no);</div><div id="78" class="line none">   78 </div><div id="79" class="line none">   79 /* Some debug callbacks that are useful when debugging RPL networks. */</div><div id="80" class="line none">   80 #ifdef RPL_DEBUG_DIO_INPUT</div><div id="81" class="line none">   81 void RPL_DEBUG_DIO_INPUT(<a href="../../ipv6/uip.h.html#105">uip_ipaddr_t</a> *, <a href="rpl-private.h.html#249">rpl_dio_t</a> *);</div><div id="82" class="line none">   82 #endif</div><div id="83" class="line none">   83 </div><div id="84" class="line none">   84 #ifdef RPL_DEBUG_DAO_OUTPUT</div><div id="85" class="line none">   85 void RPL_DEBUG_DAO_OUTPUT(<a href="rpl.h.html#125">rpl_parent_t</a> *);</div><div id="86" class="line none">   86 #endif</div><div id="87" class="line none">   87 </div><div id="88" class="line none">   88 static uint8_t <a href="rpl-icmp6.c.html#88">dao_sequence</a> = <a href="rpl-private.h.html#213">RPL_LOLLIPOP_INIT</a>;</div><div id="89" class="line none">   89 </div><div id="90" class="line none">   90 #if RPL_WITH_MULTICAST</div><div id="91" class="line none">   91 static uip_mcast6_route_t *<a href="rpl-icmp6.c.html#91">mcast_group</a>;</div><div id="92" class="line none">   92 #endif</div><div id="93" class="line none">   93 /*---------------------------------------------------------------------------*/</div><div id="94" class="line none">   94 /* Initialise RPL ICMPv6 message handlers */</div><div id="95" class="line none">   95 <a href="../../ipv6/uip-icmp6.h.html#202">UIP_ICMP6_HANDLER</a>(<a href="rpl-icmp6.c.html#95">dis_handler</a>, <a href="../../ipv6/uip-icmp6.h.html#66">ICMP6_RPL</a>, <a href="rpl-private.h.html#71">RPL_CODE_DIS</a>, <a href="rpl-icmp6.c.html#213">dis_input</a>);</div><div id="96" class="line none">   96 <a href="../../ipv6/uip-icmp6.h.html#202">UIP_ICMP6_HANDLER</a>(<a href="rpl-icmp6.c.html#96">dio_handler</a>, <a href="../../ipv6/uip-icmp6.h.html#66">ICMP6_RPL</a>, <a href="rpl-private.h.html#72">RPL_CODE_DIO</a>, <a href="rpl-icmp6.c.html#283">dio_input</a>);</div><div id="97" class="line none">   97 <a href="../../ipv6/uip-icmp6.h.html#202">UIP_ICMP6_HANDLER</a>(<a href="rpl-icmp6.c.html#97">dao_handler</a>, <a href="../../ipv6/uip-icmp6.h.html#66">ICMP6_RPL</a>, <a href="rpl-private.h.html#73">RPL_CODE_DAO</a>, <a href="rpl-icmp6.c.html#1132">dao_input</a>);</div><div id="98" class="line none">   98 <a href="../../ipv6/uip-icmp6.h.html#202">UIP_ICMP6_HANDLER</a>(<a href="rpl-icmp6.c.html#98">dao_ack_handler</a>, <a href="../../ipv6/uip-icmp6.h.html#66">ICMP6_RPL</a>, <a href="rpl-private.h.html#74">RPL_CODE_DAO_ACK</a>, <a href="rpl-icmp6.c.html#1388">dao_ack_input</a>);</div><div id="99" class="line none">   99 /*---------------------------------------------------------------------------*/</div><div id="100" class="line none">  100 </div><div id="101" class="line none">  101 #if RPL_WITH_DAO_ACK</div><div id="102" class="line none">  102 static <a href="../../ipv6/uip-ds6-route.h.html#184">uip_ds6_route_t</a> *</div><div id="103" class="line none">  103 <a href="rpl-icmp6.c.html#103">find_route_entry_by_dao_ack</a>(uint8_t seq)</div><div id="104" class="line none">  104 {</div><div id="105" class="line none">  105   <a href="../../ipv6/uip-ds6-route.h.html#184">uip_ds6_route_t</a> *re = uip_ds6_route_head();</div><div id="106" class="line none">  106   while(re != NULL) {</div><div id="107" class="line none">  107     if(re-&gt;<a href="../../ipv6/uip-ds6-nbr.h.html#112">state</a>.<a href="../../ipv6/uip-ds6-route.h.html#158">dao_seqno_out</a> == seq &amp;&amp; <a href="../../ipv6/uip-ds6-route.h.html#132">RPL_ROUTE_IS_DAO_PENDING</a>(re)) {</div><div id="108" class="line none">  108       /* found it! */</div><div id="109" class="line none">  109       return re;</div><div id="110" class="line none">  110     }</div><div id="111" class="line none">  111     re = uip_ds6_route_next(re);</div><div id="112" class="line none">  112   }</div><div id="113" class="line none">  113   return NULL;</div><div id="114" class="line none">  114 }</div><div id="115" class="line none">  115 #endif /* RPL_WITH_DAO_ACK */</div><div id="116" class="line none">  116 </div><div id="117" class="line none">  117 #if RPL_WITH_STORING</div><div id="118" class="line none">  118 /* Prepare for the forwarding of a DAO. */</div><div id="119" class="line none">  119 static uint8_t</div><div id="120" class="line none">  120 <a href="rpl-icmp6.c.html#120">prepare_for_dao_fwd</a>(uint8_t sequence, <a href="../../ipv6/uip-ds6-route.h.html#184">uip_ds6_route_t</a> *rep)</div><div id="121" class="line none">  121 {</div><div id="122" class="line none">  122   /* Not pending, or pending but not a retransmission. */</div><div id="123" class="line none">  123   <a href="rpl-private.h.html#215">RPL_LOLLIPOP_INCREMENT</a>(<a href="rpl-icmp6.c.html#88">dao_sequence</a>);</div><div id="124" class="line none">  124 </div><div id="125" class="line none">  125   /* Set DAO pending and sequence numbers. */</div><div id="126" class="line none">  126   rep-&gt;<a href="../../ipv6/uip-ds6-nbr.h.html#112">state</a>.<a href="../../ipv6/uip-ds6-route.h.html#159">dao_seqno_in</a> = sequence;</div><div id="127" class="line none">  127   rep-&gt;<a href="../../ipv6/uip-ds6-nbr.h.html#112">state</a>.<a href="../../ipv6/uip-ds6-route.h.html#158">dao_seqno_out</a> = <a href="rpl-icmp6.c.html#88">dao_sequence</a>;</div><div id="128" class="line none">  128   <a href="../../ipv6/uip-ds6-route.h.html#134">RPL_ROUTE_SET_DAO_PENDING</a>(rep);</div><div id="129" class="line none">  129   return <a href="rpl-icmp6.c.html#88">dao_sequence</a>;</div><div id="130" class="line none">  130 }</div><div id="131" class="line none">  131 #endif /* RPL_WITH_STORING */</div><div id="132" class="line none">  132 /*---------------------------------------------------------------------------*/</div><div id="133" class="line none">  133 static int</div><div id="134" class="line none">  134 <a href="rpl-icmp6.c.html#134">get_global_addr</a>(<a href="../../ipv6/uip.h.html#105">uip_ipaddr_t</a> *<a href="../../ipv6/uip.h.html#113">addr</a>)</div><div id="135" class="line none">  135 {</div><div id="136" class="line none">  136   int i;</div><div id="137" class="line none">  137   int <a href="../../ipv6/uip-ds6-nbr.h.html#112">state</a>;</div><div id="138" class="line none">  138   <a href="../../ipv6/uip.h.html#105">uip_ipaddr_t</a> *<a href="rpl.h.html#129">prefix</a> = NULL;</div><div id="139" class="line none">  139   uint8_t prefix_length = 0;</div><div id="140" class="line none">  140   <a href="rpl.h.html#153">rpl_dag_t</a> *<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a> = <a href="rpl.h.html#278">rpl_get_any_dag</a>();</div><div id="141" class="line none">  141 </div><div id="142" class="line none">  142   if(<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a> != NULL &amp;&amp; <a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="rpl-private.h.html#246">prefix_info</a>.<a href="../../ipv6/uip-ds6-route.h.html#183">length</a> != 0) {</div><div id="143" class="line none">  143     <a href="rpl.h.html#129">prefix</a> = &amp;<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="rpl-private.h.html#246">prefix_info</a>.<a href="rpl.h.html#129">prefix</a>;</div><div id="144" class="line none">  144     prefix_length = <a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="rpl-private.h.html#246">prefix_info</a>.<a href="../../ipv6/uip-ds6-route.h.html#183">length</a>;</div><div id="145" class="line none">  145   }</div><div id="146" class="line none">  146 </div><div id="147" class="line none">  147   for(i = 0; i &lt; <a href="../../ipv6/uip-ds6.h.html#119">UIP_DS6_ADDR_NB</a>; i++) {</div><div id="148" class="line none">  148     <a href="../../ipv6/uip-ds6-nbr.h.html#112">state</a> = <a href="../../ipv6/uip-ds6.h.html#257">uip_ds6_if</a>.<a href="../../ipv6/uip-ds6.h.html#237">addr_list</a>[i].<a href="../../ipv6/uip-ds6-nbr.h.html#112">state</a>;</div><div id="149" class="line none">  149     if(<a href="../../ipv6/uip-ds6.h.html#257">uip_ds6_if</a>.<a href="../../ipv6/uip-ds6.h.html#237">addr_list</a>[i].<a href="../../ipv6/uip-ds6.h.html#187">isused</a> &amp;&amp;</div><div id="150" class="line none">  150        <a href="../../ipv6/uip-ds6-nbr.h.html#112">state</a> == <a href="../../ipv6/uip-ds6.h.html#157">ADDR_PREFERRED</a> &amp;&amp;</div><div id="151" class="line none">  151        !<a href="../../ipv6/uip.h.html#1792">uip_is_addr_linklocal</a>(&amp;<a href="../../ipv6/uip-ds6.h.html#257">uip_ds6_if</a>.<a href="../../ipv6/uip-ds6.h.html#237">addr_list</a>[i].<a href="../../ipv6/uip-ds6-nbr.h.html#110">ipaddr</a>) &amp;&amp;</div><div id="152" class="line none">  152        (<a href="rpl.h.html#129">prefix</a> == NULL || <a href="../../ipv6/uip.h.html#1035">uip_ipaddr_prefixcmp</a>(<a href="rpl.h.html#129">prefix</a>, &amp;<a href="../../ipv6/uip-ds6.h.html#257">uip_ds6_if</a>.<a href="../../ipv6/uip-ds6.h.html#237">addr_list</a>[i].<a href="../../ipv6/uip-ds6-nbr.h.html#110">ipaddr</a>, prefix_length))) {</div><div id="153" class="line none">  153       memcpy(<a href="../../ipv6/uip.h.html#113">addr</a>, &amp;<a href="../../ipv6/uip-ds6.h.html#257">uip_ds6_if</a>.<a href="../../ipv6/uip-ds6.h.html#237">addr_list</a>[i].<a href="../../ipv6/uip-ds6-nbr.h.html#110">ipaddr</a>, sizeof(<a href="../../ipv6/uip.h.html#105">uip_ipaddr_t</a>));</div><div id="154" class="line none">  154       return 1;</div><div id="155" class="line none">  155     }</div><div id="156" class="line none">  156   }</div><div id="157" class="line none">  157   return 0;</div><div id="158" class="line none">  158 }</div><div id="159" class="line none">  159 /*---------------------------------------------------------------------------*/</div><div id="160" class="line none">  160 static uint32_t</div><div id="161" class="line none">  161 <a href="rpl-icmp6.c.html#161">get32</a>(uint8_t *buffer, int pos)</div><div id="162" class="line none">  162 {</div><div id="163" class="line hit">  163   return (uint32_t)buffer[pos] &lt;&lt; 24 | (uint32_t)buffer[pos + 1] &lt;&lt; 16 |</div><div id="164" class="line hit">  164          (uint32_t)buffer[pos + 2] &lt;&lt; 8 | buffer[pos + 3];</div><div id="165" class="line hit">  165 }</div><div id="166" class="line none">  166 /*---------------------------------------------------------------------------*/</div><div id="167" class="line none">  167 static void</div><div id="168" class="line none">  168 <a href="rpl-icmp6.c.html#168">set32</a>(uint8_t *buffer, int pos, uint32_t value)</div><div id="169" class="line none">  169 {</div><div id="170" class="line none">  170   buffer[pos++] = value &gt;&gt; 24;</div><div id="171" class="line none">  171   buffer[pos++] = (value &gt;&gt; 16) &amp; 0xff;</div><div id="172" class="line none">  172   buffer[pos++] = (value &gt;&gt; 8) &amp; 0xff;</div><div id="173" class="line none">  173   buffer[pos++] = value &amp; 0xff;</div><div id="174" class="line none">  174 }</div><div id="175" class="line none">  175 /*---------------------------------------------------------------------------*/</div><div id="176" class="line none">  176 static uint16_t</div><div id="177" class="line none">  177 <a href="rpl-icmp6.c.html#177">get16</a>(uint8_t *buffer, int pos)</div><div id="178" class="line none">  178 {</div><div id="179" class="line hit">  179   return (uint16_t)buffer[pos] &lt;&lt; 8 | buffer[pos + 1];</div><div id="180" class="line hit">  180 }</div><div id="181" class="line none">  181 /*---------------------------------------------------------------------------*/</div><div id="182" class="line none">  182 static void</div><div id="183" class="line none">  183 <a href="rpl-icmp6.c.html#183">set16</a>(uint8_t *buffer, int pos, uint16_t value)</div><div id="184" class="line none">  184 {</div><div id="185" class="line none">  185   buffer[pos++] = value &gt;&gt; 8;</div><div id="186" class="line none">  186   buffer[pos++] = value &amp; 0xff;</div><div id="187" class="line none">  187 }</div><div id="188" class="line none">  188 /*---------------------------------------------------------------------------*/</div><div id="189" class="line none">  189 <a href="../../ipv6/uip-ds6-nbr.h.html#122">uip_ds6_nbr_t</a> *</div><div id="190" class="line none">  190 <a href="rpl-icmp6.c.html#190">rpl_icmp6_update_nbr_table</a>(<a href="../../ipv6/uip.h.html#105">uip_ipaddr_t</a> *from, <a href="../../nbr-table.h.html#54">nbr_table_reason_t</a> reason,</div><div id="191" class="line none">  191                            void *<a href="../../nbr-table.h.html#87">data</a>)</div><div id="192" class="line none">  192 {</div><div id="193" class="line none">  193   <a href="../../ipv6/uip-ds6-nbr.h.html#122">uip_ds6_nbr_t</a> *nbr;</div><div id="194" class="line none">  194 </div><div id="195" class="line none">  195   nbr = <a href="../../ipv6/uip-ds6-nbr.h.html#198">uip_ds6_nbr_lookup</a>(from);</div><div id="196" class="line none">  196   if(nbr == NULL) {</div><div id="197" class="line none">  197     nbr = <a href="../../ipv6/uip-ds6-nbr.h.html#140">uip_ds6_nbr_add</a>(from,</div><div id="198" class="line none">  198                           (<a href="../../ipv6/uip.h.html#138">uip_lladdr_t</a> *)<a href="../../packetbuf.h.html#258">packetbuf_addr</a>(<a href="../../packetbuf.h.html#243">PACKETBUF_ADDR_SENDER</a>),</div><div id="199" class="line none">  199                           0, <a href="../../ipv6/uip-ds6-nbr.h.html#65">NBR_REACHABLE</a>, reason, <a href="../../nbr-table.h.html#87">data</a>);</div><div id="200" class="line none">  200     if(nbr != NULL) {</div><div id="201" class="line none">  201       <a href="../../../sys/log.h.html#200">LOG_INFO</a>("Neighbor added to neighbor cache ");</div><div id="202" class="line none">  202       <a href="../../../sys/log.h.html#218">LOG_INFO_6ADDR</a>(from);</div><div id="203" class="line none">  203       <a href="../../../sys/log.h.html#206">LOG_INFO_</a>(", ");</div><div id="204" class="line none">  204       <a href="../../../sys/log.h.html#212">LOG_INFO_LLADDR</a>(<a href="../../packetbuf.h.html#258">packetbuf_addr</a>(<a href="../../packetbuf.h.html#243">PACKETBUF_ADDR_SENDER</a>));</div><div id="205" class="line none">  205       <a href="../../../sys/log.h.html#206">LOG_INFO_</a>("\n");</div><div id="206" class="line none">  206     }</div><div id="207" class="line none">  207   }</div><div id="208" class="line none">  208 </div><div id="209" class="line none">  209   return nbr;</div><div id="210" class="line none">  210 }</div><div id="211" class="line none">  211 /*---------------------------------------------------------------------------*/</div><div id="212" class="line none">  212 static void</div><div id="213" class="line none">  213 <a href="rpl-icmp6.c.html#213">dis_input</a>(void)</div><div id="214" class="line none">  214 {</div><div id="215" class="line none">  215   <a href="rpl.h.html#154">rpl_instance_t</a> *<a href="../../ipv6/uip.h.html#1631">instance</a>;</div><div id="216" class="line none">  216   <a href="rpl.h.html#154">rpl_instance_t</a> *end;</div><div id="217" class="line none">  217 </div><div id="218" class="line none">  218   /* DAG Information Solicitation */</div><div id="219" class="line none">  219   <a href="../../../sys/log.h.html#200">LOG_INFO</a>("Received a DIS from ");</div><div id="220" class="line none">  220   <a href="../../../sys/log.h.html#218">LOG_INFO_6ADDR</a>(&amp;<a href="../../ipv6/uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="../../ipv6/uip.h.html#1537">srcipaddr</a>);</div><div id="221" class="line none">  221   <a href="../../../sys/log.h.html#206">LOG_INFO_</a>("\n");</div><div id="222" class="line none">  222 </div><div id="223" class="line none">  223   for(<a href="../../ipv6/uip.h.html#1631">instance</a> = &amp;<a href="rpl-private.h.html#294">instance_table</a>[0], end = <a href="../../ipv6/uip.h.html#1631">instance</a> + RPL_MAX_INSTANCES;</div><div id="224" class="line none">  224       <a href="../../ipv6/uip.h.html#1631">instance</a> &lt; end; ++<a href="../../ipv6/uip.h.html#1631">instance</a>) {</div><div id="225" class="line none">  225     if(<a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl.h.html#144">used</a> == 1) {</div><div id="226" class="line none">  226       if(<a href="../../ipv6/uip.h.html#1886">uip_is_addr_mcast</a>(&amp;<a href="../../ipv6/uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="../../ipv6/uip.h.html#1537">destipaddr</a>)) {</div><div id="227" class="line none">  227 #if RPL_LEAF_ONLY</div><div id="228" class="line none">  228         <a href="../../../sys/log.h.html#200">LOG_INFO</a>("LEAF ONLY Multicast DIS will NOT reset DIO timer\n");</div><div id="229" class="line none">  229 #else /* !RPL_LEAF_ONLY */</div><div id="230" class="line none">  230         <a href="../../../sys/log.h.html#201">LOG_DBG</a>("Multicast DIS =&gt; reset DIO timer\n");</div><div id="231" class="line none">  231         <a href="rpl-private.h.html#350">rpl_reset_dio_timer</a>(<a href="../../ipv6/uip.h.html#1631">instance</a>);</div><div id="232" class="line none">  232 #endif /* !RPL_LEAF_ONLY */</div><div id="233" class="line none">  233       } else {</div><div id="234" class="line none">  234         /* Check if this neighbor should be added according to the policy. */</div><div id="235" class="line none">  235         if(<a href="rpl-icmp6.c.html#190">rpl_icmp6_update_nbr_table</a>(&amp;<a href="../../ipv6/uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="../../ipv6/uip.h.html#1537">srcipaddr</a>,</div><div id="236" class="line none">  236                                       <a href="../../nbr-table.h.html#46">NBR_TABLE_REASON_RPL_DIS</a>, NULL) == NULL) {</div><div id="237" class="line none">  237           <a href="../../../sys/log.h.html#198">LOG_ERR</a>("Out of Memory, not sending unicast DIO, DIS from ");</div><div id="238" class="line none">  238           <a href="../../../sys/log.h.html#216">LOG_ERR_6ADDR</a>(&amp;<a href="../../ipv6/uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="../../ipv6/uip.h.html#1537">srcipaddr</a>);</div><div id="239" class="line none">  239           <a href="../../../sys/log.h.html#204">LOG_ERR_</a>(", ");</div><div id="240" class="line none">  240           <a href="../../../sys/log.h.html#210">LOG_ERR_LLADDR</a>(<a href="../../packetbuf.h.html#258">packetbuf_addr</a>(<a href="../../packetbuf.h.html#243">PACKETBUF_ADDR_SENDER</a>));</div><div id="241" class="line none">  241           <a href="../../../sys/log.h.html#204">LOG_ERR_</a>("\n");</div><div id="242" class="line none">  242         } else {</div><div id="243" class="line none">  243           <a href="../../../sys/log.h.html#201">LOG_DBG</a>("Unicast DIS, reply to sender\n");</div><div id="244" class="line none">  244           <a href="rpl-icmp6.c.html#505">dio_output</a>(<a href="../../ipv6/uip.h.html#1631">instance</a>, &amp;<a href="../../ipv6/uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="../../ipv6/uip.h.html#1537">srcipaddr</a>);</div><div id="245" class="line none">  245         }</div><div id="246" class="line none">  246       }</div><div id="247" class="line none">  247     }</div><div id="248" class="line none">  248   }</div><div id="249" class="line none">  249   <a href="../../ipv6/uipbuf.h.html#42">uipbuf_clear</a>();</div><div id="250" class="line none">  250 }</div><div id="251" class="line none">  251 /*---------------------------------------------------------------------------*/</div><div id="252" class="line none">  252 void</div><div id="253" class="line none">  253 <a href="rpl-icmp6.c.html#253">dis_output</a>(<a href="../../ipv6/uip.h.html#105">uip_ipaddr_t</a> *<a href="../../ipv6/uip.h.html#113">addr</a>)</div><div id="254" class="line none">  254 {</div><div id="255" class="line none">  255   unsigned char *buffer;</div><div id="256" class="line none">  256   <a href="../../ipv6/uip.h.html#105">uip_ipaddr_t</a> tmpaddr;</div><div id="257" class="line none">  257 </div><div id="258" class="line none">  258   /*</div><div id="259" class="line none">  259    * DAG Information Solicitation  - 2 bytes reserved</div><div id="260" class="line none">  260    *      0                   1                   2</div><div id="261" class="line none">  261    *      0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3</div><div id="262" class="line none">  262    *     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div id="263" class="line none">  263    *     |     Flags     |   Reserved    |   Option(s)...</div><div id="264" class="line none">  264    *     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div id="265" class="line none">  265    */</div><div id="266" class="line none">  266 </div><div id="267" class="line none">  267   buffer = <a href="../../ipv6/uip.h.html#78">UIP_ICMP_PAYLOAD</a>;</div><div id="268" class="line none">  268   buffer[0] = buffer[1] = 0;</div><div id="269" class="line none">  269 </div><div id="270" class="line none">  270   if(<a href="../../ipv6/uip.h.html#113">addr</a> == NULL) {</div><div id="271" class="line none">  271     <a href="rpl-private.h.html#67">uip_create_linklocal_rplnodes_mcast</a>(&amp;tmpaddr);</div><div id="272" class="line none">  272     <a href="../../ipv6/uip.h.html#113">addr</a> = &amp;tmpaddr;</div><div id="273" class="line none">  273   }</div><div id="274" class="line none">  274 </div><div id="275" class="line none">  275   <a href="../../../sys/log.h.html#200">LOG_INFO</a>("Sending a DIS to ");</div><div id="276" class="line none">  276   <a href="../../../sys/log.h.html#218">LOG_INFO_6ADDR</a>(<a href="../../ipv6/uip.h.html#113">addr</a>);</div><div id="277" class="line none">  277   <a href="../../../sys/log.h.html#206">LOG_INFO_</a>("\n");</div><div id="278" class="line none">  278 </div><div id="279" class="line none">  279   <a href="../../ipv6/uip-icmp6.h.html#130">uip_icmp6_send</a>(<a href="../../ipv6/uip.h.html#113">addr</a>, <a href="../../ipv6/uip-icmp6.h.html#66">ICMP6_RPL</a>, <a href="rpl-private.h.html#71">RPL_CODE_DIS</a>, 2);</div><div id="280" class="line none">  280 }</div><div id="281" class="line none">  281 /*---------------------------------------------------------------------------*/</div><div id="282" class="line none">  282 void</div><div id="283" class="line none">  283 <a href="rpl-icmp6.c.html#283">dio_input</a>(void)</div><div id="284" class="line none">  284 {</div><div id="285" class="line hit">  285   unsigned char *buffer;</div><div id="286" class="line hit">  286   uint16_t buffer_length;</div><div id="287" class="line hit">  287   <a href="rpl-private.h.html#249">rpl_dio_t</a> dio;</div><div id="288" class="line hit">  288   uint8_t subopt_type;</div><div id="289" class="line hit">  289   int i;</div><div id="290" class="line hit">  290   int <a href="../../ipv6/uip.h.html#1268">len</a>;</div><div id="291" class="line hit">  291   <a href="../../ipv6/uip.h.html#105">uip_ipaddr_t</a> from;</div><div id="292" class="line none">  292 </div><div id="293" class="line hit">  293   memset(&amp;dio, 0, sizeof(dio));</div><div id="294" class="line none">  294 </div><div id="295" class="line none">  295   /* Set default values in case the DIO configuration option is missing. */</div><div id="296" class="line hit">  296   dio.<a href="rpl-private.h.html#238">dag_intdoubl</a> = RPL_DIO_INTERVAL_DOUBLINGS;</div><div id="297" class="line hit">  297   dio.<a href="rpl-private.h.html#239">dag_intmin</a> = RPL_DIO_INTERVAL_MIN;</div><div id="298" class="line hit">  298   dio.<a href="rpl-private.h.html#240">dag_redund</a> = RPL_DIO_REDUNDANCY;</div><div id="299" class="line hit">  299   dio.<a href="rpl-private.h.html#244">dag_min_hoprankinc</a> = <a href="rpl-private.h.html#170">RPL_MIN_HOPRANKINC</a>;</div><div id="300" class="line hit">  300   dio.<a href="rpl-private.h.html#243">dag_max_rankinc</a> = <a href="rpl-private.h.html#179">RPL_MAX_RANKINC</a>;</div><div id="301" class="line hit">  301   dio.<a href="rpl-private.h.html#230">ocp</a> = RPL_OF_OCP;</div><div id="302" class="line hit">  302   dio.<a href="rpl-private.h.html#241">default_lifetime</a> = RPL_DEFAULT_LIFETIME;</div><div id="303" class="line hit">  303   dio.<a href="rpl-private.h.html#242">lifetime_unit</a> = RPL_DEFAULT_LIFETIME_UNIT;</div><div id="304" class="line none">  304 </div><div id="305" class="line hit">  305   <a href="../../ipv6/uip.h.html#969">uip_ipaddr_copy</a>(&amp;from, &amp;<a href="../../ipv6/uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="../../ipv6/uip.h.html#1537">srcipaddr</a>);</div><div id="306" class="line none">  306 </div><div id="307" class="line none">  307   /* DAG Information Object */</div><div id="308" class="line both">  308   <a href="../../../sys/log.h.html#200">LOG_INFO</a>("Received a DIO from ");</div><div id="309" class="line both">  309   <a href="../../../sys/log.h.html#218">LOG_INFO_6ADDR</a>(&amp;from);</div><div id="310" class="line both">  310   <a href="../../../sys/log.h.html#206">LOG_INFO_</a>("\n");</div><div id="311" class="line none">  311 </div><div id="312" class="line hit">  312   buffer_length = <a href="../../ipv6/uip.h.html#1232">uip_len</a> - <a href="../../ipv6/uip.h.html#66">uip_l3_icmp_hdr_len</a>;</div><div id="313" class="line none">  313 </div><div id="314" class="line hit">  314   if(buffer_length &lt; 8 + sizeof(dio.<a href="rpl-private.h.html#229">dag_id</a>)) {</div><div id="315" class="line both">  315     <a href="../../../sys/log.h.html#199">LOG_WARN</a>("dio_input: invalid DIO header, len %" PRIu16 ", discard\n",</div><div id="316" class="line none">  316              buffer_length);</div><div id="317" class="line hit">  317     goto discard;</div><div id="318" class="line none">  318   }</div><div id="319" class="line none">  319 </div><div id="320" class="line none">  320   /* Process the DIO base option. */</div><div id="321" class="line hit">  321   i = 0;</div><div id="322" class="line hit">  322   buffer = <a href="../../ipv6/uip.h.html#78">UIP_ICMP_PAYLOAD</a>;</div><div id="323" class="line none">  323 </div><div id="324" class="line hit">  324   dio.<a href="rpl-private.h.html#236">instance_id</a> = buffer[i++];</div><div id="325" class="line hit">  325   dio.<a href="rpl-private.h.html#235">version</a> = buffer[i++];</div><div id="326" class="line hit">  326   dio.<a href="rpl-private.h.html#231">rank</a> = <a href="rpl-icmp6.c.html#177">get16</a>(buffer, i);</div><div id="327" class="line hit">  327   i += 2;</div><div id="328" class="line none">  328 </div><div id="329" class="line both">  329   <a href="../../../sys/log.h.html#201">LOG_DBG</a>("Incoming DIO (id, ver, rank) = (%u,%u,%u)\n",</div><div id="330" class="line none">  330           (unsigned)dio.<a href="rpl-private.h.html#236">instance_id</a>,</div><div id="331" class="line none">  331           (unsigned)dio.<a href="rpl-private.h.html#235">version</a>,</div><div id="332" class="line none">  332           (unsigned)dio.<a href="rpl-private.h.html#231">rank</a>);</div><div id="333" class="line none">  333 </div><div id="334" class="line hit">  334   dio.<a href="rpl-private.h.html#232">grounded</a> = buffer[i] &amp; <a href="rpl-icmp6.c.html#65">RPL_DIO_GROUNDED</a>;</div><div id="335" class="line hit">  335   dio.<a href="rpl-private.h.html#233">mop</a> = (buffer[i] &amp; <a href="rpl-icmp6.c.html#67">RPL_DIO_MOP_MASK</a>) &gt;&gt; <a href="rpl-icmp6.c.html#66">RPL_DIO_MOP_SHIFT</a>;</div><div id="336" class="line hit">  336   dio.<a href="rpl-private.h.html#234">preference</a> = buffer[i++] &amp; <a href="rpl-icmp6.c.html#68">RPL_DIO_PREFERENCE_MASK</a>;</div><div id="337" class="line none">  337 </div><div id="338" class="line hit">  338   dio.<a href="rpl-private.h.html#237">dtsn</a> = buffer[i++];</div><div id="339" class="line none">  339   /* two reserved bytes */</div><div id="340" class="line hit">  340   i += 2;</div><div id="341" class="line none">  341 </div><div id="342" class="line hit">  342   memcpy(&amp;dio.<a href="rpl-private.h.html#229">dag_id</a>, buffer + i, sizeof(dio.<a href="rpl-private.h.html#229">dag_id</a>));</div><div id="343" class="line hit">  343   i += sizeof(dio.<a href="rpl-private.h.html#229">dag_id</a>);</div><div id="344" class="line none">  344 </div><div id="345" class="line both">  345   <a href="../../../sys/log.h.html#201">LOG_DBG</a>("Incoming DIO (dag_id, pref) = (");</div><div id="346" class="line both">  346   <a href="../../../sys/log.h.html#219">LOG_DBG_6ADDR</a>(&amp;dio.<a href="rpl-private.h.html#229">dag_id</a>);</div><div id="347" class="line both">  347   <a href="../../../sys/log.h.html#207">LOG_DBG_</a>(", %u)\n", dio.<a href="rpl-private.h.html#234">preference</a>);</div><div id="348" class="line none">  348 </div><div id="349" class="line none">  349   /* Check if there are any DIO suboptions. */</div><div id="350" class="line hit">  350   for(; i &lt; buffer_length; i += <a href="../../ipv6/uip.h.html#1268">len</a>) {</div><div id="351" class="line hit">  351     subopt_type = buffer[i];</div><div id="352" class="line hit">  352     if(subopt_type == <a href="rpl-private.h.html#81">RPL_OPTION_PAD1</a>) {</div><div id="353" class="line hit">  353       <a href="../../ipv6/uip.h.html#1268">len</a> = 1;</div><div id="354" class="line hit">  354     } else {</div><div id="355" class="line none">  355       /* Suboption with a two-byte header + payload. */</div><div id="356" class="line hit">  356       if(i + 1 &gt;= buffer_length) {</div><div id="357" class="line both">  357         <a href="../../../sys/log.h.html#198">LOG_ERR</a>("dio_input: malformed packet, discard\n");</div><div id="358" class="line hit">  358         goto discard;</div><div id="359" class="line none">  359       }</div><div id="360" class="line hit">  360       <a href="../../ipv6/uip.h.html#1268">len</a> = 2 + buffer[i + 1];</div><div id="361" class="line none">  361     }</div><div id="362" class="line none">  362 </div><div id="363" class="line hit">  363     if(<a href="../../ipv6/uip.h.html#1268">len</a> + i &gt; buffer_length) {</div><div id="364" class="line both">  364       <a href="../../../sys/log.h.html#199">LOG_WARN</a>("Invalid DIO packet\n");</div><div id="365" class="line none">  365       <a href="rpl-private.h.html#287">RPL_STAT</a>(<a href="rpl-private.h.html#253">rpl_stats</a>.<a href="rpl-private.h.html#257">malformed_msgs</a>++);</div><div id="366" class="line hit">  366       goto discard;</div><div id="367" class="line none">  367     }</div><div id="368" class="line none">  368 </div><div id="369" class="line both">  369     <a href="../../../sys/log.h.html#201">LOG_DBG</a>("Incoming DIO (option, length) = (%u, %u)\n",</div><div id="370" class="line none">  370             subopt_type, <a href="../../ipv6/uip.h.html#1268">len</a>);</div><div id="371" class="line none">  371 </div><div id="372" class="line hit">  372     switch(subopt_type) {</div><div id="373" class="line none">  373     case <a href="rpl-private.h.html#81">RPL_OPTION_PAD1</a>:</div><div id="374" class="line hit">  374     case <a href="rpl-private.h.html#82">RPL_OPTION_PADN</a>:</div><div id="375" class="line both">  375       <a href="../../../sys/log.h.html#201">LOG_DBG</a>("PAD %u bytes\n", <a href="../../ipv6/uip.h.html#1268">len</a>);</div><div id="376" class="line hit">  376       break;</div><div id="377" class="line hit">  377     case <a href="rpl-private.h.html#83">RPL_OPTION_DAG_METRIC_CONTAINER</a>:</div><div id="378" class="line hit">  378       if(<a href="../../ipv6/uip.h.html#1268">len</a> &lt; 6) {</div><div id="379" class="line both">  379         <a href="../../../sys/log.h.html#199">LOG_WARN</a>("Invalid DAG MC, len = %d\n", <a href="../../ipv6/uip.h.html#1268">len</a>);</div><div id="380" class="line none">  380         <a href="rpl-private.h.html#287">RPL_STAT</a>(<a href="rpl-private.h.html#253">rpl_stats</a>.<a href="rpl-private.h.html#257">malformed_msgs</a>++);</div><div id="381" class="line hit">  381         goto discard;</div><div id="382" class="line none">  382       }</div><div id="383" class="line hit">  383       dio.<a href="rpl-private.h.html#247">mc</a>.<a href="../../ipv6/uip-ds6.h.html#209">type</a> = buffer[i + 2];</div><div id="384" class="line hit">  384       dio.<a href="rpl-private.h.html#247">mc</a>.<a href="../../ipv6/uip.h.html#1630">flags</a> = buffer[i + 3] &lt;&lt; 1;</div><div id="385" class="line hit">  385       dio.<a href="rpl-private.h.html#247">mc</a>.<a href="../../ipv6/uip.h.html#1630">flags</a> |= buffer[i + 4] &gt;&gt; 7;</div><div id="386" class="line hit">  386       dio.<a href="rpl-private.h.html#247">mc</a>.<a href="rpl.h.html#100">aggr</a> = (buffer[i + 4] &gt;&gt; 4) &amp; 0x3;</div><div id="387" class="line hit">  387       dio.<a href="rpl-private.h.html#247">mc</a>.<a href="rpl.h.html#101">prec</a> = buffer[i + 4] &amp; 0xf;</div><div id="388" class="line hit">  388       dio.<a href="rpl-private.h.html#247">mc</a>.<a href="../../ipv6/uip-ds6-route.h.html#183">length</a> = buffer[i + 5];</div><div id="389" class="line none">  389 </div><div id="390" class="line hit">  390       if(dio.<a href="rpl-private.h.html#247">mc</a>.<a href="../../ipv6/uip-ds6.h.html#209">type</a> == <a href="rpl.h.html#52">RPL_DAG_MC_NONE</a>) {</div><div id="391" class="line none">  391         /* No metric container: do nothing. */</div><div id="392" class="line hit">  392       } else if(dio.<a href="rpl-private.h.html#247">mc</a>.<a href="../../ipv6/uip-ds6.h.html#209">type</a> == <a href="rpl.h.html#59">RPL_DAG_MC_ETX</a>) {</div><div id="393" class="line hit">  393         if(<a href="../../ipv6/uip.h.html#1268">len</a> &lt; 8) {</div><div id="394" class="line both">  394           <a href="../../../sys/log.h.html#199">LOG_WARN</a>("dio_input: invalid DAG MC, len %u, discard\n", <a href="../../ipv6/uip.h.html#1268">len</a>);</div><div id="395" class="line hit">  395           goto discard;</div><div id="396" class="line none">  396         }</div><div id="397" class="line hit">  397         dio.<a href="rpl-private.h.html#247">mc</a>.<a href="rpl.h.html#106">obj</a>.<a href="rpl.h.html#105">etx</a> = <a href="rpl-icmp6.c.html#177">get16</a>(buffer, i + 6);</div><div id="398" class="line none">  398 </div><div id="399" class="line both">  399         <a href="../../../sys/log.h.html#201">LOG_DBG</a>("DAG MC: type %u, flags %u, aggr %u, prec %u, length %u, ETX %u\n",</div><div id="400" class="line none">  400                 (unsigned)dio.<a href="rpl-private.h.html#247">mc</a>.<a href="../../ipv6/uip-ds6.h.html#209">type</a>,</div><div id="401" class="line none">  401                 (unsigned)dio.<a href="rpl-private.h.html#247">mc</a>.<a href="../../ipv6/uip.h.html#1630">flags</a>,</div><div id="402" class="line none">  402                 (unsigned)dio.<a href="rpl-private.h.html#247">mc</a>.<a href="rpl.h.html#100">aggr</a>,</div><div id="403" class="line none">  403                 (unsigned)dio.<a href="rpl-private.h.html#247">mc</a>.<a href="rpl.h.html#101">prec</a>,</div><div id="404" class="line none">  404                 (unsigned)dio.<a href="rpl-private.h.html#247">mc</a>.<a href="../../ipv6/uip-ds6-route.h.html#183">length</a>,</div><div id="405" class="line none">  405                 (unsigned)dio.<a href="rpl-private.h.html#247">mc</a>.<a href="rpl.h.html#106">obj</a>.<a href="rpl.h.html#105">etx</a>);</div><div id="406" class="line hit">  406       } else if(dio.<a href="rpl-private.h.html#247">mc</a>.<a href="../../ipv6/uip-ds6.h.html#209">type</a> == <a href="rpl.h.html#54">RPL_DAG_MC_ENERGY</a>) {</div><div id="407" class="line hit">  407         if(<a href="../../ipv6/uip.h.html#1268">len</a> &lt; 8) {</div><div id="408" class="line both">  408           <a href="../../../sys/log.h.html#199">LOG_WARN</a>("dio_input: invalid DAG MC, len %u, discard\n", <a href="../../ipv6/uip.h.html#1268">len</a>);</div><div id="409" class="line hit">  409           goto discard;</div><div id="410" class="line none">  410         }</div><div id="411" class="line hit">  411         dio.<a href="rpl-private.h.html#247">mc</a>.<a href="rpl.h.html#106">obj</a>.<a href="rpl.h.html#104">energy</a>.<a href="../../ipv6/uip.h.html#1630">flags</a> = buffer[i + 6];</div><div id="412" class="line hit">  412         dio.<a href="rpl-private.h.html#247">mc</a>.<a href="rpl.h.html#106">obj</a>.<a href="rpl.h.html#104">energy</a>.<a href="rpl.h.html#93">energy_est</a> = buffer[i + 7];</div><div id="413" class="line hit">  413       } else {</div><div id="414" class="line both">  414         <a href="../../../sys/log.h.html#199">LOG_WARN</a>("Unhandled DAG MC type: %u\n", (unsigned)dio.<a href="rpl-private.h.html#247">mc</a>.<a href="../../ipv6/uip-ds6.h.html#209">type</a>);</div><div id="415" class="line hit">  415         goto discard;</div><div id="416" class="line none">  416       }</div><div id="417" class="line hit">  417       break;</div><div id="418" class="line hit">  418     case <a href="rpl-private.h.html#84">RPL_OPTION_ROUTE_INFO</a>:</div><div id="419" class="line hit">  419       if(<a href="../../ipv6/uip.h.html#1268">len</a> &lt; 8) {</div><div id="420" class="line both">  420         <a href="../../../sys/log.h.html#199">LOG_WARN</a>("dio_input: invalid route info option, len %u, discard\n",</div><div id="421" class="line none">  421                  <a href="../../ipv6/uip.h.html#1268">len</a>);</div><div id="422" class="line none">  422         <a href="rpl-private.h.html#287">RPL_STAT</a>(<a href="rpl-private.h.html#253">rpl_stats</a>.<a href="rpl-private.h.html#257">malformed_msgs</a>++);</div><div id="423" class="line hit">  423         goto discard;</div><div id="424" class="line none">  424       }</div><div id="425" class="line none">  425 </div><div id="426" class="line none">  426       /* The flags field includes the preference value. */</div><div id="427" class="line hit">  427       dio.<a href="rpl-private.h.html#245">destination_prefix</a>.<a href="../../ipv6/uip-ds6-route.h.html#183">length</a> = buffer[i + 2];</div><div id="428" class="line hit">  428       dio.<a href="rpl-private.h.html#245">destination_prefix</a>.<a href="../../ipv6/uip.h.html#1630">flags</a> = buffer[i + 3];</div><div id="429" class="line hit">  429       dio.<a href="rpl-private.h.html#245">destination_prefix</a>.<a href="../../ipv6/uip-ds6-route.h.html#156">lifetime</a> = <a href="rpl-icmp6.c.html#161">get32</a>(buffer, i + 4);</div><div id="430" class="line none">  430 </div><div id="431" class="line hit">  431       if(((dio.<a href="rpl-private.h.html#245">destination_prefix</a>.<a href="../../ipv6/uip-ds6-route.h.html#183">length</a> + 7) / 8) + 8 &lt;= <a href="../../ipv6/uip.h.html#1268">len</a> &amp;&amp;</div><div id="432" class="line none">  432          dio.<a href="rpl-private.h.html#245">destination_prefix</a>.<a href="../../ipv6/uip-ds6-route.h.html#183">length</a> &lt;= 128) {</div><div id="433" class="line both">  433         <a href="../../../sys/log.h.html#200">LOG_INFO</a>("Copying destination prefix\n");</div><div id="434" class="line hit">  434         memcpy(&amp;dio.<a href="rpl-private.h.html#245">destination_prefix</a>.<a href="rpl.h.html#129">prefix</a>, &amp;buffer[i + 8],</div><div id="435" class="line hit">  435                (dio.<a href="rpl-private.h.html#245">destination_prefix</a>.<a href="../../ipv6/uip-ds6-route.h.html#183">length</a> + 7) / 8);</div><div id="436" class="line hit">  436       } else {</div><div id="437" class="line both">  437         <a href="../../../sys/log.h.html#199">LOG_WARN</a>("Invalid route info option, len = %d\n", <a href="../../ipv6/uip.h.html#1268">len</a>);</div><div id="438" class="line none">  438         <a href="rpl-private.h.html#287">RPL_STAT</a>(<a href="rpl-private.h.html#253">rpl_stats</a>.<a href="rpl-private.h.html#257">malformed_msgs</a>++);</div><div id="439" class="line hit">  439         goto discard;</div><div id="440" class="line none">  440       }</div><div id="441" class="line none">  441 </div><div id="442" class="line hit">  442       break;</div><div id="443" class="line hit">  443     case <a href="rpl-private.h.html#85">RPL_OPTION_DAG_CONF</a>:</div><div id="444" class="line hit">  444       if(<a href="../../ipv6/uip.h.html#1268">len</a> != 16) {</div><div id="445" class="line both">  445         <a href="../../../sys/log.h.html#199">LOG_WARN</a>("Invalid DAG configuration option, len = %d\n", <a href="../../ipv6/uip.h.html#1268">len</a>);</div><div id="446" class="line none">  446         <a href="rpl-private.h.html#287">RPL_STAT</a>(<a href="rpl-private.h.html#253">rpl_stats</a>.<a href="rpl-private.h.html#257">malformed_msgs</a>++);</div><div id="447" class="line hit">  447         goto discard;</div><div id="448" class="line none">  448       }</div><div id="449" class="line none">  449 </div><div id="450" class="line none">  450       /* Path control field not yet implemented - at i + 2 */</div><div id="451" class="line hit">  451       dio.<a href="rpl-private.h.html#238">dag_intdoubl</a> = buffer[i + 3];</div><div id="452" class="line hit">  452       dio.<a href="rpl-private.h.html#239">dag_intmin</a> = buffer[i + 4];</div><div id="453" class="line hit">  453       dio.<a href="rpl-private.h.html#240">dag_redund</a> = buffer[i + 5];</div><div id="454" class="line hit">  454       dio.<a href="rpl-private.h.html#243">dag_max_rankinc</a> = <a href="rpl-icmp6.c.html#177">get16</a>(buffer, i + 6);</div><div id="455" class="line hit">  455       dio.<a href="rpl-private.h.html#244">dag_min_hoprankinc</a> = <a href="rpl-icmp6.c.html#177">get16</a>(buffer, i + 8);</div><div id="456" class="line hit">  456       dio.<a href="rpl-private.h.html#230">ocp</a> = <a href="rpl-icmp6.c.html#177">get16</a>(buffer, i + 10);</div><div id="457" class="line none">  457       /* buffer + 12 is reserved */</div><div id="458" class="line hit">  458       dio.<a href="rpl-private.h.html#241">default_lifetime</a> = buffer[i + 13];</div><div id="459" class="line hit">  459       dio.<a href="rpl-private.h.html#242">lifetime_unit</a> = <a href="rpl-icmp6.c.html#177">get16</a>(buffer, i + 14);</div><div id="460" class="line both">  460       <a href="../../../sys/log.h.html#200">LOG_INFO</a>("DAG conf:dbl=%d, min=%d red=%d maxinc=%d mininc=%d ocp=%d d_l=%u l_u=%u\n",</div><div id="461" class="line none">  461                dio.<a href="rpl-private.h.html#238">dag_intdoubl</a>, dio.<a href="rpl-private.h.html#239">dag_intmin</a>, dio.<a href="rpl-private.h.html#240">dag_redund</a>,</div><div id="462" class="line none">  462                dio.<a href="rpl-private.h.html#243">dag_max_rankinc</a>, dio.<a href="rpl-private.h.html#244">dag_min_hoprankinc</a>, dio.<a href="rpl-private.h.html#230">ocp</a>,</div><div id="463" class="line none">  463                dio.<a href="rpl-private.h.html#241">default_lifetime</a>, dio.<a href="rpl-private.h.html#242">lifetime_unit</a>);</div><div id="464" class="line hit">  464       break;</div><div id="465" class="line hit">  465     case <a href="rpl-private.h.html#89">RPL_OPTION_PREFIX_INFO</a>:</div><div id="466" class="line hit">  466       if(<a href="../../ipv6/uip.h.html#1268">len</a> != 32) {</div><div id="467" class="line both">  467         <a href="../../../sys/log.h.html#199">LOG_WARN</a>("Invalid DAG prefix info, len != 32\n");</div><div id="468" class="line none">  468         <a href="rpl-private.h.html#287">RPL_STAT</a>(<a href="rpl-private.h.html#253">rpl_stats</a>.<a href="rpl-private.h.html#257">malformed_msgs</a>++);</div><div id="469" class="line hit">  469         goto discard;</div><div id="470" class="line none">  470       }</div><div id="471" class="line hit">  471       dio.<a href="rpl-private.h.html#246">prefix_info</a>.<a href="../../ipv6/uip-ds6-route.h.html#183">length</a> = buffer[i + 2];</div><div id="472" class="line none">  472 </div><div id="473" class="line none">  473       // if(dio.prefix_info.length &gt; sizeof(uip_ipaddr_t) * 8) {</div><div id="474" class="line none">  474       //   LOG_WARN("Invalid DAG prefix info, len %u &gt; %u\n",</div><div id="475" class="line none">  475       //            dio.prefix_info.length, (unsigned)(sizeof(uip_ipaddr_t) * 8));</div><div id="476" class="line none">  476       //   RPL_STAT(rpl_stats.malformed_msgs++);</div><div id="477" class="line none">  477       //   goto discard;</div><div id="478" class="line none">  478       // }</div><div id="479" class="line none">  479 </div><div id="480" class="line hit">  480       dio.<a href="rpl-private.h.html#246">prefix_info</a>.<a href="../../ipv6/uip.h.html#1630">flags</a> = buffer[i + 3];</div><div id="481" class="line none">  481       /* valid lifetime is ingnored for now - at i + 4 */</div><div id="482" class="line none">  482       /* preferred lifetime stored in lifetime */</div><div id="483" class="line hit">  483       dio.<a href="rpl-private.h.html#246">prefix_info</a>.<a href="../../ipv6/uip-ds6-route.h.html#156">lifetime</a> = <a href="rpl-icmp6.c.html#161">get32</a>(buffer, i + 8);</div><div id="484" class="line none">  484       /* 32-bit reserved at i + 12 */</div><div id="485" class="line both">  485       <a href="../../../sys/log.h.html#200">LOG_INFO</a>("Copying prefix information\n");</div><div id="486" class="line hit">  486       memcpy(&amp;dio.<a href="rpl-private.h.html#246">prefix_info</a>.<a href="rpl.h.html#129">prefix</a>, &amp;buffer[i + 16], 16);</div><div id="487" class="line hit">  487       break;</div><div id="488" class="line none">  488     default:</div><div id="489" class="line both">  489       <a href="../../../sys/log.h.html#199">LOG_WARN</a>("Unsupported suboption type in DIO: %u\n",</div><div id="490" class="line none">  490                (unsigned)subopt_type);</div><div id="491" class="line none">  491     }</div><div id="492" class="line none">  492   }</div><div id="493" class="line none">  493 </div><div id="494" class="line none">  494 #ifdef RPL_DEBUG_DIO_INPUT</div><div id="495" class="line none">  495   RPL_DEBUG_DIO_INPUT(&amp;from, &amp;dio);</div><div id="496" class="line none">  496 #endif</div><div id="497" class="line none">  497 </div><div id="498" class="line hit">  498   <a href="rpl-private.h.html#311">rpl_process_dio</a>(&amp;from, &amp;dio);</div><div id="499" class="line none">  499 </div><div id="500" class="line none">  500 discard:</div><div id="501" class="line hit">  501   <a href="../../ipv6/uipbuf.h.html#42">uipbuf_clear</a>();</div><div id="502" class="line hit">  502 }</div><div id="503" class="line none">  503 /*---------------------------------------------------------------------------*/</div><div id="504" class="line none">  504 void</div><div id="505" class="line none">  505 <a href="rpl-icmp6.c.html#505">dio_output</a>(<a href="rpl.h.html#154">rpl_instance_t</a> *<a href="../../ipv6/uip.h.html#1631">instance</a>, <a href="../../ipv6/uip.h.html#105">uip_ipaddr_t</a> *uc_addr)</div><div id="506" class="line none">  506 {</div><div id="507" class="line none">  507   unsigned char *buffer;</div><div id="508" class="line none">  508   int pos;</div><div id="509" class="line none">  509   int is_root;</div><div id="510" class="line none">  510   <a href="rpl.h.html#153">rpl_dag_t</a> *<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a> = <a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl.h.html#226">current_dag</a>;</div><div id="511" class="line none">  511 #if !RPL_LEAF_ONLY</div><div id="512" class="line none">  512   <a href="../../ipv6/uip.h.html#105">uip_ipaddr_t</a> <a href="../../ipv6/uip.h.html#113">addr</a>;</div><div id="513" class="line none">  513 #endif /* !RPL_LEAF_ONLY */</div><div id="514" class="line none">  514 </div><div id="515" class="line none">  515 #if RPL_LEAF_ONLY</div><div id="516" class="line none">  516   /* In leaf mode, we only send DIO messages as unicasts in response to</div><div id="517" class="line none">  517      unicast DIS messages. */</div><div id="518" class="line none">  518   if(uc_addr == NULL) {</div><div id="519" class="line none">  519     <a href="../../../sys/log.h.html#201">LOG_DBG</a>("LEAF ONLY have multicast addr: skip dio_output\n");</div><div id="520" class="line none">  520     return;</div><div id="521" class="line none">  521   }</div><div id="522" class="line none">  522 #endif /* RPL_LEAF_ONLY */</div><div id="523" class="line none">  523 </div><div id="524" class="line none">  524   /* DAG Information Object */</div><div id="525" class="line none">  525   pos = 0;</div><div id="526" class="line none">  526 </div><div id="527" class="line none">  527   buffer = <a href="../../ipv6/uip.h.html#78">UIP_ICMP_PAYLOAD</a>;</div><div id="528" class="line none">  528   buffer[pos++] = <a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl-private.h.html#236">instance_id</a>;</div><div id="529" class="line none">  529   buffer[pos++] = <a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="rpl-private.h.html#235">version</a>;</div><div id="530" class="line none">  530   is_root = (<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="rpl-private.h.html#231">rank</a> == <a href="rpl-private.h.html#191">ROOT_RANK</a>(<a href="../../ipv6/uip.h.html#1631">instance</a>));</div><div id="531" class="line none">  531 </div><div id="532" class="line none">  532 #if RPL_LEAF_ONLY</div><div id="533" class="line none">  533   <a href="../../../sys/log.h.html#201">LOG_DBG</a>("LEAF ONLY DIO rank set to RPL_INFINITE_RANK\n");</div><div id="534" class="line none">  534   <a href="rpl-icmp6.c.html#183">set16</a>(buffer, pos, <a href="rpl-private.h.html#193">RPL_INFINITE_RANK</a>);</div><div id="535" class="line none">  535 #else /* RPL_LEAF_ONLY */</div><div id="536" class="line none">  536   <a href="rpl-icmp6.c.html#183">set16</a>(buffer, pos, <a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="rpl-private.h.html#231">rank</a>);</div><div id="537" class="line none">  537 #endif /* RPL_LEAF_ONLY */</div><div id="538" class="line none">  538   pos += 2;</div><div id="539" class="line none">  539 </div><div id="540" class="line none">  540   buffer[pos] = 0;</div><div id="541" class="line none">  541   if(<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="rpl-private.h.html#232">grounded</a>) {</div><div id="542" class="line none">  542     buffer[pos] |= <a href="rpl-icmp6.c.html#65">RPL_DIO_GROUNDED</a>;</div><div id="543" class="line none">  543   }</div><div id="544" class="line none">  544 </div><div id="545" class="line none">  545   buffer[pos] |= <a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl-private.h.html#233">mop</a> &lt;&lt; <a href="rpl-icmp6.c.html#66">RPL_DIO_MOP_SHIFT</a>;</div><div id="546" class="line none">  546   buffer[pos] |= <a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="rpl-private.h.html#234">preference</a> &amp; <a href="rpl-icmp6.c.html#68">RPL_DIO_PREFERENCE_MASK</a>;</div><div id="547" class="line none">  547   pos++;</div><div id="548" class="line none">  548 </div><div id="549" class="line none">  549   buffer[pos++] = <a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl.h.html#232">dtsn_out</a>;</div><div id="550" class="line none">  550 </div><div id="551" class="line none">  551   if(RPL_DIO_REFRESH_DAO_ROUTES &amp;&amp; is_root &amp;&amp; uc_addr == NULL) {</div><div id="552" class="line none">  552     /*</div><div id="553" class="line none">  553      * Request new DAO to refresh route. We do not do this for unicast</div><div id="554" class="line none">  554      * DIO in order to avoid DAO messages after a DIS-DIO update, or</div><div id="555" class="line none">  555      * upon unicast DIO probing.</div><div id="556" class="line none">  556      */</div><div id="557" class="line none">  557     <a href="rpl-private.h.html#215">RPL_LOLLIPOP_INCREMENT</a>(<a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl.h.html#232">dtsn_out</a>);</div><div id="558" class="line none">  558   }</div><div id="559" class="line none">  559 </div><div id="560" class="line none">  560   /* reserved 2 bytes */</div><div id="561" class="line none">  561   buffer[pos++] = 0; /* flags */</div><div id="562" class="line none">  562   buffer[pos++] = 0; /* reserved */</div><div id="563" class="line none">  563 </div><div id="564" class="line none">  564   memcpy(buffer + pos, &amp;<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="rpl-private.h.html#229">dag_id</a>, sizeof(<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="rpl-private.h.html#229">dag_id</a>));</div><div id="565" class="line none">  565   pos += 16;</div><div id="566" class="line none">  566 </div><div id="567" class="line none">  567 #if !RPL_LEAF_ONLY</div><div id="568" class="line none">  568   if(<a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl-private.h.html#247">mc</a>.<a href="../../ipv6/uip-ds6.h.html#209">type</a> != <a href="rpl.h.html#52">RPL_DAG_MC_NONE</a>) {</div><div id="569" class="line none">  569     <a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl.h.html#225">of</a>-&gt;<a href="rpl.h.html#215">update_metric_container</a>(<a href="../../ipv6/uip.h.html#1631">instance</a>);</div><div id="570" class="line none">  570 </div><div id="571" class="line none">  571     buffer[pos++] = <a href="rpl-private.h.html#83">RPL_OPTION_DAG_METRIC_CONTAINER</a>;</div><div id="572" class="line none">  572     buffer[pos++] = 6;</div><div id="573" class="line none">  573     buffer[pos++] = <a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl-private.h.html#247">mc</a>.<a href="../../ipv6/uip-ds6.h.html#209">type</a>;</div><div id="574" class="line none">  574     buffer[pos++] = <a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl-private.h.html#247">mc</a>.<a href="../../ipv6/uip.h.html#1630">flags</a> &gt;&gt; 1;</div><div id="575" class="line none">  575     buffer[pos] = (<a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl-private.h.html#247">mc</a>.<a href="../../ipv6/uip.h.html#1630">flags</a> &amp; 1) &lt;&lt; 7;</div><div id="576" class="line none">  576     buffer[pos++] |= (<a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl-private.h.html#247">mc</a>.<a href="rpl.h.html#100">aggr</a> &lt;&lt; 4) | <a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl-private.h.html#247">mc</a>.<a href="rpl.h.html#101">prec</a>;</div><div id="577" class="line none">  577     if(<a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl-private.h.html#247">mc</a>.<a href="../../ipv6/uip-ds6.h.html#209">type</a> == <a href="rpl.h.html#59">RPL_DAG_MC_ETX</a>) {</div><div id="578" class="line none">  578       buffer[pos++] = 2;</div><div id="579" class="line none">  579       <a href="rpl-icmp6.c.html#183">set16</a>(buffer, pos, <a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl-private.h.html#247">mc</a>.<a href="rpl.h.html#106">obj</a>.<a href="rpl.h.html#105">etx</a>);</div><div id="580" class="line none">  580       pos += 2;</div><div id="581" class="line none">  581     } else if(<a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl-private.h.html#247">mc</a>.<a href="../../ipv6/uip-ds6.h.html#209">type</a> == <a href="rpl.h.html#54">RPL_DAG_MC_ENERGY</a>) {</div><div id="582" class="line none">  582       buffer[pos++] = 2;</div><div id="583" class="line none">  583       buffer[pos++] = <a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl-private.h.html#247">mc</a>.<a href="rpl.h.html#106">obj</a>.<a href="rpl.h.html#104">energy</a>.<a href="../../ipv6/uip.h.html#1630">flags</a>;</div><div id="584" class="line none">  584       buffer[pos++] = <a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl-private.h.html#247">mc</a>.<a href="rpl.h.html#106">obj</a>.<a href="rpl.h.html#104">energy</a>.<a href="rpl.h.html#93">energy_est</a>;</div><div id="585" class="line none">  585     } else {</div><div id="586" class="line none">  586       <a href="../../../sys/log.h.html#198">LOG_ERR</a>("Unable to send DIO because of unhandled DAG MC type %u\n",</div><div id="587" class="line none">  587               (unsigned)<a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl-private.h.html#247">mc</a>.<a href="../../ipv6/uip-ds6.h.html#209">type</a>);</div><div id="588" class="line none">  588       return;</div><div id="589" class="line none">  589     }</div><div id="590" class="line none">  590   }</div><div id="591" class="line none">  591 #endif /* !RPL_LEAF_ONLY */</div><div id="592" class="line none">  592 </div><div id="593" class="line none">  593   /* Always add a DAG configuration option. */</div><div id="594" class="line none">  594   buffer[pos++] = <a href="rpl-private.h.html#85">RPL_OPTION_DAG_CONF</a>;</div><div id="595" class="line none">  595   buffer[pos++] = 14;</div><div id="596" class="line none">  596   buffer[pos++] = 0; /* No Auth, PCS = 0 */</div><div id="597" class="line none">  597   buffer[pos++] = <a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl.h.html#234">dio_intdoubl</a>;</div><div id="598" class="line none">  598   buffer[pos++] = <a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl.h.html#235">dio_intmin</a>;</div><div id="599" class="line none">  599   buffer[pos++] = <a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl.h.html#236">dio_redundancy</a>;</div><div id="600" class="line none">  600   <a href="rpl-icmp6.c.html#183">set16</a>(buffer, pos, <a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl.h.html#246">max_rankinc</a>);</div><div id="601" class="line none">  601   pos += 2;</div><div id="602" class="line none">  602   <a href="rpl-icmp6.c.html#183">set16</a>(buffer, pos, <a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl.h.html#247">min_hoprankinc</a>);</div><div id="603" class="line none">  603   pos += 2;</div><div id="604" class="line none">  604   /* OCP is in the DAG_CONF option */</div><div id="605" class="line none">  605   <a href="rpl-icmp6.c.html#183">set16</a>(buffer, pos, <a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl.h.html#225">of</a>-&gt;<a href="rpl-private.h.html#230">ocp</a>);</div><div id="606" class="line none">  606   pos += 2;</div><div id="607" class="line none">  607   buffer[pos++] = 0; /* reserved */</div><div id="608" class="line none">  608   buffer[pos++] = <a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl-private.h.html#241">default_lifetime</a>;</div><div id="609" class="line none">  609   <a href="rpl-icmp6.c.html#183">set16</a>(buffer, pos, <a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl-private.h.html#242">lifetime_unit</a>);</div><div id="610" class="line none">  610   pos += 2;</div><div id="611" class="line none">  611 </div><div id="612" class="line none">  612   /* Check if we have a prefix to send also. */</div><div id="613" class="line none">  613   if(<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="rpl-private.h.html#246">prefix_info</a>.<a href="../../ipv6/uip-ds6-route.h.html#183">length</a> &gt; 0) {</div><div id="614" class="line none">  614     buffer[pos++] = <a href="rpl-private.h.html#89">RPL_OPTION_PREFIX_INFO</a>;</div><div id="615" class="line none">  615     buffer[pos++] = 30; /* always 30 bytes + 2 long */</div><div id="616" class="line none">  616     buffer[pos++] = <a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="rpl-private.h.html#246">prefix_info</a>.<a href="../../ipv6/uip-ds6-route.h.html#183">length</a>;</div><div id="617" class="line none">  617     buffer[pos++] = <a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="rpl-private.h.html#246">prefix_info</a>.<a href="../../ipv6/uip.h.html#1630">flags</a>;</div><div id="618" class="line none">  618     <a href="rpl-icmp6.c.html#168">set32</a>(buffer, pos, <a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="rpl-private.h.html#246">prefix_info</a>.<a href="../../ipv6/uip-ds6-route.h.html#156">lifetime</a>);</div><div id="619" class="line none">  619     pos += 4;</div><div id="620" class="line none">  620     <a href="rpl-icmp6.c.html#168">set32</a>(buffer, pos, <a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="rpl-private.h.html#246">prefix_info</a>.<a href="../../ipv6/uip-ds6-route.h.html#156">lifetime</a>);</div><div id="621" class="line none">  621     pos += 4;</div><div id="622" class="line none">  622     memset(&amp;buffer[pos], 0, 4);</div><div id="623" class="line none">  623     pos += 4;</div><div id="624" class="line none">  624     memcpy(&amp;buffer[pos], &amp;<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="rpl-private.h.html#246">prefix_info</a>.<a href="rpl.h.html#129">prefix</a>, 16);</div><div id="625" class="line none">  625     pos += 16;</div><div id="626" class="line none">  626     <a href="../../../sys/log.h.html#201">LOG_DBG</a>("Sending prefix info in DIO for ");</div><div id="627" class="line none">  627     <a href="../../../sys/log.h.html#219">LOG_DBG_6ADDR</a>(&amp;<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="rpl-private.h.html#246">prefix_info</a>.<a href="rpl.h.html#129">prefix</a>);</div><div id="628" class="line none">  628     <a href="../../../sys/log.h.html#207">LOG_DBG_</a>("\n");</div><div id="629" class="line none">  629   } else {</div><div id="630" class="line none">  630     <a href="../../../sys/log.h.html#201">LOG_DBG</a>("No prefix to announce (len %d)\n",</div><div id="631" class="line none">  631             <a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="rpl-private.h.html#246">prefix_info</a>.<a href="../../ipv6/uip-ds6-route.h.html#183">length</a>);</div><div id="632" class="line none">  632   }</div><div id="633" class="line none">  633 </div><div id="634" class="line none">  634 #if RPL_LEAF_ONLY</div><div id="635" class="line none">  635   if(<a href="../../../sys/log.h.html#236">LOG_DBG_ENABLED</a>) {</div><div id="636" class="line none">  636     if(uc_addr == NULL) {</div><div id="637" class="line none">  637       <a href="../../../sys/log.h.html#201">LOG_DBG</a>("LEAF ONLY sending unicast-DIO from multicast-DIO\n");</div><div id="638" class="line none">  638     }</div><div id="639" class="line none">  639   }</div><div id="640" class="line none">  640 </div><div id="641" class="line none">  641   <a href="../../../sys/log.h.html#200">LOG_INFO</a>("Sending unicast-DIO with rank %u to ", (unsigned)<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="rpl-private.h.html#231">rank</a>);</div><div id="642" class="line none">  642   <a href="../../../sys/log.h.html#218">LOG_INFO_6ADDR</a>(uc_addr);</div><div id="643" class="line none">  643   <a href="../../../sys/log.h.html#206">LOG_INFO_</a>("\n");</div><div id="644" class="line none">  644   <a href="../../ipv6/uip-icmp6.h.html#130">uip_icmp6_send</a>(uc_addr, <a href="../../ipv6/uip-icmp6.h.html#66">ICMP6_RPL</a>, <a href="rpl-private.h.html#72">RPL_CODE_DIO</a>, pos);</div><div id="645" class="line none">  645 #else /* RPL_LEAF_ONLY */</div><div id="646" class="line none">  646   /* Unicast requests get unicast replies! */</div><div id="647" class="line none">  647   if(uc_addr == NULL) {</div><div id="648" class="line none">  648     <a href="../../../sys/log.h.html#200">LOG_INFO</a>("Sending a multicast-DIO with rank %u\n",</div><div id="649" class="line none">  649              (unsigned)<a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl.h.html#226">current_dag</a>-&gt;<a href="rpl-private.h.html#231">rank</a>);</div><div id="650" class="line none">  650     <a href="rpl-private.h.html#67">uip_create_linklocal_rplnodes_mcast</a>(&amp;<a href="../../ipv6/uip.h.html#113">addr</a>);</div><div id="651" class="line none">  651     <a href="../../ipv6/uip-icmp6.h.html#130">uip_icmp6_send</a>(&amp;<a href="../../ipv6/uip.h.html#113">addr</a>, <a href="../../ipv6/uip-icmp6.h.html#66">ICMP6_RPL</a>, <a href="rpl-private.h.html#72">RPL_CODE_DIO</a>, pos);</div><div id="652" class="line none">  652   } else {</div><div id="653" class="line none">  653     <a href="../../../sys/log.h.html#200">LOG_INFO</a>("Sending unicast-DIO with rank %u to ",</div><div id="654" class="line none">  654              (unsigned)<a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl.h.html#226">current_dag</a>-&gt;<a href="rpl-private.h.html#231">rank</a>);</div><div id="655" class="line none">  655     <a href="../../../sys/log.h.html#218">LOG_INFO_6ADDR</a>(uc_addr);</div><div id="656" class="line none">  656     <a href="../../../sys/log.h.html#206">LOG_INFO_</a>("\n");</div><div id="657" class="line none">  657     <a href="../../ipv6/uip-icmp6.h.html#130">uip_icmp6_send</a>(uc_addr, <a href="../../ipv6/uip-icmp6.h.html#66">ICMP6_RPL</a>, <a href="rpl-private.h.html#72">RPL_CODE_DIO</a>, pos);</div><div id="658" class="line none">  658   }</div><div id="659" class="line none">  659 #endif /* RPL_LEAF_ONLY */</div><div id="660" class="line none">  660 }</div><div id="661" class="line none">  661 /*---------------------------------------------------------------------------*/</div><div id="662" class="line none">  662 void</div><div id="663" class="line none">  663 <a href="rpl-icmp6.c.html#663">dao_input_storing</a>(void)</div><div id="664" class="line none">  664 {</div><div id="665" class="line none">  665 #if RPL_WITH_STORING</div><div id="666" class="line none">  666   <a href="../../ipv6/uip.h.html#105">uip_ipaddr_t</a> dao_sender_addr;</div><div id="667" class="line none">  667   <a href="rpl.h.html#153">rpl_dag_t</a> *<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>;</div><div id="668" class="line none">  668   <a href="rpl.h.html#154">rpl_instance_t</a> *<a href="../../ipv6/uip.h.html#1631">instance</a>;</div><div id="669" class="line none">  669   unsigned char *buffer;</div><div id="670" class="line none">  670   uint16_t sequence;</div><div id="671" class="line none">  671   uint8_t <a href="rpl-private.h.html#236">instance_id</a>;</div><div id="672" class="line none">  672   uint8_t <a href="../../ipv6/uip-ds6-route.h.html#156">lifetime</a>;</div><div id="673" class="line none">  673   uint8_t prefixlen;</div><div id="674" class="line none">  674   uint8_t <a href="../../ipv6/uip.h.html#1630">flags</a>;</div><div id="675" class="line none">  675   uint8_t subopt_type;</div><div id="676" class="line none">  676   <a href="../../ipv6/uip.h.html#105">uip_ipaddr_t</a> <a href="rpl.h.html#129">prefix</a>;</div><div id="677" class="line none">  677   <a href="../../ipv6/uip-ds6-route.h.html#184">uip_ds6_route_t</a> *rep;</div><div id="678" class="line none">  678   int pos;</div><div id="679" class="line none">  679   int <a href="../../ipv6/uip.h.html#1268">len</a>;</div><div id="680" class="line none">  680   int i;</div><div id="681" class="line none">  681   int learned_from;</div><div id="682" class="line none">  682   <a href="rpl.h.html#125">rpl_parent_t</a> *parent;</div><div id="683" class="line none">  683   <a href="../../ipv6/uip-ds6-nbr.h.html#122">uip_ds6_nbr_t</a> *nbr;</div><div id="684" class="line none">  684   int is_root;</div><div id="685" class="line none">  685 </div><div id="686" class="line none">  686   prefixlen = 0;</div><div id="687" class="line none">  687   parent = NULL;</div><div id="688" class="line none">  688   memset(&amp;<a href="rpl.h.html#129">prefix</a>, 0, sizeof(<a href="rpl.h.html#129">prefix</a>));</div><div id="689" class="line none">  689 </div><div id="690" class="line none">  690   <a href="../../ipv6/uip.h.html#969">uip_ipaddr_copy</a>(&amp;dao_sender_addr, &amp;<a href="../../ipv6/uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="../../ipv6/uip.h.html#1537">srcipaddr</a>);</div><div id="691" class="line none">  691 </div><div id="692" class="line none">  692   buffer = <a href="../../ipv6/uip.h.html#78">UIP_ICMP_PAYLOAD</a>;</div><div id="693" class="line none">  693   uint16_t buffer_length = <a href="../../ipv6/uip.h.html#1232">uip_len</a> - <a href="../../ipv6/uip.h.html#66">uip_l3_icmp_hdr_len</a>;</div><div id="694" class="line none">  694   if(0) {</div><div id="695" class="line none">  695     <a href="../../../sys/log.h.html#199">LOG_WARN</a>("Dropping incomplete DAO (%"PRIu16" &lt; %d)\n",</div><div id="696" class="line none">  696              buffer_length, 4);</div><div id="697" class="line none">  697     return;</div><div id="698" class="line none">  698   }</div><div id="699" class="line none">  699 </div><div id="700" class="line none">  700   uint16_t last_valid_pos = buffer_length - 1;</div><div id="701" class="line none">  701 </div><div id="702" class="line none">  702   pos = 0;</div><div id="703" class="line none">  703   <a href="rpl-private.h.html#236">instance_id</a> = buffer[pos++];</div><div id="704" class="line none">  704   <a href="../../ipv6/uip.h.html#1631">instance</a> = <a href="rpl.h.html#279">rpl_get_instance</a>(<a href="rpl-private.h.html#236">instance_id</a>);</div><div id="705" class="line none">  705   if(<a href="../../ipv6/uip.h.html#1631">instance</a> == NULL) {</div><div id="706" class="line none">  706     <a href="../../../sys/log.h.html#198">LOG_ERR</a>("Cannot get RPL instance\n");</div><div id="707" class="line none">  707     return;</div><div id="708" class="line none">  708   }</div><div id="709" class="line none">  709 </div><div id="710" class="line none">  710   <a href="../../ipv6/uip-ds6-route.h.html#156">lifetime</a> = <a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl-private.h.html#241">default_lifetime</a>;</div><div id="711" class="line none">  711 </div><div id="712" class="line none">  712   <a href="../../ipv6/uip.h.html#1630">flags</a> = buffer[pos++];</div><div id="713" class="line none">  713   /* reserved */</div><div id="714" class="line none">  714   pos++;</div><div id="715" class="line none">  715   sequence = buffer[pos++];</div><div id="716" class="line none">  716 </div><div id="717" class="line none">  717   <a href="../../ipv6/uip-ds6-route.h.html#157">dag</a> = <a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl.h.html#226">current_dag</a>;</div><div id="718" class="line none">  718   is_root = (<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="rpl-private.h.html#231">rank</a> == <a href="rpl-private.h.html#191">ROOT_RANK</a>(<a href="../../ipv6/uip.h.html#1631">instance</a>));</div><div id="719" class="line none">  719 </div><div id="720" class="line none">  720   /* Is the DAG ID present? */</div><div id="721" class="line none">  721   if(<a href="../../ipv6/uip.h.html#1630">flags</a> &amp; <a href="rpl-private.h.html#93">RPL_DAO_D_FLAG</a>) {</div><div id="722" class="line none">  722       if(0) {</div><div id="723" class="line none">  723         <a href="../../../sys/log.h.html#199">LOG_WARN</a>("Dropping incomplete DAO (%"PRIu16" &lt; %d)\n",</div><div id="724" class="line none">  724                  last_valid_pos, pos + 16);</div><div id="725" class="line none">  725         return;</div><div id="726" class="line none">  726       }</div><div id="727" class="line none">  727 </div><div id="728" class="line none">  728     if(memcmp(&amp;<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="rpl-private.h.html#229">dag_id</a>, &amp;buffer[pos], sizeof(<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="rpl-private.h.html#229">dag_id</a>))) {</div><div id="729" class="line none">  729       <a href="../../../sys/log.h.html#200">LOG_INFO</a>("Ignoring a DAO for a DAG different from ours\n");</div><div id="730" class="line none">  730       return;</div><div id="731" class="line none">  731     }</div><div id="732" class="line none">  732     pos += 16;</div><div id="733" class="line none">  733   }</div><div id="734" class="line none">  734 </div><div id="735" class="line none">  735   learned_from = <a href="../../ipv6/uip.h.html#1886">uip_is_addr_mcast</a>(&amp;dao_sender_addr) ?</div><div id="736" class="line none">  736     <a href="rpl-private.h.html#202">RPL_ROUTE_FROM_MULTICAST_DAO</a> : <a href="rpl-private.h.html#201">RPL_ROUTE_FROM_UNICAST_DAO</a>;</div><div id="737" class="line none">  737 </div><div id="738" class="line none">  738   /* Destination Advertisement Object */</div><div id="739" class="line none">  739   <a href="../../../sys/log.h.html#201">LOG_DBG</a>("Received a (%s) DAO with sequence number %u from ",</div><div id="740" class="line none">  740           learned_from == <a href="rpl-private.h.html#201">RPL_ROUTE_FROM_UNICAST_DAO</a> ? "unicast" : "multicast",</div><div id="741" class="line none">  741           sequence);</div><div id="742" class="line none">  742   <a href="../../../sys/log.h.html#219">LOG_DBG_6ADDR</a>(&amp;dao_sender_addr);</div><div id="743" class="line none">  743   <a href="../../../sys/log.h.html#207">LOG_DBG_</a>("\n");</div><div id="744" class="line none">  744 </div><div id="745" class="line none">  745   if(learned_from == <a href="rpl-private.h.html#201">RPL_ROUTE_FROM_UNICAST_DAO</a>) {</div><div id="746" class="line none">  746     /* Check whether this is a DAO forwarding loop. */</div><div id="747" class="line none">  747     parent = <a href="rpl-private.h.html#323">rpl_find_parent</a>(<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>, &amp;dao_sender_addr);</div><div id="748" class="line none">  748     /* Check if this is a new DAO registration with an "illegal" rank.</div><div id="749" class="line none">  749        If we already route to this node, then it is likely. */</div><div id="750" class="line none">  750     if(parent != NULL &amp;&amp;</div><div id="751" class="line none">  751        <a href="rpl-private.h.html#184">DAG_RANK</a>(parent-&gt;<a href="rpl-private.h.html#231">rank</a>, <a href="../../ipv6/uip.h.html#1631">instance</a>) &lt; <a href="rpl-private.h.html#184">DAG_RANK</a>(<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="rpl-private.h.html#231">rank</a>, <a href="../../ipv6/uip.h.html#1631">instance</a>)) {</div><div id="752" class="line none">  752       <a href="../../../sys/log.h.html#199">LOG_WARN</a>("Loop detected when receiving a unicast DAO from a node with a lower rank! (%u &lt; %u)\n",</div><div id="753" class="line none">  753                <a href="rpl-private.h.html#184">DAG_RANK</a>(parent-&gt;<a href="rpl-private.h.html#231">rank</a>, <a href="../../ipv6/uip.h.html#1631">instance</a>), <a href="rpl-private.h.html#184">DAG_RANK</a>(<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="rpl-private.h.html#231">rank</a>, <a href="../../ipv6/uip.h.html#1631">instance</a>));</div><div id="754" class="line none">  754       parent-&gt;<a href="rpl-private.h.html#231">rank</a> = <a href="rpl-private.h.html#193">RPL_INFINITE_RANK</a>;</div><div id="755" class="line none">  755       parent-&gt;<a href="../../ipv6/uip.h.html#1630">flags</a> |= <a href="rpl.h.html#113">RPL_PARENT_FLAG_UPDATED</a>;</div><div id="756" class="line none">  756       return;</div><div id="757" class="line none">  757     }</div><div id="758" class="line none">  758 </div><div id="759" class="line none">  759     /* If we get the DAO from our parent, we also have a loop. */</div><div id="760" class="line none">  760     if(parent != NULL &amp;&amp; parent == <a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="rpl.h.html#147">preferred_parent</a>) {</div><div id="761" class="line none">  761       <a href="../../../sys/log.h.html#199">LOG_WARN</a>("Loop detected when receiving a unicast DAO from our parent\n");</div><div id="762" class="line none">  762       parent-&gt;<a href="rpl-private.h.html#231">rank</a> = <a href="rpl-private.h.html#193">RPL_INFINITE_RANK</a>;</div><div id="763" class="line none">  763       parent-&gt;<a href="../../ipv6/uip.h.html#1630">flags</a> |= <a href="rpl.h.html#113">RPL_PARENT_FLAG_UPDATED</a>;</div><div id="764" class="line none">  764       return;</div><div id="765" class="line none">  765     }</div><div id="766" class="line none">  766   }</div><div id="767" class="line none">  767 </div><div id="768" class="line none">  768   /* Check if there are any RPL options present. */</div><div id="769" class="line none">  769   for(i = pos; i &lt; buffer_length; i += <a href="../../ipv6/uip.h.html#1268">len</a>) {</div><div id="770" class="line none">  770     subopt_type = buffer[i];</div><div id="771" class="line none">  771     if(subopt_type == <a href="rpl-private.h.html#81">RPL_OPTION_PAD1</a>) {</div><div id="772" class="line none">  772       <a href="../../ipv6/uip.h.html#1268">len</a> = 1;</div><div id="773" class="line none">  773     } else {</div><div id="774" class="line none">  774       /* The option consists of a two-byte header and a payload. */</div><div id="775" class="line none">  775       if(0) {</div><div id="776" class="line none">  776         <a href="../../../sys/log.h.html#199">LOG_WARN</a>("Dropping incomplete DAO (%"PRIu16" &lt; %d)\n",</div><div id="777" class="line none">  777                  last_valid_pos, i + 1);</div><div id="778" class="line none">  778         return;</div><div id="779" class="line none">  779       }</div><div id="780" class="line none">  780       <a href="../../ipv6/uip.h.html#1268">len</a> = 2 + buffer[i + 1];</div><div id="781" class="line none">  781     }</div><div id="782" class="line none">  782 </div><div id="783" class="line none">  783     switch(subopt_type) {</div><div id="784" class="line none">  784     case <a href="rpl-private.h.html#86">RPL_OPTION_TARGET</a>:</div><div id="785" class="line none">  785       /* Handle the target option. */</div><div id="786" class="line none">  786       if(0) {</div><div id="787" class="line none">  787         <a href="../../../sys/log.h.html#199">LOG_WARN</a>("Dropping incomplete DAO (%"PRIu16" &lt; %d)\n",</div><div id="788" class="line none">  788                  last_valid_pos, i + 3);</div><div id="789" class="line none">  789         return;</div><div id="790" class="line none">  790       }</div><div id="791" class="line none">  791       prefixlen = buffer[i + 3];</div><div id="792" class="line none">  792       if(prefixlen == 0) {</div><div id="793" class="line none">  793         /* Ignore option targets with a prefix length of 0. */</div><div id="794" class="line none">  794         break;</div><div id="795" class="line none">  795       }</div><div id="796" class="line none">  796       if(prefixlen &gt; 128) {</div><div id="797" class="line none">  797         <a href="../../../sys/log.h.html#198">LOG_ERR</a>("Too large target prefix length %d\n", prefixlen);</div><div id="798" class="line none">  798         return;</div><div id="799" class="line none">  799       }</div><div id="800" class="line none">  800       if(0) {</div><div id="801" class="line none">  801         <a href="../../../sys/log.h.html#198">LOG_ERR</a>("Incomplete DAO target option with prefix length of %d bits\n",</div><div id="802" class="line none">  802                 prefixlen);</div><div id="803" class="line none">  803         return;</div><div id="804" class="line none">  804       }</div><div id="805" class="line none">  805       memset(&amp;<a href="rpl.h.html#129">prefix</a>, 0, sizeof(<a href="rpl.h.html#129">prefix</a>));</div><div id="806" class="line none">  806       memcpy(&amp;<a href="rpl.h.html#129">prefix</a>, buffer + i + 4, (prefixlen + 7) / CHAR_BIT);</div><div id="807" class="line none">  807       break;</div><div id="808" class="line none">  808     case <a href="rpl-private.h.html#87">RPL_OPTION_TRANSIT</a>:</div><div id="809" class="line none">  809       /* The path sequence and control are ignored. */</div><div id="810" class="line none">  810       if(0) {</div><div id="811" class="line none">  811         <a href="../../../sys/log.h.html#199">LOG_WARN</a>("Dropping incomplete DAO (%"PRIu16" &lt; %d)\n",</div><div id="812" class="line none">  812                  last_valid_pos, i + 5);</div><div id="813" class="line none">  813         return;</div><div id="814" class="line none">  814       }</div><div id="815" class="line none">  815       <a href="../../ipv6/uip-ds6-route.h.html#156">lifetime</a> = buffer[i + 5];</div><div id="816" class="line none">  816       /* The parent address is also ignored. */</div><div id="817" class="line none">  817       break;</div><div id="818" class="line none">  818     }</div><div id="819" class="line none">  819   }</div><div id="820" class="line none">  820 </div><div id="821" class="line none">  821   <a href="../../../sys/log.h.html#200">LOG_INFO</a>("DAO lifetime: %u, prefix length: %u prefix: ",</div><div id="822" class="line none">  822            (unsigned)<a href="../../ipv6/uip-ds6-route.h.html#156">lifetime</a>, (unsigned)prefixlen);</div><div id="823" class="line none">  823   <a href="../../../sys/log.h.html#218">LOG_INFO_6ADDR</a>(&amp;<a href="rpl.h.html#129">prefix</a>);</div><div id="824" class="line none">  824   <a href="../../../sys/log.h.html#206">LOG_INFO_</a>("\n");</div><div id="825" class="line none">  825 </div><div id="826" class="line none">  826 #if RPL_WITH_MULTICAST</div><div id="827" class="line none">  827   if(<a href="../../ipv6/uip.h.html#1893">uip_is_addr_mcast_global</a>(&amp;<a href="rpl.h.html#129">prefix</a>)) {</div><div id="828" class="line none">  828     /*</div><div id="829" class="line none">  829      * "rep" is used for a unicast route which we don't need now; so</div><div id="830" class="line none">  830      * set NULL so that operations on "rep" will be skipped.</div><div id="831" class="line none">  831      */</div><div id="832" class="line none">  832     rep = NULL;</div><div id="833" class="line none">  833     <a href="rpl-icmp6.c.html#91">mcast_group</a> = uip_mcast6_route_add(&amp;<a href="rpl.h.html#129">prefix</a>);</div><div id="834" class="line none">  834     if(<a href="rpl-icmp6.c.html#91">mcast_group</a>) {</div><div id="835" class="line none">  835       <a href="rpl-icmp6.c.html#91">mcast_group</a>-&gt;<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a> = <a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>;</div><div id="836" class="line none">  836       <a href="rpl-icmp6.c.html#91">mcast_group</a>-&gt;<a href="../../ipv6/uip-ds6-route.h.html#156">lifetime</a> = <a href="rpl-private.h.html#152">RPL_LIFETIME</a>(<a href="../../ipv6/uip.h.html#1631">instance</a>, <a href="../../ipv6/uip-ds6-route.h.html#156">lifetime</a>);</div><div id="837" class="line none">  837     }</div><div id="838" class="line none">  838     goto fwd_dao;</div><div id="839" class="line none">  839   }</div><div id="840" class="line none">  840 #endif</div><div id="841" class="line none">  841 </div><div id="842" class="line none">  842   rep = <a href="../../ipv6/uip-ds6-route.h.html#216">uip_ds6_route_lookup</a>(&amp;<a href="rpl.h.html#129">prefix</a>);</div><div id="843" class="line none">  843 </div><div id="844" class="line none">  844   if(<a href="../../ipv6/uip-ds6-route.h.html#156">lifetime</a> == <a href="rpl-private.h.html#145">RPL_ZERO_LIFETIME</a>) {</div><div id="845" class="line none">  845     <a href="../../../sys/log.h.html#200">LOG_INFO</a>("No-Path DAO received\n");</div><div id="846" class="line none">  846     /* No-Path DAO received; invoke the route purging routine. */</div><div id="847" class="line none">  847     if(rep != NULL &amp;&amp;</div><div id="848" class="line none">  848        !<a href="../../ipv6/uip-ds6-route.h.html#123">RPL_ROUTE_IS_NOPATH_RECEIVED</a>(rep) &amp;&amp;</div><div id="849" class="line none">  849        rep-&gt;<a href="../../ipv6/uip-ds6-route.h.html#183">length</a> == prefixlen &amp;&amp;</div><div id="850" class="line none">  850        <a href="../../ipv6/uip-ds6-route.h.html#222">uip_ds6_route_nexthop</a>(rep) != NULL &amp;&amp;</div><div id="851" class="line none">  851        <a href="../../ipv6/uip.h.html#1002">uip_ipaddr_cmp</a>(<a href="../../ipv6/uip-ds6-route.h.html#222">uip_ds6_route_nexthop</a>(rep), &amp;dao_sender_addr)) {</div><div id="852" class="line none">  852       <a href="../../../sys/log.h.html#201">LOG_DBG</a>("Setting expiration timer for prefix ");</div><div id="853" class="line none">  853       <a href="../../../sys/log.h.html#219">LOG_DBG_6ADDR</a>(&amp;<a href="rpl.h.html#129">prefix</a>);</div><div id="854" class="line none">  854       <a href="../../../sys/log.h.html#207">LOG_DBG_</a>("\n");</div><div id="855" class="line none">  855       <a href="../../ipv6/uip-ds6-route.h.html#125">RPL_ROUTE_SET_NOPATH_RECEIVED</a>(rep);</div><div id="856" class="line none">  856       rep-&gt;<a href="../../ipv6/uip-ds6-nbr.h.html#112">state</a>.<a href="../../ipv6/uip-ds6-route.h.html#156">lifetime</a> = <a href="rpl-private.h.html#127">RPL_NOPATH_REMOVAL_DELAY</a>;</div><div id="857" class="line none">  857 </div><div id="858" class="line none">  858       /* We forward the incoming No-Path DAO to our parent, if we have</div><div id="859" class="line none">  859          one. */</div><div id="860" class="line none">  860       if(<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="rpl.h.html#147">preferred_parent</a> != NULL &amp;&amp;</div><div id="861" class="line none">  861          <a href="rpl.h.html#290">rpl_parent_get_ipaddr</a>(<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="rpl.h.html#147">preferred_parent</a>) != NULL) {</div><div id="862" class="line none">  862         uint8_t out_seq;</div><div id="863" class="line none">  863         out_seq = <a href="rpl-icmp6.c.html#120">prepare_for_dao_fwd</a>(sequence, rep);</div><div id="864" class="line none">  864 </div><div id="865" class="line none">  865         <a href="../../../sys/log.h.html#201">LOG_DBG</a>("Forwarding No-path DAO out_seq:%d to parent ", out_seq);</div><div id="866" class="line none">  866         <a href="../../../sys/log.h.html#219">LOG_DBG_6ADDR</a>(<a href="rpl.h.html#290">rpl_parent_get_ipaddr</a>(<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="rpl.h.html#147">preferred_parent</a>));</div><div id="867" class="line none">  867         <a href="../../../sys/log.h.html#207">LOG_DBG_</a>("\n");</div><div id="868" class="line none">  868 </div><div id="869" class="line none">  869         buffer = <a href="../../ipv6/uip.h.html#78">UIP_ICMP_PAYLOAD</a>;</div><div id="870" class="line none">  870         buffer[3] = out_seq; /* add an outgoing seq no before fwd */</div><div id="871" class="line none">  871         <a href="../../ipv6/uip-icmp6.h.html#130">uip_icmp6_send</a>(<a href="rpl.h.html#290">rpl_parent_get_ipaddr</a>(<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="rpl.h.html#147">preferred_parent</a>),</div><div id="872" class="line none">  872                        <a href="../../ipv6/uip-icmp6.h.html#66">ICMP6_RPL</a>, <a href="rpl-private.h.html#73">RPL_CODE_DAO</a>, buffer_length);</div><div id="873" class="line none">  873       }</div><div id="874" class="line none">  874     }</div><div id="875" class="line none">  875     /* Regardless of whether we remove it or not -- ACK the request. */</div><div id="876" class="line none">  876     if(<a href="../../ipv6/uip.h.html#1630">flags</a> &amp; <a href="rpl-private.h.html#92">RPL_DAO_K_FLAG</a>) {</div><div id="877" class="line none">  877       /* Indicate that we accepted the no-path DAO. */</div><div id="878" class="line none">  878       <a href="../../ipv6/uipbuf.h.html#42">uipbuf_clear</a>();</div><div id="879" class="line none">  879       <a href="rpl-icmp6.c.html#1488">dao_ack_output</a>(<a href="../../ipv6/uip.h.html#1631">instance</a>, &amp;dao_sender_addr, sequence,</div><div id="880" class="line none">  880                      <a href="rpl-private.h.html#95">RPL_DAO_ACK_UNCONDITIONAL_ACCEPT</a>);</div><div id="881" class="line none">  881     }</div><div id="882" class="line none">  882     return;</div><div id="883" class="line none">  883   }</div><div id="884" class="line none">  884 </div><div id="885" class="line none">  885   <a href="../../../sys/log.h.html#200">LOG_INFO</a>("Adding DAO route\n");</div><div id="886" class="line none">  886 </div><div id="887" class="line none">  887   /* Update and add neighbor, and fail if there is no room. */</div><div id="888" class="line none">  888   nbr = <a href="rpl-icmp6.c.html#190">rpl_icmp6_update_nbr_table</a>(&amp;dao_sender_addr,</div><div id="889" class="line none">  889                                    <a href="../../nbr-table.h.html#45">NBR_TABLE_REASON_RPL_DAO</a>, <a href="../../ipv6/uip.h.html#1631">instance</a>);</div><div id="890" class="line none">  890   if(nbr == NULL) {</div><div id="891" class="line none">  891     <a href="../../../sys/log.h.html#198">LOG_ERR</a>("Out of memory, dropping DAO from ");</div><div id="892" class="line none">  892     <a href="../../../sys/log.h.html#216">LOG_ERR_6ADDR</a>(&amp;dao_sender_addr);</div><div id="893" class="line none">  893     <a href="../../../sys/log.h.html#204">LOG_ERR_</a>(", ");</div><div id="894" class="line none">  894     <a href="../../../sys/log.h.html#210">LOG_ERR_LLADDR</a>(<a href="../../packetbuf.h.html#258">packetbuf_addr</a>(<a href="../../packetbuf.h.html#243">PACKETBUF_ADDR_SENDER</a>));</div><div id="895" class="line none">  895     <a href="../../../sys/log.h.html#204">LOG_ERR_</a>("\n");</div><div id="896" class="line none">  896     if(<a href="../../ipv6/uip.h.html#1630">flags</a> &amp; <a href="rpl-private.h.html#92">RPL_DAO_K_FLAG</a>) {</div><div id="897" class="line none">  897       /* Signal the failure to add the node. */</div><div id="898" class="line none">  898       <a href="rpl-icmp6.c.html#1488">dao_ack_output</a>(<a href="../../ipv6/uip.h.html#1631">instance</a>, &amp;dao_sender_addr, sequence,</div><div id="899" class="line none">  899                      is_root ? <a href="rpl-private.h.html#98">RPL_DAO_ACK_UNABLE_TO_ADD_ROUTE_AT_ROOT</a> :</div><div id="900" class="line none">  900                      <a href="rpl-private.h.html#97">RPL_DAO_ACK_UNABLE_TO_ACCEPT</a>);</div><div id="901" class="line none">  901     }</div><div id="902" class="line none">  902     return;</div><div id="903" class="line none">  903   }</div><div id="904" class="line none">  904 </div><div id="905" class="line none">  905   rep = <a href="rpl-private.h.html#335">rpl_add_route</a>(<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>, &amp;<a href="rpl.h.html#129">prefix</a>, prefixlen, &amp;dao_sender_addr);</div><div id="906" class="line none">  906   if(rep == NULL) {</div><div id="907" class="line none">  907     <a href="rpl-private.h.html#287">RPL_STAT</a>(<a href="rpl-private.h.html#253">rpl_stats</a>.<a href="rpl-private.h.html#254">mem_overflows</a>++);</div><div id="908" class="line none">  908     <a href="../../../sys/log.h.html#198">LOG_ERR</a>("Could not add a route after receiving a DAO\n");</div><div id="909" class="line none">  909     if(<a href="../../ipv6/uip.h.html#1630">flags</a> &amp; <a href="rpl-private.h.html#92">RPL_DAO_K_FLAG</a>) {</div><div id="910" class="line none">  910       /* Signal the failure to add the node. */</div><div id="911" class="line none">  911       <a href="rpl-icmp6.c.html#1488">dao_ack_output</a>(<a href="../../ipv6/uip.h.html#1631">instance</a>, &amp;dao_sender_addr, sequence,</div><div id="912" class="line none">  912                      is_root ? <a href="rpl-private.h.html#98">RPL_DAO_ACK_UNABLE_TO_ADD_ROUTE_AT_ROOT</a> :</div><div id="913" class="line none">  913                      <a href="rpl-private.h.html#97">RPL_DAO_ACK_UNABLE_TO_ACCEPT</a>);</div><div id="914" class="line none">  914     }</div><div id="915" class="line none">  915     return;</div><div id="916" class="line none">  916   }</div><div id="917" class="line none">  917 </div><div id="918" class="line none">  918   /* Set the lifetime and clear the NOPATH bit. */</div><div id="919" class="line none">  919   rep-&gt;<a href="../../ipv6/uip-ds6-nbr.h.html#112">state</a>.<a href="../../ipv6/uip-ds6-route.h.html#156">lifetime</a> = <a href="rpl-private.h.html#152">RPL_LIFETIME</a>(<a href="../../ipv6/uip.h.html#1631">instance</a>, <a href="../../ipv6/uip-ds6-route.h.html#156">lifetime</a>);</div><div id="920" class="line none">  920   <a href="../../ipv6/uip-ds6-route.h.html#128">RPL_ROUTE_CLEAR_NOPATH_RECEIVED</a>(rep);</div><div id="921" class="line none">  921 </div><div id="922" class="line none">  922 #if RPL_WITH_MULTICAST</div><div id="923" class="line none">  923 fwd_dao:</div><div id="924" class="line none">  924 #endif</div><div id="925" class="line none">  925 </div><div id="926" class="line none">  926   if(learned_from == <a href="rpl-private.h.html#201">RPL_ROUTE_FROM_UNICAST_DAO</a>) {</div><div id="927" class="line none">  927     int should_ack = 0;</div><div id="928" class="line none">  928 </div><div id="929" class="line none">  929     if(<a href="../../ipv6/uip.h.html#1630">flags</a> &amp; <a href="rpl-private.h.html#92">RPL_DAO_K_FLAG</a>) {</div><div id="930" class="line none">  930       if(rep != NULL) {</div><div id="931" class="line none">  931         /*</div><div id="932" class="line none">  932          * Check if this route is already installed and that we can</div><div id="933" class="line none">  933          * acknowledge it now! Not pending and same sequence number</div><div id="934" class="line none">  934          * means that we can acknowledge it. E.g., the route is</div><div id="935" class="line none">  935          * installed already, so it will not take any more room that</div><div id="936" class="line none">  936          * it already takes. Hence, it should be OK.</div><div id="937" class="line none">  937          */</div><div id="938" class="line none">  938         if((!<a href="../../ipv6/uip-ds6-route.h.html#132">RPL_ROUTE_IS_DAO_PENDING</a>(rep) &amp;&amp;</div><div id="939" class="line none">  939             rep-&gt;<a href="../../ipv6/uip-ds6-nbr.h.html#112">state</a>.<a href="../../ipv6/uip-ds6-route.h.html#159">dao_seqno_in</a> == sequence) ||</div><div id="940" class="line none">  940            <a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="rpl-private.h.html#231">rank</a> == <a href="rpl-private.h.html#191">ROOT_RANK</a>(<a href="../../ipv6/uip.h.html#1631">instance</a>)) {</div><div id="941" class="line none">  941           should_ack = 1;</div><div id="942" class="line none">  942         }</div><div id="943" class="line none">  943       }</div><div id="944" class="line none">  944     }</div><div id="945" class="line none">  945 </div><div id="946" class="line none">  946     if(<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="rpl.h.html#147">preferred_parent</a> != NULL &amp;&amp;</div><div id="947" class="line none">  947        <a href="rpl.h.html#290">rpl_parent_get_ipaddr</a>(<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="rpl.h.html#147">preferred_parent</a>) != NULL) {</div><div id="948" class="line none">  948       uint8_t out_seq = 0;</div><div id="949" class="line none">  949       if(rep != NULL) {</div><div id="950" class="line none">  950         /* If this is pending and we get the same sequence number,</div><div id="951" class="line none">  951            then it is a retransmission. */</div><div id="952" class="line none">  952         if(<a href="../../ipv6/uip-ds6-route.h.html#132">RPL_ROUTE_IS_DAO_PENDING</a>(rep) &amp;&amp;</div><div id="953" class="line none">  953            rep-&gt;<a href="../../ipv6/uip-ds6-nbr.h.html#112">state</a>.<a href="../../ipv6/uip-ds6-route.h.html#159">dao_seqno_in</a> == sequence) {</div><div id="954" class="line none">  954           /* Keep the same sequence number as before for parent also. */</div><div id="955" class="line none">  955           out_seq = rep-&gt;<a href="../../ipv6/uip-ds6-nbr.h.html#112">state</a>.<a href="../../ipv6/uip-ds6-route.h.html#158">dao_seqno_out</a>;</div><div id="956" class="line none">  956         } else {</div><div id="957" class="line none">  957           out_seq = <a href="rpl-icmp6.c.html#120">prepare_for_dao_fwd</a>(sequence, rep);</div><div id="958" class="line none">  958         }</div><div id="959" class="line none">  959       }</div><div id="960" class="line none">  960 </div><div id="961" class="line none">  961       <a href="../../../sys/log.h.html#201">LOG_DBG</a>("Forwarding DAO to parent ");</div><div id="962" class="line none">  962       <a href="../../../sys/log.h.html#219">LOG_DBG_6ADDR</a>(<a href="rpl.h.html#290">rpl_parent_get_ipaddr</a>(<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="rpl.h.html#147">preferred_parent</a>));</div><div id="963" class="line none">  963       <a href="../../../sys/log.h.html#207">LOG_DBG_</a>(" in seq: %d out seq: %d\n", sequence, out_seq);</div><div id="964" class="line none">  964 </div><div id="965" class="line none">  965       buffer = <a href="../../ipv6/uip.h.html#78">UIP_ICMP_PAYLOAD</a>;</div><div id="966" class="line none">  966       buffer[3] = out_seq; /* add an outgoing seq no before fwd */</div><div id="967" class="line none">  967       <a href="../../ipv6/uip-icmp6.h.html#130">uip_icmp6_send</a>(<a href="rpl.h.html#290">rpl_parent_get_ipaddr</a>(<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="rpl.h.html#147">preferred_parent</a>),</div><div id="968" class="line none">  968                      <a href="../../ipv6/uip-icmp6.h.html#66">ICMP6_RPL</a>, <a href="rpl-private.h.html#73">RPL_CODE_DAO</a>, buffer_length);</div><div id="969" class="line none">  969     }</div><div id="970" class="line none">  970     if(should_ack) {</div><div id="971" class="line none">  971       <a href="../../../sys/log.h.html#201">LOG_DBG</a>("Sending DAO ACK\n");</div><div id="972" class="line none">  972       <a href="../../ipv6/uipbuf.h.html#42">uipbuf_clear</a>();</div><div id="973" class="line none">  973       <a href="rpl-icmp6.c.html#1488">dao_ack_output</a>(<a href="../../ipv6/uip.h.html#1631">instance</a>, &amp;dao_sender_addr, sequence,</div><div id="974" class="line none">  974                      <a href="rpl-private.h.html#95">RPL_DAO_ACK_UNCONDITIONAL_ACCEPT</a>);</div><div id="975" class="line none">  975     }</div><div id="976" class="line none">  976   }</div><div id="977" class="line none">  977 #endif /* RPL_WITH_STORING */</div><div id="978" class="line none">  978 }</div><div id="979" class="line none">  979 /*---------------------------------------------------------------------------*/</div><div id="980" class="line none">  980 static void</div><div id="981" class="line none">  981 <a href="rpl-icmp6.c.html#981">dao_input_nonstoring</a>(void)</div><div id="982" class="line none">  982 {</div><div id="983" class="line none">  983 #if RPL_WITH_NON_STORING</div><div id="984" class="line none">  984   <a href="../../ipv6/uip.h.html#105">uip_ipaddr_t</a> dao_sender_addr;</div><div id="985" class="line none">  985   <a href="../../ipv6/uip.h.html#105">uip_ipaddr_t</a> dao_parent_addr;</div><div id="986" class="line none">  986   <a href="rpl.h.html#153">rpl_dag_t</a> *<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>;</div><div id="987" class="line none">  987   <a href="rpl.h.html#154">rpl_instance_t</a> *<a href="../../ipv6/uip.h.html#1631">instance</a>;</div><div id="988" class="line none">  988   unsigned char *buffer;</div><div id="989" class="line none">  989   uint16_t sequence;</div><div id="990" class="line none">  990   uint8_t <a href="rpl-private.h.html#236">instance_id</a>;</div><div id="991" class="line none">  991   uint8_t <a href="../../ipv6/uip-ds6-route.h.html#156">lifetime</a>;</div><div id="992" class="line none">  992   uint8_t prefixlen;</div><div id="993" class="line none">  993   uint8_t <a href="../../ipv6/uip.h.html#1630">flags</a>;</div><div id="994" class="line none">  994   uint8_t subopt_type;</div><div id="995" class="line none">  995   <a href="../../ipv6/uip.h.html#105">uip_ipaddr_t</a> <a href="rpl.h.html#129">prefix</a>;</div><div id="996" class="line none">  996   int pos;</div><div id="997" class="line none">  997   int <a href="../../ipv6/uip.h.html#1268">len</a>;</div><div id="998" class="line none">  998   int i;</div><div id="999" class="line none">  999 </div><div id="1000" class="line none"> 1000   /* Destination Advertisement Object */</div><div id="1001" class="line none"> 1001   <a href="../../../sys/log.h.html#200">LOG_INFO</a>("Received a DAO from ");</div><div id="1002" class="line none"> 1002   <a href="../../../sys/log.h.html#218">LOG_INFO_6ADDR</a>(&amp;<a href="../../ipv6/uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="../../ipv6/uip.h.html#1537">srcipaddr</a>);</div><div id="1003" class="line none"> 1003   <a href="../../../sys/log.h.html#206">LOG_INFO_</a>("\n");</div><div id="1004" class="line none"> 1004 </div><div id="1005" class="line none"> 1005   prefixlen = 0;</div><div id="1006" class="line none"> 1006 </div><div id="1007" class="line none"> 1007   <a href="../../ipv6/uip.h.html#969">uip_ipaddr_copy</a>(&amp;dao_sender_addr, &amp;<a href="../../ipv6/uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="../../ipv6/uip.h.html#1537">srcipaddr</a>);</div><div id="1008" class="line none"> 1008   memset(&amp;dao_parent_addr, 0, 16);</div><div id="1009" class="line none"> 1009 </div><div id="1010" class="line none"> 1010   buffer = <a href="../../ipv6/uip.h.html#78">UIP_ICMP_PAYLOAD</a>;</div><div id="1011" class="line none"> 1011   uint16_t buffer_length = <a href="../../ipv6/uip.h.html#1232">uip_len</a> - <a href="../../ipv6/uip.h.html#66">uip_l3_icmp_hdr_len</a>;</div><div id="1012" class="line none"> 1012   if(0) {</div><div id="1013" class="line none"> 1013     <a href="../../../sys/log.h.html#199">LOG_WARN</a>("Dropping incomplete DAO (%"PRIu16" &lt; %d)\n",</div><div id="1014" class="line none"> 1014              buffer_length, 4);</div><div id="1015" class="line none"> 1015     return;</div><div id="1016" class="line none"> 1016   }</div><div id="1017" class="line none"> 1017 </div><div id="1018" class="line none"> 1018   uint16_t last_valid_pos = buffer_length - 1;</div><div id="1019" class="line none"> 1019 </div><div id="1020" class="line none"> 1020   pos = 0;</div><div id="1021" class="line none"> 1021   <a href="rpl-private.h.html#236">instance_id</a> = buffer[pos++];</div><div id="1022" class="line none"> 1022   <a href="../../ipv6/uip.h.html#1631">instance</a> = <a href="rpl.h.html#279">rpl_get_instance</a>(<a href="rpl-private.h.html#236">instance_id</a>);</div><div id="1023" class="line none"> 1023   <a href="../../ipv6/uip-ds6-route.h.html#156">lifetime</a> = <a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl-private.h.html#241">default_lifetime</a>;</div><div id="1024" class="line none"> 1024 </div><div id="1025" class="line none"> 1025   <a href="../../ipv6/uip.h.html#1630">flags</a> = buffer[pos++];</div><div id="1026" class="line none"> 1026   /* reserved */</div><div id="1027" class="line none"> 1027   pos++;</div><div id="1028" class="line none"> 1028   sequence = buffer[pos++];</div><div id="1029" class="line none"> 1029 </div><div id="1030" class="line none"> 1030   <a href="../../ipv6/uip-ds6-route.h.html#157">dag</a> = <a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl.h.html#226">current_dag</a>;</div><div id="1031" class="line none"> 1031   /* Is the DAG ID present? */</div><div id="1032" class="line none"> 1032   if(<a href="../../ipv6/uip.h.html#1630">flags</a> &amp; <a href="rpl-private.h.html#93">RPL_DAO_D_FLAG</a>) {</div><div id="1033" class="line none"> 1033     if(pos + sizeof(<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="rpl-private.h.html#229">dag_id</a>) &gt; buffer_length) {</div><div id="1034" class="line none"> 1034       <a href="../../../sys/log.h.html#199">LOG_WARN</a>("Insufficient data to read DAG ID from DAO\n");</div><div id="1035" class="line none"> 1035       return;</div><div id="1036" class="line none"> 1036     }</div><div id="1037" class="line none"> 1037     if(memcmp(&amp;<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="rpl-private.h.html#229">dag_id</a>, &amp;buffer[pos], sizeof(<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="rpl-private.h.html#229">dag_id</a>))) {</div><div id="1038" class="line none"> 1038       <a href="../../../sys/log.h.html#200">LOG_INFO</a>("Ignoring a DAO for a DAG different from ours\n");</div><div id="1039" class="line none"> 1039       return;</div><div id="1040" class="line none"> 1040     }</div><div id="1041" class="line none"> 1041     pos += 16;</div><div id="1042" class="line none"> 1042   }</div><div id="1043" class="line none"> 1043 </div><div id="1044" class="line none"> 1044   /* Check if there are any RPL options present. */</div><div id="1045" class="line none"> 1045   for(i = pos; i &lt; buffer_length; i += <a href="../../ipv6/uip.h.html#1268">len</a>) {</div><div id="1046" class="line none"> 1046     subopt_type = buffer[i];</div><div id="1047" class="line none"> 1047     if(subopt_type == <a href="rpl-private.h.html#81">RPL_OPTION_PAD1</a>) {</div><div id="1048" class="line none"> 1048       <a href="../../ipv6/uip.h.html#1268">len</a> = 1;</div><div id="1049" class="line none"> 1049     } else {</div><div id="1050" class="line none"> 1050       /* The option consists of a two-byte header and a payload. */</div><div id="1051" class="line none"> 1051       if(0) {</div><div id="1052" class="line none"> 1052         <a href="../../../sys/log.h.html#199">LOG_WARN</a>("Dropping incomplete DAO (%"PRIu16" &lt; %d)\n",</div><div id="1053" class="line none"> 1053                  last_valid_pos, i + 1);</div><div id="1054" class="line none"> 1054         return;</div><div id="1055" class="line none"> 1055       }</div><div id="1056" class="line none"> 1056       <a href="../../ipv6/uip.h.html#1268">len</a> = 2 + buffer[i + 1];</div><div id="1057" class="line none"> 1057     }</div><div id="1058" class="line none"> 1058 </div><div id="1059" class="line none"> 1059     switch(subopt_type) {</div><div id="1060" class="line none"> 1060     case <a href="rpl-private.h.html#86">RPL_OPTION_TARGET</a>:</div><div id="1061" class="line none"> 1061       /* Handle the target option. */</div><div id="1062" class="line none"> 1062       if(0) {</div><div id="1063" class="line none"> 1063         <a href="../../../sys/log.h.html#199">LOG_WARN</a>("Dropping incomplete DAO (%"PRIu16" &lt; %d)\n",</div><div id="1064" class="line none"> 1064                  last_valid_pos, i + 3);</div><div id="1065" class="line none"> 1065         return;</div><div id="1066" class="line none"> 1066       }</div><div id="1067" class="line none"> 1067       prefixlen = buffer[i + 3];</div><div id="1068" class="line none"> 1068       if(prefixlen == 0) {</div><div id="1069" class="line none"> 1069         /* Ignore option targets with a prefix length of 0. */</div><div id="1070" class="line none"> 1070         break;</div><div id="1071" class="line none"> 1071       }</div><div id="1072" class="line none"> 1072       if(prefixlen &gt; 128) {</div><div id="1073" class="line none"> 1073         <a href="../../../sys/log.h.html#198">LOG_ERR</a>("Too large target prefix length %d\n", prefixlen);</div><div id="1074" class="line none"> 1074         return;</div><div id="1075" class="line none"> 1075       }</div><div id="1076" class="line none"> 1076       if(0) {</div><div id="1077" class="line none"> 1077         <a href="../../../sys/log.h.html#198">LOG_ERR</a>("Incomplete DAO target option with prefix length of %d bits\n",</div><div id="1078" class="line none"> 1078                 prefixlen);</div><div id="1079" class="line none"> 1079         return;</div><div id="1080" class="line none"> 1080       }</div><div id="1081" class="line none"> 1081 </div><div id="1082" class="line none"> 1082       memset(&amp;<a href="rpl.h.html#129">prefix</a>, 0, sizeof(<a href="rpl.h.html#129">prefix</a>));</div><div id="1083" class="line none"> 1083       memcpy(&amp;<a href="rpl.h.html#129">prefix</a>, buffer + i + 4, (prefixlen + 7) / CHAR_BIT);</div><div id="1084" class="line none"> 1084       break;</div><div id="1085" class="line none"> 1085     case <a href="rpl-private.h.html#87">RPL_OPTION_TRANSIT</a>:</div><div id="1086" class="line none"> 1086       /* The path sequence and control are ignored. */</div><div id="1087" class="line none"> 1087       if(0) {</div><div id="1088" class="line none"> 1088         <a href="../../../sys/log.h.html#199">LOG_WARN</a>("Incomplete DAO transit option (%d &gt; %"PRIu16")\n",</div><div id="1089" class="line none"> 1089                  i + 6 + 16, buffer_length);</div><div id="1090" class="line none"> 1090         return;</div><div id="1091" class="line none"> 1091       }</div><div id="1092" class="line none"> 1092       <a href="../../ipv6/uip-ds6-route.h.html#156">lifetime</a> = buffer[i + 5];</div><div id="1093" class="line none"> 1093       if(<a href="../../ipv6/uip.h.html#1268">len</a> &gt;= 20) {</div><div id="1094" class="line none"> 1094         memcpy(&amp;dao_parent_addr, buffer + i + 6, 16);</div><div id="1095" class="line none"> 1095       }</div><div id="1096" class="line none"> 1096       break;</div><div id="1097" class="line none"> 1097     }</div><div id="1098" class="line none"> 1098   }</div><div id="1099" class="line none"> 1099 </div><div id="1100" class="line none"> 1100   <a href="../../../sys/log.h.html#200">LOG_INFO</a>("DAO lifetime: %u, prefix length: %u prefix: ",</div><div id="1101" class="line none"> 1101            (unsigned)<a href="../../ipv6/uip-ds6-route.h.html#156">lifetime</a>, (unsigned)prefixlen);</div><div id="1102" class="line none"> 1102   <a href="../../../sys/log.h.html#218">LOG_INFO_6ADDR</a>(&amp;<a href="rpl.h.html#129">prefix</a>);</div><div id="1103" class="line none"> 1103   <a href="../../../sys/log.h.html#206">LOG_INFO_</a>(", parent: ");</div><div id="1104" class="line none"> 1104   <a href="../../../sys/log.h.html#218">LOG_INFO_6ADDR</a>(&amp;dao_parent_addr);</div><div id="1105" class="line none"> 1105   <a href="../../../sys/log.h.html#206">LOG_INFO_</a>("\n");</div><div id="1106" class="line none"> 1106 </div><div id="1107" class="line none"> 1107   if(<a href="../../ipv6/uip-ds6-route.h.html#156">lifetime</a> == <a href="rpl-private.h.html#145">RPL_ZERO_LIFETIME</a>) {</div><div id="1108" class="line none"> 1108     <a href="../../../sys/log.h.html#201">LOG_DBG</a>("No-Path DAO received\n");</div><div id="1109" class="line none"> 1109     uip_sr_expire_parent(<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>, &amp;<a href="rpl.h.html#129">prefix</a>, &amp;dao_parent_addr);</div><div id="1110" class="line none"> 1110   } else {</div><div id="1111" class="line none"> 1111     if(uip_sr_update_node(<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>, &amp;<a href="rpl.h.html#129">prefix</a>, &amp;dao_parent_addr,</div><div id="1112" class="line none"> 1112                           <a href="rpl-private.h.html#152">RPL_LIFETIME</a>(<a href="../../ipv6/uip.h.html#1631">instance</a>, <a href="../../ipv6/uip-ds6-route.h.html#156">lifetime</a>)) == NULL) {</div><div id="1113" class="line none"> 1113       <a href="../../../sys/log.h.html#199">LOG_WARN</a>("DAO failed to add link prefix: ");</div><div id="1114" class="line none"> 1114       <a href="../../../sys/log.h.html#217">LOG_WARN_6ADDR</a>(&amp;<a href="rpl.h.html#129">prefix</a>);</div><div id="1115" class="line none"> 1115       <a href="../../../sys/log.h.html#205">LOG_WARN_</a>(", parent: ");</div><div id="1116" class="line none"> 1116       <a href="../../../sys/log.h.html#217">LOG_WARN_6ADDR</a>(&amp;dao_parent_addr);</div><div id="1117" class="line none"> 1117       <a href="../../../sys/log.h.html#205">LOG_WARN_</a>("\n");</div><div id="1118" class="line none"> 1118       return;</div><div id="1119" class="line none"> 1119     }</div><div id="1120" class="line none"> 1120   }</div><div id="1121" class="line none"> 1121 </div><div id="1122" class="line none"> 1122   if(<a href="../../ipv6/uip.h.html#1630">flags</a> &amp; <a href="rpl-private.h.html#92">RPL_DAO_K_FLAG</a>) {</div><div id="1123" class="line none"> 1123     <a href="../../../sys/log.h.html#201">LOG_DBG</a>("Sending DAO ACK\n");</div><div id="1124" class="line none"> 1124     <a href="../../ipv6/uipbuf.h.html#42">uipbuf_clear</a>();</div><div id="1125" class="line none"> 1125     <a href="rpl-icmp6.c.html#1488">dao_ack_output</a>(<a href="../../ipv6/uip.h.html#1631">instance</a>, &amp;dao_sender_addr, sequence,</div><div id="1126" class="line none"> 1126                    <a href="rpl-private.h.html#95">RPL_DAO_ACK_UNCONDITIONAL_ACCEPT</a>);</div><div id="1127" class="line none"> 1127   }</div><div id="1128" class="line none"> 1128 #endif /* RPL_WITH_NON_STORING */</div><div id="1129" class="line none"> 1129 }</div><div id="1130" class="line none"> 1130 /*---------------------------------------------------------------------------*/</div><div id="1131" class="line none"> 1131 static void</div><div id="1132" class="line none"> 1132 <a href="rpl-icmp6.c.html#1132">dao_input</a>(void)</div><div id="1133" class="line none"> 1133 {</div><div id="1134" class="line none"> 1134   <a href="rpl.h.html#154">rpl_instance_t</a> *<a href="../../ipv6/uip.h.html#1631">instance</a>;</div><div id="1135" class="line none"> 1135   uint8_t <a href="rpl-private.h.html#236">instance_id</a>;</div><div id="1136" class="line none"> 1136 </div><div id="1137" class="line none"> 1137   /* Destination Advertisement Object */</div><div id="1138" class="line none"> 1138   <a href="../../../sys/log.h.html#200">LOG_INFO</a>("Received a DAO from ");</div><div id="1139" class="line none"> 1139   <a href="../../../sys/log.h.html#218">LOG_INFO_6ADDR</a>(&amp;<a href="../../ipv6/uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="../../ipv6/uip.h.html#1537">srcipaddr</a>);</div><div id="1140" class="line none"> 1140   <a href="../../../sys/log.h.html#206">LOG_INFO_</a>("\n");</div><div id="1141" class="line none"> 1141 </div><div id="1142" class="line none"> 1142   if(<a href="../../ipv6/uip.h.html#1232">uip_len</a> &lt;= <a href="../../ipv6/uip.h.html#66">uip_l3_icmp_hdr_len</a>) {</div><div id="1143" class="line none"> 1143     <a href="../../../sys/log.h.html#199">LOG_WARN</a>("Ignoring DAO ICMPv6 message without DAO header\n");</div><div id="1144" class="line none"> 1144     goto discard;</div><div id="1145" class="line none"> 1145   }</div><div id="1146" class="line none"> 1146 </div><div id="1147" class="line none"> 1147   <a href="rpl-private.h.html#236">instance_id</a> = <a href="../../ipv6/uip.h.html#78">UIP_ICMP_PAYLOAD</a>[0];</div><div id="1148" class="line none"> 1148   <a href="../../ipv6/uip.h.html#1631">instance</a> = <a href="rpl.h.html#279">rpl_get_instance</a>(<a href="rpl-private.h.html#236">instance_id</a>);</div><div id="1149" class="line none"> 1149   if(<a href="../../ipv6/uip.h.html#1631">instance</a> == NULL) {</div><div id="1150" class="line none"> 1150     <a href="../../../sys/log.h.html#200">LOG_INFO</a>("Ignoring a DAO for an unknown RPL instance(%u)\n",</div><div id="1151" class="line none"> 1151              <a href="rpl-private.h.html#236">instance_id</a>);</div><div id="1152" class="line none"> 1152     goto discard;</div><div id="1153" class="line none"> 1153   }</div><div id="1154" class="line none"> 1154 </div><div id="1155" class="line none"> 1155   if(RPL_IS_STORING(<a href="../../ipv6/uip.h.html#1631">instance</a>)) {</div><div id="1156" class="line none"> 1156     <a href="rpl-icmp6.c.html#663">dao_input_storing</a>();</div><div id="1157" class="line none"> 1157   } else if(RPL_IS_NON_STORING(<a href="../../ipv6/uip.h.html#1631">instance</a>)) {</div><div id="1158" class="line none"> 1158     <a href="rpl-icmp6.c.html#981">dao_input_nonstoring</a>();</div><div id="1159" class="line none"> 1159   }</div><div id="1160" class="line none"> 1160 </div><div id="1161" class="line none"> 1161 discard:</div><div id="1162" class="line none"> 1162   <a href="../../ipv6/uipbuf.h.html#42">uipbuf_clear</a>();</div><div id="1163" class="line none"> 1163 }</div><div id="1164" class="line none"> 1164 /*---------------------------------------------------------------------------*/</div><div id="1165" class="line none"> 1165 #if RPL_WITH_DAO_ACK</div><div id="1166" class="line none"> 1166 static void</div><div id="1167" class="line none"> 1167 <a href="rpl-icmp6.c.html#1167">handle_dao_retransmission</a>(void *<a href="../../../sys/ctimer.h.html#68">ptr</a>)</div><div id="1168" class="line none"> 1168 {</div><div id="1169" class="line none"> 1169   <a href="rpl.h.html#125">rpl_parent_t</a> *parent;</div><div id="1170" class="line none"> 1170   <a href="../../ipv6/uip.h.html#105">uip_ipaddr_t</a> <a href="rpl.h.html#129">prefix</a>;</div><div id="1171" class="line none"> 1171   <a href="rpl.h.html#154">rpl_instance_t</a> *<a href="../../ipv6/uip.h.html#1631">instance</a>;</div><div id="1172" class="line none"> 1172 </div><div id="1173" class="line none"> 1173   parent = <a href="../../../sys/ctimer.h.html#68">ptr</a>;</div><div id="1174" class="line none"> 1174   if(parent == NULL || parent-&gt;<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a> == NULL || parent-&gt;<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="../../ipv6/uip.h.html#1631">instance</a> == NULL) {</div><div id="1175" class="line none"> 1175     return;</div><div id="1176" class="line none"> 1176   }</div><div id="1177" class="line none"> 1177   <a href="../../ipv6/uip.h.html#1631">instance</a> = parent-&gt;<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="../../ipv6/uip.h.html#1631">instance</a>;</div><div id="1178" class="line none"> 1178 </div><div id="1179" class="line none"> 1179   if(<a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl.h.html#243">my_dao_transmissions</a> &gt;= <a href="rpl-private.h.html#133">RPL_DAO_MAX_RETRANSMISSIONS</a>) {</div><div id="1180" class="line none"> 1180     /* No more retransmissions - give up. */</div><div id="1181" class="line none"> 1181     if(<a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl-private.h.html#242">lifetime_unit</a> == 0xffff &amp;&amp; <a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl-private.h.html#241">default_lifetime</a> == 0xff) {</div><div id="1182" class="line none"> 1182       /*</div><div id="1183" class="line none"> 1183        * ContikiRPL was previously using infinite lifetime for routes</div><div id="1184" class="line none"> 1184        * and no DAO_ACK configured. This probably means that the root</div><div id="1185" class="line none"> 1185        * and possibly other nodes might be running an old version that</div><div id="1186" class="line none"> 1186        * does not support DAO ACKs. Assume that everything is ok for</div><div id="1187" class="line none"> 1187        * now and let the normal repair mechanisms detect any problems.</div><div id="1188" class="line none"> 1188        */</div><div id="1189" class="line none"> 1189       return;</div><div id="1190" class="line none"> 1190     }</div><div id="1191" class="line none"> 1191 </div><div id="1192" class="line none"> 1192     if(RPL_IS_STORING(<a href="../../ipv6/uip.h.html#1631">instance</a>) &amp;&amp; <a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl.h.html#225">of</a>-&gt;<a href="rpl.h.html#207">dao_ack_callback</a>) {</div><div id="1193" class="line none"> 1193       /* Inform the objective function about the timeout. */</div><div id="1194" class="line none"> 1194       <a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl.h.html#225">of</a>-&gt;<a href="rpl.h.html#207">dao_ack_callback</a>(parent, <a href="rpl-private.h.html#100">RPL_DAO_ACK_TIMEOUT</a>);</div><div id="1195" class="line none"> 1195     }</div><div id="1196" class="line none"> 1196 </div><div id="1197" class="line none"> 1197     /* Perform a local repair and hope to find another parent. */</div><div id="1198" class="line none"> 1198     rpl_local_repair(<a href="../../ipv6/uip.h.html#1631">instance</a>);</div><div id="1199" class="line none"> 1199     return;</div><div id="1200" class="line none"> 1200   }</div><div id="1201" class="line none"> 1201 </div><div id="1202" class="line none"> 1202   <a href="../../../sys/log.h.html#200">LOG_INFO</a>("will retransmit DAO - seq:%d trans:%d\n", <a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl.h.html#242">my_dao_seqno</a>,</div><div id="1203" class="line none"> 1203            <a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl.h.html#243">my_dao_transmissions</a>);</div><div id="1204" class="line none"> 1204 </div><div id="1205" class="line none"> 1205   if(<a href="rpl-icmp6.c.html#134">get_global_addr</a>(&amp;<a href="rpl.h.html#129">prefix</a>) == 0) {</div><div id="1206" class="line none"> 1206     return;</div><div id="1207" class="line none"> 1207   }</div><div id="1208" class="line none"> 1208 </div><div id="1209" class="line none"> 1209   <a href="../../../sys/ctimer.h.html#137">ctimer_set</a>(&amp;<a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl.h.html#266">dao_retransmit_timer</a>,</div><div id="1210" class="line none"> 1210              <a href="rpl-private.h.html#139">RPL_DAO_RETRANSMISSION_TIMEOUT</a> / 2 +</div><div id="1211" class="line none"> 1211              (random_rand() % (<a href="rpl-private.h.html#139">RPL_DAO_RETRANSMISSION_TIMEOUT</a> / 2)),</div><div id="1212" class="line none"> 1212              <a href="rpl-icmp6.c.html#1167">handle_dao_retransmission</a>, parent);</div><div id="1213" class="line none"> 1213 </div><div id="1214" class="line none"> 1214   <a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl.h.html#243">my_dao_transmissions</a>++;</div><div id="1215" class="line none"> 1215   <a href="rpl-icmp6.c.html#1271">dao_output_target_seq</a>(parent, &amp;<a href="rpl.h.html#129">prefix</a>,</div><div id="1216" class="line none"> 1216                         <a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl-private.h.html#241">default_lifetime</a>, <a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl.h.html#242">my_dao_seqno</a>);</div><div id="1217" class="line none"> 1217 }</div><div id="1218" class="line none"> 1218 #endif /* RPL_WITH_DAO_ACK */</div><div id="1219" class="line none"> 1219 /*---------------------------------------------------------------------------*/</div><div id="1220" class="line none"> 1220 void</div><div id="1221" class="line none"> 1221 <a href="rpl-icmp6.c.html#1221">dao_output</a>(<a href="rpl.h.html#125">rpl_parent_t</a> *parent, uint8_t <a href="../../ipv6/uip-ds6-route.h.html#156">lifetime</a>)</div><div id="1222" class="line none"> 1222 {</div><div id="1223" class="line none"> 1223   /* Destination Advertisement Object */</div><div id="1224" class="line none"> 1224   <a href="../../ipv6/uip.h.html#105">uip_ipaddr_t</a> <a href="rpl.h.html#129">prefix</a>;</div><div id="1225" class="line none"> 1225 </div><div id="1226" class="line none"> 1226   if(<a href="rpl-icmp6.c.html#134">get_global_addr</a>(&amp;<a href="rpl.h.html#129">prefix</a>) == 0) {</div><div id="1227" class="line none"> 1227     <a href="../../../sys/log.h.html#198">LOG_ERR</a>("No global address set for this node - suppressing DAO\n");</div><div id="1228" class="line none"> 1228     return;</div><div id="1229" class="line none"> 1229   }</div><div id="1230" class="line none"> 1230 </div><div id="1231" class="line none"> 1231   if(parent == NULL || parent-&gt;<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a> == NULL || parent-&gt;<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="../../ipv6/uip.h.html#1631">instance</a> == NULL) {</div><div id="1232" class="line none"> 1232     return;</div><div id="1233" class="line none"> 1233   }</div><div id="1234" class="line none"> 1234 </div><div id="1235" class="line none"> 1235   <a href="rpl-private.h.html#215">RPL_LOLLIPOP_INCREMENT</a>(<a href="rpl-icmp6.c.html#88">dao_sequence</a>);</div><div id="1236" class="line none"> 1236 #if RPL_WITH_DAO_ACK</div><div id="1237" class="line none"> 1237   /*</div><div id="1238" class="line none"> 1238    * Set up the state since this will be the first transmission of</div><div id="1239" class="line none"> 1239    * DAO. Retransmissions will call directly to dao_output_target_seq.</div><div id="1240" class="line none"> 1240    * Also keep track of my own sending of DAO for handling ack and</div><div id="1241" class="line none"> 1241    * loss of ack.</div><div id="1242" class="line none"> 1242    */</div><div id="1243" class="line none"> 1243   if(<a href="../../ipv6/uip-ds6-route.h.html#156">lifetime</a> != <a href="rpl-private.h.html#145">RPL_ZERO_LIFETIME</a>) {</div><div id="1244" class="line none"> 1244     <a href="rpl.h.html#154">rpl_instance_t</a> *<a href="../../ipv6/uip.h.html#1631">instance</a>;</div><div id="1245" class="line none"> 1245     <a href="../../ipv6/uip.h.html#1631">instance</a> = parent-&gt;<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="../../ipv6/uip.h.html#1631">instance</a>;</div><div id="1246" class="line none"> 1246 </div><div id="1247" class="line none"> 1247     <a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl.h.html#242">my_dao_seqno</a> = <a href="rpl-icmp6.c.html#88">dao_sequence</a>;</div><div id="1248" class="line none"> 1248     <a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl.h.html#243">my_dao_transmissions</a> = 1;</div><div id="1249" class="line none"> 1249     <a href="../../../sys/ctimer.h.html#137">ctimer_set</a>(&amp;<a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl.h.html#266">dao_retransmit_timer</a>, <a href="rpl-private.h.html#139">RPL_DAO_RETRANSMISSION_TIMEOUT</a>,</div><div id="1250" class="line none"> 1250                <a href="rpl-icmp6.c.html#1167">handle_dao_retransmission</a>, parent);</div><div id="1251" class="line none"> 1251   }</div><div id="1252" class="line none"> 1252 #else</div><div id="1253" class="line none"> 1253   /*</div><div id="1254" class="line none"> 1254    * We know that we have tried to register, so now we are assuming</div><div id="1255" class="line none"> 1255    * that we have a down-link -- unless this is a zero lifetime one.</div><div id="1256" class="line none"> 1256    */</div><div id="1257" class="line none"> 1257   parent-&gt;<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl.h.html#245">has_downward_route</a> = <a href="../../ipv6/uip-ds6-route.h.html#156">lifetime</a> != <a href="rpl-private.h.html#145">RPL_ZERO_LIFETIME</a>;</div><div id="1258" class="line none"> 1258 #endif /* RPL_WITH_DAO_ACK */</div><div id="1259" class="line none"> 1259 </div><div id="1260" class="line none"> 1260   /* Sending a DAO with own prefix as target. */</div><div id="1261" class="line none"> 1261   <a href="rpl-icmp6.c.html#1265">dao_output_target</a>(parent, &amp;<a href="rpl.h.html#129">prefix</a>, <a href="../../ipv6/uip-ds6-route.h.html#156">lifetime</a>);</div><div id="1262" class="line none"> 1262 }</div><div id="1263" class="line none"> 1263 /*---------------------------------------------------------------------------*/</div><div id="1264" class="line none"> 1264 void</div><div id="1265" class="line none"> 1265 <a href="rpl-icmp6.c.html#1265">dao_output_target</a>(<a href="rpl.h.html#125">rpl_parent_t</a> *parent, <a href="../../ipv6/uip.h.html#105">uip_ipaddr_t</a> *<a href="rpl.h.html#129">prefix</a>, uint8_t <a href="../../ipv6/uip-ds6-route.h.html#156">lifetime</a>)</div><div id="1266" class="line none"> 1266 {</div><div id="1267" class="line none"> 1267   <a href="rpl-icmp6.c.html#1271">dao_output_target_seq</a>(parent, <a href="rpl.h.html#129">prefix</a>, <a href="../../ipv6/uip-ds6-route.h.html#156">lifetime</a>, <a href="rpl-icmp6.c.html#88">dao_sequence</a>);</div><div id="1268" class="line none"> 1268 }</div><div id="1269" class="line none"> 1269 /*---------------------------------------------------------------------------*/</div><div id="1270" class="line none"> 1270 static void</div><div id="1271" class="line none"> 1271 <a href="rpl-icmp6.c.html#1271">dao_output_target_seq</a>(<a href="rpl.h.html#125">rpl_parent_t</a> *parent, <a href="../../ipv6/uip.h.html#105">uip_ipaddr_t</a> *<a href="rpl.h.html#129">prefix</a>,</div><div id="1272" class="line none"> 1272                       uint8_t <a href="../../ipv6/uip-ds6-route.h.html#156">lifetime</a>, uint8_t seq_no)</div><div id="1273" class="line none"> 1273 {</div><div id="1274" class="line none"> 1274   <a href="rpl.h.html#153">rpl_dag_t</a> *<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>;</div><div id="1275" class="line none"> 1275   <a href="rpl.h.html#154">rpl_instance_t</a> *<a href="../../ipv6/uip.h.html#1631">instance</a>;</div><div id="1276" class="line none"> 1276   unsigned char *buffer;</div><div id="1277" class="line none"> 1277   uint8_t prefixlen;</div><div id="1278" class="line none"> 1278   int pos;</div><div id="1279" class="line none"> 1279   <a href="../../ipv6/uip.h.html#105">uip_ipaddr_t</a> *parent_ipaddr = NULL;</div><div id="1280" class="line none"> 1280   <a href="../../ipv6/uip.h.html#105">uip_ipaddr_t</a> *dest_ipaddr = NULL;</div><div id="1281" class="line none"> 1281 </div><div id="1282" class="line none"> 1282   /* Destination Advertisement Object */</div><div id="1283" class="line none"> 1283 </div><div id="1284" class="line none"> 1284   /* If we are in feather mode, we should not send any DAOs. */</div><div id="1285" class="line none"> 1285   if(<a href="rpl.h.html#331">rpl_get_mode</a>() == <a href="rpl.h.html#314">RPL_MODE_FEATHER</a>) {</div><div id="1286" class="line none"> 1286     return;</div><div id="1287" class="line none"> 1287   }</div><div id="1288" class="line none"> 1288 </div><div id="1289" class="line none"> 1289   if(parent == NULL) {</div><div id="1290" class="line none"> 1290     <a href="../../../sys/log.h.html#198">LOG_ERR</a>("dao_output_target error parent NULL\n");</div><div id="1291" class="line none"> 1291     return;</div><div id="1292" class="line none"> 1292   }</div><div id="1293" class="line none"> 1293 </div><div id="1294" class="line none"> 1294   parent_ipaddr = <a href="rpl.h.html#290">rpl_parent_get_ipaddr</a>(parent);</div><div id="1295" class="line none"> 1295   if(parent_ipaddr == NULL) {</div><div id="1296" class="line none"> 1296     <a href="../../../sys/log.h.html#198">LOG_ERR</a>("dao_output_target error parent IP address NULL\n");</div><div id="1297" class="line none"> 1297     return;</div><div id="1298" class="line none"> 1298   }</div><div id="1299" class="line none"> 1299 </div><div id="1300" class="line none"> 1300   <a href="../../ipv6/uip-ds6-route.h.html#157">dag</a> = parent-&gt;<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>;</div><div id="1301" class="line none"> 1301   if(<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a> == NULL) {</div><div id="1302" class="line none"> 1302     <a href="../../../sys/log.h.html#198">LOG_ERR</a>("dao_output_target error dag NULL\n");</div><div id="1303" class="line none"> 1303     return;</div><div id="1304" class="line none"> 1304   }</div><div id="1305" class="line none"> 1305 </div><div id="1306" class="line none"> 1306   <a href="../../ipv6/uip.h.html#1631">instance</a> = <a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="../../ipv6/uip.h.html#1631">instance</a>;</div><div id="1307" class="line none"> 1307 </div><div id="1308" class="line none"> 1308   if(<a href="../../ipv6/uip.h.html#1631">instance</a> == NULL) {</div><div id="1309" class="line none"> 1309     <a href="../../../sys/log.h.html#198">LOG_ERR</a>("dao_output_target error instance NULL\n");</div><div id="1310" class="line none"> 1310     return;</div><div id="1311" class="line none"> 1311   }</div><div id="1312" class="line none"> 1312   if(<a href="rpl.h.html#129">prefix</a> == NULL) {</div><div id="1313" class="line none"> 1313     <a href="../../../sys/log.h.html#198">LOG_ERR</a>("dao_output_target error prefix NULL\n");</div><div id="1314" class="line none"> 1314     return;</div><div id="1315" class="line none"> 1315   }</div><div id="1316" class="line none"> 1316 #ifdef RPL_DEBUG_DAO_OUTPUT</div><div id="1317" class="line none"> 1317   RPL_DEBUG_DAO_OUTPUT(parent);</div><div id="1318" class="line none"> 1318 #endif</div><div id="1319" class="line none"> 1319 </div><div id="1320" class="line none"> 1320   buffer = <a href="../../ipv6/uip.h.html#78">UIP_ICMP_PAYLOAD</a>;</div><div id="1321" class="line none"> 1321   pos = 0;</div><div id="1322" class="line none"> 1322 </div><div id="1323" class="line none"> 1323   buffer[pos++] = <a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl-private.h.html#236">instance_id</a>;</div><div id="1324" class="line none"> 1324   buffer[pos] = 0;</div><div id="1325" class="line none"> 1325 #if RPL_DAO_SPECIFY_DAG</div><div id="1326" class="line none"> 1326   buffer[pos] |= <a href="rpl-private.h.html#93">RPL_DAO_D_FLAG</a>;</div><div id="1327" class="line none"> 1327 #endif /* RPL_DAO_SPECIFY_DAG */</div><div id="1328" class="line none"> 1328 #if RPL_WITH_DAO_ACK</div><div id="1329" class="line none"> 1329   if(<a href="../../ipv6/uip-ds6-route.h.html#156">lifetime</a> != <a href="rpl-private.h.html#145">RPL_ZERO_LIFETIME</a>) {</div><div id="1330" class="line none"> 1330     buffer[pos] |= <a href="rpl-private.h.html#92">RPL_DAO_K_FLAG</a>;</div><div id="1331" class="line none"> 1331   }</div><div id="1332" class="line none"> 1332 #endif /* RPL_WITH_DAO_ACK */</div><div id="1333" class="line none"> 1333   ++pos;</div><div id="1334" class="line none"> 1334   buffer[pos++] = 0; /* reserved */</div><div id="1335" class="line none"> 1335   buffer[pos++] = seq_no;</div><div id="1336" class="line none"> 1336 #if RPL_DAO_SPECIFY_DAG</div><div id="1337" class="line none"> 1337   memcpy(buffer + pos, &amp;<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="rpl-private.h.html#229">dag_id</a>, sizeof(<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="rpl-private.h.html#229">dag_id</a>));</div><div id="1338" class="line none"> 1338   pos += sizeof(<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="rpl-private.h.html#229">dag_id</a>);</div><div id="1339" class="line none"> 1339 #endif /* RPL_DAO_SPECIFY_DAG */</div><div id="1340" class="line none"> 1340 </div><div id="1341" class="line none"> 1341   /* Create a target suboption. */</div><div id="1342" class="line none"> 1342   prefixlen = sizeof(*<a href="rpl.h.html#129">prefix</a>) * CHAR_BIT;</div><div id="1343" class="line none"> 1343   buffer[pos++] = <a href="rpl-private.h.html#86">RPL_OPTION_TARGET</a>;</div><div id="1344" class="line none"> 1344   buffer[pos++] = 2 + ((prefixlen + 7) / CHAR_BIT);</div><div id="1345" class="line none"> 1345   buffer[pos++] = 0; /* reserved */</div><div id="1346" class="line none"> 1346   buffer[pos++] = prefixlen;</div><div id="1347" class="line none"> 1347   memcpy(buffer + pos, <a href="rpl.h.html#129">prefix</a>, (prefixlen + 7) / CHAR_BIT);</div><div id="1348" class="line none"> 1348   pos += ((prefixlen + 7) / CHAR_BIT);</div><div id="1349" class="line none"> 1349 </div><div id="1350" class="line none"> 1350   /* Create a transit information sub-option. */</div><div id="1351" class="line none"> 1351   buffer[pos++] = <a href="rpl-private.h.html#87">RPL_OPTION_TRANSIT</a>;</div><div id="1352" class="line none"> 1352   buffer[pos++] = (<a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl-private.h.html#233">mop</a> != RPL_MOP_NON_STORING) ? 4 : 20;</div><div id="1353" class="line none"> 1353   buffer[pos++] = 0; /* flags - ignored */</div><div id="1354" class="line none"> 1354   buffer[pos++] = 0; /* path control - ignored */</div><div id="1355" class="line none"> 1355   buffer[pos++] = 0; /* path seq - ignored */</div><div id="1356" class="line none"> 1356   buffer[pos++] = <a href="../../ipv6/uip-ds6-route.h.html#156">lifetime</a>;</div><div id="1357" class="line none"> 1357 </div><div id="1358" class="line none"> 1358   if(<a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl-private.h.html#233">mop</a> != RPL_MOP_NON_STORING) {</div><div id="1359" class="line none"> 1359     /* Send DAO to the parent. */</div><div id="1360" class="line none"> 1360     dest_ipaddr = parent_ipaddr;</div><div id="1361" class="line none"> 1361   } else {</div><div id="1362" class="line none"> 1362     /* Include the parent's global IP address. */</div><div id="1363" class="line none"> 1363     memcpy(buffer + pos, &amp;parent-&gt;<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="rpl-private.h.html#229">dag_id</a>, 8); /* Prefix */</div><div id="1364" class="line none"> 1364     pos += 8;</div><div id="1365" class="line none"> 1365     /* Interface identifier. */</div><div id="1366" class="line none"> 1366     memcpy(buffer + pos, ((const unsigned char *)parent_ipaddr) + 8, 8);</div><div id="1367" class="line none"> 1367     pos += 8;</div><div id="1368" class="line none"> 1368     /* Send DAO to root */</div><div id="1369" class="line none"> 1369     dest_ipaddr = &amp;parent-&gt;<a href="../../ipv6/uip-ds6-route.h.html#157">dag</a>-&gt;<a href="rpl-private.h.html#229">dag_id</a>;</div><div id="1370" class="line none"> 1370   }</div><div id="1371" class="line none"> 1371 </div><div id="1372" class="line none"> 1372   <a href="../../../sys/log.h.html#200">LOG_INFO</a>("Sending a %sDAO with sequence number %u, lifetime %u, prefix ",</div><div id="1373" class="line none"> 1373            <a href="../../ipv6/uip-ds6-route.h.html#156">lifetime</a> == <a href="rpl-private.h.html#145">RPL_ZERO_LIFETIME</a> ? "No-Path " : "", seq_no, <a href="../../ipv6/uip-ds6-route.h.html#156">lifetime</a>);</div><div id="1374" class="line none"> 1374 </div><div id="1375" class="line none"> 1375   <a href="../../../sys/log.h.html#218">LOG_INFO_6ADDR</a>(<a href="rpl.h.html#129">prefix</a>);</div><div id="1376" class="line none"> 1376   <a href="../../../sys/log.h.html#206">LOG_INFO_</a>(" to ");</div><div id="1377" class="line none"> 1377   <a href="../../../sys/log.h.html#218">LOG_INFO_6ADDR</a>(dest_ipaddr);</div><div id="1378" class="line none"> 1378   <a href="../../../sys/log.h.html#206">LOG_INFO_</a>(" , parent ");</div><div id="1379" class="line none"> 1379   <a href="../../../sys/log.h.html#218">LOG_INFO_6ADDR</a>(parent_ipaddr);</div><div id="1380" class="line none"> 1380   <a href="../../../sys/log.h.html#206">LOG_INFO_</a>("\n");</div><div id="1381" class="line none"> 1381 </div><div id="1382" class="line none"> 1382   if(dest_ipaddr != NULL) {</div><div id="1383" class="line none"> 1383     <a href="../../ipv6/uip-icmp6.h.html#130">uip_icmp6_send</a>(dest_ipaddr, <a href="../../ipv6/uip-icmp6.h.html#66">ICMP6_RPL</a>, <a href="rpl-private.h.html#73">RPL_CODE_DAO</a>, pos);</div><div id="1384" class="line none"> 1384   }</div><div id="1385" class="line none"> 1385 }</div><div id="1386" class="line none"> 1386 /*---------------------------------------------------------------------------*/</div><div id="1387" class="line none"> 1387 static void</div><div id="1388" class="line none"> 1388 <a href="rpl-icmp6.c.html#1388">dao_ack_input</a>(void)</div><div id="1389" class="line none"> 1389 {</div><div id="1390" class="line none"> 1390 #if RPL_WITH_DAO_ACK</div><div id="1391" class="line none"> 1391 </div><div id="1392" class="line none"> 1392   uint8_t *buffer;</div><div id="1393" class="line none"> 1393   uint8_t <a href="rpl-private.h.html#236">instance_id</a>;</div><div id="1394" class="line none"> 1394   uint8_t sequence;</div><div id="1395" class="line none"> 1395   uint8_t status;</div><div id="1396" class="line none"> 1396   <a href="rpl.h.html#154">rpl_instance_t</a> *<a href="../../ipv6/uip.h.html#1631">instance</a>;</div><div id="1397" class="line none"> 1397   <a href="rpl.h.html#125">rpl_parent_t</a> *parent;</div><div id="1398" class="line none"> 1398 </div><div id="1399" class="line none"> 1399   buffer = <a href="../../ipv6/uip.h.html#78">UIP_ICMP_PAYLOAD</a>;</div><div id="1400" class="line none"> 1400 </div><div id="1401" class="line none"> 1401   <a href="rpl-private.h.html#236">instance_id</a> = buffer[0];</div><div id="1402" class="line none"> 1402   sequence = buffer[2];</div><div id="1403" class="line none"> 1403   status = buffer[3];</div><div id="1404" class="line none"> 1404 </div><div id="1405" class="line none"> 1405   <a href="../../ipv6/uip.h.html#1631">instance</a> = <a href="rpl.h.html#279">rpl_get_instance</a>(<a href="rpl-private.h.html#236">instance_id</a>);</div><div id="1406" class="line none"> 1406   if(<a href="../../ipv6/uip.h.html#1631">instance</a> == NULL) {</div><div id="1407" class="line none"> 1407     <a href="../../ipv6/uipbuf.h.html#42">uipbuf_clear</a>();</div><div id="1408" class="line none"> 1408     return;</div><div id="1409" class="line none"> 1409   }</div><div id="1410" class="line none"> 1410 </div><div id="1411" class="line none"> 1411   if(RPL_IS_STORING(<a href="../../ipv6/uip.h.html#1631">instance</a>)) {</div><div id="1412" class="line none"> 1412     parent = <a href="rpl-private.h.html#323">rpl_find_parent</a>(<a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl.h.html#226">current_dag</a>, &amp;<a href="../../ipv6/uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="../../ipv6/uip.h.html#1537">srcipaddr</a>);</div><div id="1413" class="line none"> 1413     if(parent == NULL) {</div><div id="1414" class="line none"> 1414       /* Unknown instance -- drop the packet and ignore. */</div><div id="1415" class="line none"> 1415       <a href="../../ipv6/uipbuf.h.html#42">uipbuf_clear</a>();</div><div id="1416" class="line none"> 1416       return;</div><div id="1417" class="line none"> 1417     }</div><div id="1418" class="line none"> 1418   } else {</div><div id="1419" class="line none"> 1419     parent = NULL;</div><div id="1420" class="line none"> 1420   }</div><div id="1421" class="line none"> 1421 </div><div id="1422" class="line none"> 1422   if(<a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl.h.html#226">current_dag</a>-&gt;<a href="rpl-private.h.html#231">rank</a> == <a href="rpl-private.h.html#191">ROOT_RANK</a>(<a href="../../ipv6/uip.h.html#1631">instance</a>)) {</div><div id="1423" class="line none"> 1423     <a href="../../../sys/log.h.html#201">LOG_DBG</a>("DODAG root received a DAO ACK, ignoring it\n");</div><div id="1424" class="line none"> 1424     <a href="../../ipv6/uipbuf.h.html#42">uipbuf_clear</a>();</div><div id="1425" class="line none"> 1425     return;</div><div id="1426" class="line none"> 1426   }</div><div id="1427" class="line none"> 1427 </div><div id="1428" class="line none"> 1428   <a href="../../../sys/log.h.html#200">LOG_INFO</a>("Received a DAO %s with sequence number %u (%u) and status %u from ",</div><div id="1429" class="line none"> 1429            status &lt; 128 ? "ACK" : "NACK",</div><div id="1430" class="line none"> 1430            sequence, <a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl.h.html#242">my_dao_seqno</a>, status);</div><div id="1431" class="line none"> 1431   <a href="../../../sys/log.h.html#218">LOG_INFO_6ADDR</a>(&amp;<a href="../../ipv6/uip.h.html#71">UIP_IP_BUF</a>-&gt;<a href="../../ipv6/uip.h.html#1537">srcipaddr</a>);</div><div id="1432" class="line none"> 1432   <a href="../../../sys/log.h.html#206">LOG_INFO_</a>("\n");</div><div id="1433" class="line none"> 1433 </div><div id="1434" class="line none"> 1434   if(sequence == <a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl.h.html#242">my_dao_seqno</a>) {</div><div id="1435" class="line none"> 1435     <a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl.h.html#245">has_downward_route</a> = status &lt; 128;</div><div id="1436" class="line none"> 1436 </div><div id="1437" class="line none"> 1437     /* Always stop the retransmit timer when the ACK arrived. */</div><div id="1438" class="line none"> 1438     ctimer_stop(&amp;<a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl.h.html#266">dao_retransmit_timer</a>);</div><div id="1439" class="line none"> 1439 </div><div id="1440" class="line none"> 1440     /* Inform the objective function on the status of the DAO ACK. */</div><div id="1441" class="line none"> 1441     if(RPL_IS_STORING(<a href="../../ipv6/uip.h.html#1631">instance</a>) &amp;&amp; <a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl.h.html#225">of</a>-&gt;<a href="rpl.h.html#207">dao_ack_callback</a>) {</div><div id="1442" class="line none"> 1442       <a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl.h.html#225">of</a>-&gt;<a href="rpl.h.html#207">dao_ack_callback</a>(parent, status);</div><div id="1443" class="line none"> 1443     }</div><div id="1444" class="line none"> 1444 </div><div id="1445" class="line none"> 1445 #if RPL_REPAIR_ON_DAO_NACK</div><div id="1446" class="line none"> 1446     if(status &gt;= <a href="rpl-private.h.html#97">RPL_DAO_ACK_UNABLE_TO_ACCEPT</a>) {</div><div id="1447" class="line none"> 1447       /*</div><div id="1448" class="line none"> 1448        * Failed the DAO transmission -- we need to remove the default route.</div><div id="1449" class="line none"> 1449        * Trigger a local repair since we can not get our DAO in.</div><div id="1450" class="line none"> 1450        */</div><div id="1451" class="line none"> 1451       rpl_local_repair(<a href="../../ipv6/uip.h.html#1631">instance</a>);</div><div id="1452" class="line none"> 1452     }</div><div id="1453" class="line none"> 1453 #endif</div><div id="1454" class="line none"> 1454   } else if(RPL_IS_STORING(<a href="../../ipv6/uip.h.html#1631">instance</a>)) {</div><div id="1455" class="line none"> 1455     /* This DAO ACK should be forwarded to another recently registered route. */</div><div id="1456" class="line none"> 1456     <a href="../../ipv6/uip-ds6-route.h.html#184">uip_ds6_route_t</a> *re;</div><div id="1457" class="line none"> 1457     const <a href="../../ipv6/uip.h.html#105">uip_ipaddr_t</a> *nexthop;</div><div id="1458" class="line none"> 1458     if((re = <a href="rpl-icmp6.c.html#103">find_route_entry_by_dao_ack</a>(sequence)) != NULL) {</div><div id="1459" class="line none"> 1459       /* Pick the recorded seq no from that node and forward the DAO ACK.</div><div id="1460" class="line none"> 1460          Also clear the pending flag. */</div><div id="1461" class="line none"> 1461       <a href="../../ipv6/uip-ds6-route.h.html#137">RPL_ROUTE_CLEAR_DAO_PENDING</a>(re);</div><div id="1462" class="line none"> 1462 </div><div id="1463" class="line none"> 1463       nexthop = <a href="../../ipv6/uip-ds6-route.h.html#222">uip_ds6_route_nexthop</a>(re);</div><div id="1464" class="line none"> 1464       if(nexthop == NULL) {</div><div id="1465" class="line none"> 1465         <a href="../../../sys/log.h.html#199">LOG_WARN</a>("No next hop to fwd DAO ACK to\n");</div><div id="1466" class="line none"> 1466       } else {</div><div id="1467" class="line none"> 1467         <a href="../../../sys/log.h.html#200">LOG_INFO</a>("Fwd DAO ACK to:");</div><div id="1468" class="line none"> 1468         <a href="../../../sys/log.h.html#218">LOG_INFO_6ADDR</a>(nexthop);</div><div id="1469" class="line none"> 1469         <a href="../../../sys/log.h.html#206">LOG_INFO_</a>("\n");</div><div id="1470" class="line none"> 1470         buffer[2] = re-&gt;<a href="../../ipv6/uip-ds6-nbr.h.html#112">state</a>.<a href="../../ipv6/uip-ds6-route.h.html#159">dao_seqno_in</a>;</div><div id="1471" class="line none"> 1471         <a href="../../ipv6/uip-icmp6.h.html#130">uip_icmp6_send</a>(nexthop, <a href="../../ipv6/uip-icmp6.h.html#66">ICMP6_RPL</a>, <a href="rpl-private.h.html#74">RPL_CODE_DAO_ACK</a>, 4);</div><div id="1472" class="line none"> 1472       }</div><div id="1473" class="line none"> 1473 </div><div id="1474" class="line none"> 1474       if(status &gt;= <a href="rpl-private.h.html#97">RPL_DAO_ACK_UNABLE_TO_ACCEPT</a>) {</div><div id="1475" class="line none"> 1475         /* This node did not get in to the routing tables above -- remove. */</div><div id="1476" class="line none"> 1476         uip_ds6_route_rm(re);</div><div id="1477" class="line none"> 1477       }</div><div id="1478" class="line none"> 1478     } else {</div><div id="1479" class="line none"> 1479       <a href="../../../sys/log.h.html#199">LOG_WARN</a>("No route entry found to forward DAO ACK (seqno %u)\n",</div><div id="1480" class="line none"> 1480                sequence);</div><div id="1481" class="line none"> 1481     }</div><div id="1482" class="line none"> 1482   }</div><div id="1483" class="line none"> 1483 #endif /* RPL_WITH_DAO_ACK */</div><div id="1484" class="line none"> 1484   <a href="../../ipv6/uipbuf.h.html#42">uipbuf_clear</a>();</div><div id="1485" class="line none"> 1485 }</div><div id="1486" class="line none"> 1486 /*---------------------------------------------------------------------------*/</div><div id="1487" class="line none"> 1487 void</div><div id="1488" class="line none"> 1488 <a href="rpl-icmp6.c.html#1488">dao_ack_output</a>(<a href="rpl.h.html#154">rpl_instance_t</a> *<a href="../../ipv6/uip.h.html#1631">instance</a>, <a href="../../ipv6/uip.h.html#105">uip_ipaddr_t</a> *<a href="../../ipv6/uip.h.html#1427">dest</a>, uint8_t sequence,</div><div id="1489" class="line none"> 1489                uint8_t status)</div><div id="1490" class="line none"> 1490 {</div><div id="1491" class="line none"> 1491 #if RPL_WITH_DAO_ACK</div><div id="1492" class="line none"> 1492   unsigned char *buffer;</div><div id="1493" class="line none"> 1493 </div><div id="1494" class="line none"> 1494   <a href="../../../sys/log.h.html#200">LOG_INFO</a>("Sending a DAO %s with sequence number %u to ",</div><div id="1495" class="line none"> 1495            status &lt; 128 ? "ACK" : "NACK", sequence);</div><div id="1496" class="line none"> 1496   <a href="../../../sys/log.h.html#218">LOG_INFO_6ADDR</a>(<a href="../../ipv6/uip.h.html#1427">dest</a>);</div><div id="1497" class="line none"> 1497   <a href="../../../sys/log.h.html#206">LOG_INFO_</a>(" with status %u\n", status);</div><div id="1498" class="line none"> 1498 </div><div id="1499" class="line none"> 1499   buffer = <a href="../../ipv6/uip.h.html#78">UIP_ICMP_PAYLOAD</a>;</div><div id="1500" class="line none"> 1500 </div><div id="1501" class="line none"> 1501   buffer[0] = <a href="../../ipv6/uip.h.html#1631">instance</a>-&gt;<a href="rpl-private.h.html#236">instance_id</a>;</div><div id="1502" class="line none"> 1502   buffer[1] = 0;</div><div id="1503" class="line none"> 1503   buffer[2] = sequence;</div><div id="1504" class="line none"> 1504   buffer[3] = status;</div><div id="1505" class="line none"> 1505 </div><div id="1506" class="line none"> 1506   <a href="../../ipv6/uip-icmp6.h.html#130">uip_icmp6_send</a>(<a href="../../ipv6/uip.h.html#1427">dest</a>, <a href="../../ipv6/uip-icmp6.h.html#66">ICMP6_RPL</a>, <a href="rpl-private.h.html#74">RPL_CODE_DAO_ACK</a>, 4);</div><div id="1507" class="line none"> 1507 #endif /* RPL_WITH_DAO_ACK */</div><div id="1508" class="line none"> 1508 }</div><div id="1509" class="line none"> 1509 /*---------------------------------------------------------------------------*/</div><div id="1510" class="line none"> 1510 void</div><div id="1511" class="line none"> 1511 <a href="rpl-icmp6.c.html#1511">rpl_icmp6_register_handlers</a>(void)</div><div id="1512" class="line none"> 1512 {</div><div id="1513" class="line none"> 1513   <a href="../../ipv6/uip-icmp6.h.html#231">uip_icmp6_register_input_handler</a>(&amp;<a href="rpl-icmp6.c.html#95">dis_handler</a>);</div><div id="1514" class="line none"> 1514   <a href="../../ipv6/uip-icmp6.h.html#231">uip_icmp6_register_input_handler</a>(&amp;<a href="rpl-icmp6.c.html#96">dio_handler</a>);</div><div id="1515" class="line none"> 1515   <a href="../../ipv6/uip-icmp6.h.html#231">uip_icmp6_register_input_handler</a>(&amp;<a href="rpl-icmp6.c.html#97">dao_handler</a>);</div><div id="1516" class="line none"> 1516   <a href="../../ipv6/uip-icmp6.h.html#231">uip_icmp6_register_input_handler</a>(&amp;<a href="rpl-icmp6.c.html#98">dao_ack_handler</a>);</div><div id="1517" class="line none"> 1517 }</div><div id="1518" class="line none"> 1518 /*---------------------------------------------------------------------------*/</div><div id="1519" class="line none"> 1519 </div><div id="1520" class="line none"> 1520 /** @}*/</div>
</div>
</body>
</html>
